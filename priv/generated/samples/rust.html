<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Autumn Sample - rust</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
    }
    body {
      background-color: #282C34;
    }
  </style>
</head>
<body>
  <pre class="autumn highlight" class="background" style="background-color: #282C34; ">
<code class="language-rust">
#![doc = include_str!(&quot;../README.md&quot;)]

<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">mod</span> c_lib<span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">mod</span> util<span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">use</span> c_lib <span class="keyword" style="color: #E06C75; ">as</span> c<span class="text" style="color: #ABB2BF; ">;</span>

<span class="keyword" style="color: #E06C75; ">use</span> lazy_static<span class="text" style="color: #ABB2BF; ">::</span>lazy_static<span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">use</span> std<span class="text" style="color: #ABB2BF; ">::</span>collections<span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HashSet</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">use</span> std<span class="text" style="color: #ABB2BF; ">::</span>sync<span class="text" style="color: #ABB2BF; ">::</span>atomic<span class="text" style="color: #ABB2BF; ">::</span><span class="text" style="color: #ABB2BF; ">{</span><span class="constructor" style="color: #61AFEF; ">AtomicUsize</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Ordering</span><span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">use</span> std<span class="text" style="color: #ABB2BF; ">::</span><span class="text" style="color: #ABB2BF; ">{</span>iter<span class="text" style="color: #ABB2BF; ">,</span> mem<span class="text" style="color: #ABB2BF; ">,</span> ops<span class="text" style="color: #ABB2BF; ">,</span> str<span class="text" style="color: #ABB2BF; ">,</span> usize<span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">use</span> thiserror<span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">Error</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">use</span> tree_sitter<span class="text" style="color: #ABB2BF; ">::</span><span class="text" style="color: #ABB2BF; ">{</span>
    <span class="constructor" style="color: #61AFEF; ">Language</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">LossyUtf8</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Node</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Parser</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Point</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Query</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">QueryCaptures</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">QueryCursor</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">QueryError</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="constructor" style="color: #61AFEF; ">QueryMatch</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Range</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Tree</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>

<span class="keyword" style="color: #E06C75; ">const</span> <span class="constructor" style="color: #61AFEF; ">CANCELLATION_CHECK_INTERVAL</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span> = <span class="constant builtin" style="color: #D19A66; ">100</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">const</span> <span class="constructor" style="color: #61AFEF; ">BUFFER_HTML_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span> = <span class="constant builtin" style="color: #D19A66; ">10</span> <span class="operator" style="color: #C678DD; ">*</span> <span class="constant builtin" style="color: #D19A66; ">1024</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="keyword" style="color: #E06C75; ">const</span> <span class="constructor" style="color: #61AFEF; ">BUFFER_LINES_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span> = <span class="constant builtin" style="color: #D19A66; ">1000</span><span class="text" style="color: #ABB2BF; ">;</span>

<span class="function macro" style="color: #C678DD; ">lazy_static</span><span class="function macro" style="color: #C678DD; ">!</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">static</span> ref <span class="constructor" style="color: #61AFEF; ">STANDARD_CAPTURE_NAMES</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">HashSet</span>&lt;<span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="keyword" style="color: #E06C75; ">static</span> <span class="type" style="color: #E5C07B; ">str</span>&gt; = vec!<span class="text" style="color: #ABB2BF; ">[</span>
        <span class="string" style="color: #98C379; ">&quot;attribute&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;boolean&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;carriage-return&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;comment&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;comment.documentation&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;constant&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;constant.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;constructor&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;constructor.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;embedded&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;error&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;escape&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;function&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;function.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;keyword&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.bold&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.heading&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.italic&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.link&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.link.url&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.list&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.list.checked&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.list.numbered&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.list.unchecked&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.list.unnumbered&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.quote&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.raw&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.raw.block&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.raw.inline&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;markup.strikethrough&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;module&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;number&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;operator&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;property&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;property.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;punctuation&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;punctuation.bracket&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;punctuation.delimiter&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;punctuation.special&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;string&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;string.escape&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;string.regexp&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;string.special&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;string.special.symbol&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;tag&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;type&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;type.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;variable&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;variable.builtin&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;variable.member&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="string" style="color: #98C379; ">&quot;variable.parameter&quot;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">]</span>
    <span class="text" style="color: #ABB2BF; ">.</span>into_iter<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">.</span>collect<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Indicates which highlight should be applied to a region of source code.</span>
<span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>derive<span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Copy</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Clone</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Debug</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">PartialEq</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Eq</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="keyword" style="color: #E06C75; ">pub</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Represents the reason why syntax highlighting failed.</span>
<span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>derive<span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Debug</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Error</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">PartialEq</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Eq</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">enum</span> <span class="type" style="color: #E5C07B; ">Error</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>error<span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&quot;Cancelled&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
    <span class="constructor" style="color: #61AFEF; ">Cancelled</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>error<span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&quot;Invalid language&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
    <span class="constructor" style="color: #61AFEF; ">InvalidLanguage</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>error<span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&quot;Unknown error&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
    <span class="constructor" style="color: #61AFEF; ">Unknown</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Represents a single step in rendering a syntax-highlighted document.</span>
<span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>derive<span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Copy</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Clone</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Debug</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">enum</span> <span class="type" style="color: #E5C07B; ">HighlightEvent</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="constructor" style="color: #61AFEF; ">Source</span> <span class="text" style="color: #ABB2BF; ">{</span> <span class="text" style="color: #ABB2BF; ">start</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="text" style="color: #ABB2BF; ">end</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span> <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="constructor" style="color: #61AFEF; ">HighlightStart</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="constructor" style="color: #61AFEF; ">HighlightEnd</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Contains the data needed to highlight code written in a particular language.</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">/// This struct is immutable and can be shared between threads.</span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">language</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Language</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">String</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Query</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">apply_all_captures</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">combined_injections_query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Query</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">locals_pattern_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">highlights_pattern_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">highlight_indices</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">non_local_variable_patterns</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">injection_content_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">injection_language_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">local_scope_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">local_def_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">local_def_value_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">local_ref_capture_index</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Performs syntax highlighting, recognizing a given list of highlight names.</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">/// For the best performance `Highlighter` values should be reused between</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">/// syntax highlighting calls. A separate highlighter is needed for each thread that</span>
<span class="comment" style="font-style: italic; color: #5C6370; ">/// is performing highlighting.</span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">Highlighter</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="text" style="color: #ABB2BF; ">parser</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Parser</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">cursors</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">QueryCursor</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="comment" style="font-style: italic; color: #5C6370; ">/// Converts a general-purpose syntax highlighting iterator into a sequence of lines of HTML.</span>
<span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">HtmlRenderer</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">carriage_return_highlight</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>derive<span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Debug</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
<span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">LocalDef</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="text" style="color: #ABB2BF; ">name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">value_range</span><span class="text" style="color: #ABB2BF; ">:</span> ops<span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">highlight</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="attribute" style="color: #E5C07B; ">#<span class="text" style="color: #ABB2BF; ">[</span>derive<span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Debug</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span></span>
<span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">LocalScope</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="text" style="color: #ABB2BF; ">inherits</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">range</span><span class="text" style="color: #ABB2BF; ">:</span> ops<span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">local_defs</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">LocalDef</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">HighlightIter</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span>
<span class="keyword" style="color: #E06C75; ">where</span>
    <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">FnMut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">{</span>
    <span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">byte_offset</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">highlighter</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">Highlighter</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">injection_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">cancellation_flag</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">AtomicUsize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">iter_count</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">next_event</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">last_highlight_range</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">apply_all_captures</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">struct</span> <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="text" style="color: #ABB2BF; ">_tree</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Tree</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">cursor</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">QueryCursor</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">:</span> iter<span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Peekable</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">QueryCaptures</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">LocalScope</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">ranges</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">depth</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">Highlighter</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Self</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="type" style="color: #E5C07B; ">Highlighter</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="text" style="color: #ABB2BF; ">parser</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Parser</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">cursors</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">parser</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">Parser</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Iterate over the highlighted regions for a given slice of source code.</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">highlight</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">config</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">source</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">cancellation_flag</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">AtomicUsize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable parameter" style="color: #E06C75; ">injection_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">FnMut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">Iterator</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Item</span> = <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> layers = <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>
            source<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span>
            cancellation_flag<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> injection_callback<span class="text" style="color: #ABB2BF; ">,</span>
            config<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="function macro" style="color: #C678DD; ">vec</span><span class="function macro" style="color: #C678DD; ">!</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constructor" style="color: #61AFEF; ">Range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                start_byte<span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span>
                end_byte<span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">,</span>
                start_point<span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">Point</span><span class="text" style="color: #ABB2BF; ">::</span>new<span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                end_point<span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">Point</span><span class="text" style="color: #ABB2BF; ">::</span>new<span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">)</span>?<span class="text" style="color: #ABB2BF; ">;</span>
        <span class="function macro" style="color: #C678DD; ">assert_ne</span><span class="function macro" style="color: #C678DD; ">!</span><span class="text" style="color: #ABB2BF; ">(</span>layers<span class="text" style="color: #ABB2BF; ">.</span>len<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> result = <span class="type" style="color: #E5C07B; ">HighlightIter</span> <span class="text" style="color: #ABB2BF; ">{</span>
            source<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span>config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">byte_offset</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span>
            injection_callback<span class="text" style="color: #ABB2BF; ">,</span>
            cancellation_flag<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">highlighter</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">iter_count</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span>
            layers<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">next_event</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">last_highlight_range</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">apply_all_captures</span><span class="text" style="color: #ABB2BF; ">:</span> config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">apply_all_captures</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
        result<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>result<span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Creates a `HighlightConfiguration` for a given `Language` and set of highlighting</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// queries.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// # Parameters</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// * `language`  - The Tree-sitter `Language` that should be used for parsing.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// * `highlights_query` - A string containing tree patterns for syntax highlighting. This</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///   should be non-empty, otherwise no syntax highlights will be added.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// * `injections_query` -  A string containing tree patterns for injecting other languages</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///   into the document. This can be empty if no injections are desired.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// * `locals_query` - A string containing tree patterns for tracking local variable</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///   definitions and references. This can be empty if local variable tracking is not needed.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Returns a `HighlightConfiguration` that can then be used with the `highlight` method.</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="variable parameter" style="color: #E06C75; ">language</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Language</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">Into</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">String</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">highlights_query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">injection_query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">locals_query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">apply_all_captures</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">QueryError</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="comment" style="font-style: italic; color: #5C6370; ">// Concatenate the query strings, keeping track of the start offset of each section.</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> query_source = <span class="type" style="color: #E5C07B; ">String</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        query_source<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push_str</span><span class="text" style="color: #ABB2BF; ">(</span>injection_query<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> locals_query_offset = query_source<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        query_source<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push_str</span><span class="text" style="color: #ABB2BF; ">(</span>locals_query<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> highlights_query_offset = query_source<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        query_source<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push_str</span><span class="text" style="color: #ABB2BF; ">(</span>highlights_query<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

        <span class="comment" style="font-style: italic; color: #5C6370; ">// Construct a single query by concatenating the three query strings, but record the</span>
        <span class="comment" style="font-style: italic; color: #5C6370; ">// range of pattern indices that belong to each individual string.</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> query = <span class="type" style="color: #E5C07B; ">Query</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>language<span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span>query_source<span class="text" style="color: #ABB2BF; ">)</span>?<span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> locals_pattern_index = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> highlights_pattern_index = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> i <span class="keyword" style="color: #E06C75; ">in</span> <span class="constant builtin" style="color: #D19A66; ">0</span>..<span class="text" style="color: #ABB2BF; ">(</span>query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pattern_count</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> pattern_offset = query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_byte_for_pattern</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">if</span> pattern_offset &lt; highlights_query_offset <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> pattern_offset &lt; highlights_query_offset <span class="text" style="color: #ABB2BF; ">{</span>
                    highlights_pattern_index += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="keyword" style="color: #E06C75; ">if</span> pattern_offset &lt; locals_query_offset <span class="text" style="color: #ABB2BF; ">{</span>
                    locals_pattern_index += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>

        <span class="comment" style="font-style: italic; color: #5C6370; ">// Construct a separate query just for dealing with the &#39;combined injections&#39;.</span>
        <span class="comment" style="font-style: italic; color: #5C6370; ">// Disable the combined injection patterns in the main query.</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> combined_injections_query = <span class="type" style="color: #E5C07B; ">Query</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>language<span class="text" style="color: #ABB2BF; ">,</span> injection_query<span class="text" style="color: #ABB2BF; ">)</span>?<span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> has_combined_queries = <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> pattern_index <span class="keyword" style="color: #E06C75; ">in</span> <span class="constant builtin" style="color: #D19A66; ">0</span>..locals_pattern_index <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> settings = query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">property_settings</span><span class="text" style="color: #ABB2BF; ">(</span>pattern_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">if</span> settings<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">any</span><span class="text" style="color: #ABB2BF; ">(</span>|s| <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">*</span>s<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">key</span> == <span class="string" style="color: #98C379; ">&quot;injection.combined&quot;</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                has_combined_queries = <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">;</span>
                query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">disable_pattern</span><span class="text" style="color: #ABB2BF; ">(</span>pattern_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                combined_injections_query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">disable_pattern</span><span class="text" style="color: #ABB2BF; ">(</span>pattern_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="keyword" style="color: #E06C75; ">let</span> combined_injections_query = <span class="keyword" style="color: #E06C75; ">if</span> has_combined_queries <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>combined_injections_query<span class="text" style="color: #ABB2BF; ">)</span>
        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="constructor" style="color: #61AFEF; ">None</span>
        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>

        <span class="comment" style="font-style: italic; color: #5C6370; ">// Find all of the highlighting patterns that are disabled for nodes that</span>
        <span class="comment" style="font-style: italic; color: #5C6370; ">// have been identified as local variables.</span>
        <span class="keyword" style="color: #E06C75; ">let</span> non_local_variable_patterns = <span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span>..query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pattern_count</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span>|i| <span class="text" style="color: #ABB2BF; ">{</span>
                query
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">property_predicates</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">any</span><span class="text" style="color: #ABB2BF; ">(</span>|<span class="text" style="color: #ABB2BF; ">(</span>prop<span class="text" style="color: #ABB2BF; ">,</span> positive<span class="text" style="color: #ABB2BF; ">)</span>| !<span class="operator" style="color: #C678DD; ">*</span>positive &amp;&amp; prop<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">key</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> == <span class="string" style="color: #98C379; ">&quot;local&quot;</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">collect</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

        <span class="comment" style="font-style: italic; color: #5C6370; ">// Store the numeric ids for all of the special captures.</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> injection_content_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> injection_language_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> local_def_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> local_def_value_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> local_ref_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> local_scope_capture_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> <span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">,</span> name<span class="text" style="color: #ABB2BF; ">)</span> <span class="keyword" style="color: #E06C75; ">in</span> query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">capture_names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">enumerate</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> i = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>i <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">match</span> <span class="operator" style="color: #C678DD; ">*</span>name <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="string" style="color: #98C379; ">&quot;injection.content&quot;</span> =&gt; injection_content_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="string" style="color: #98C379; ">&quot;injection.language&quot;</span> =&gt; injection_language_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="string" style="color: #98C379; ">&quot;local.definition&quot;</span> =&gt; local_def_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="string" style="color: #98C379; ">&quot;local.definition-value&quot;</span> =&gt; local_def_value_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="string" style="color: #98C379; ">&quot;local.reference&quot;</span> =&gt; local_ref_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="string" style="color: #98C379; ">&quot;local.scope&quot;</span> =&gt; local_scope_capture_index = i<span class="text" style="color: #ABB2BF; ">,</span>
                _ =&gt; <span class="text" style="color: #ABB2BF; ">{</span><span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>

        <span class="keyword" style="color: #E06C75; ">let</span> highlight_indices = <span class="function macro" style="color: #C678DD; ">vec</span><span class="function macro" style="color: #C678DD; ">!</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span> query<span class="text" style="color: #ABB2BF; ">.</span>capture_names<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span>len<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightConfiguration</span> <span class="text" style="color: #ABB2BF; ">{</span>
            language<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">:</span> name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">into</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            query<span class="text" style="color: #ABB2BF; ">,</span>
            apply_all_captures<span class="text" style="color: #ABB2BF; ">,</span>
            combined_injections_query<span class="text" style="color: #ABB2BF; ">,</span>
            locals_pattern_index<span class="text" style="color: #ABB2BF; ">,</span>
            highlights_pattern_index<span class="text" style="color: #ABB2BF; ">,</span>
            highlight_indices<span class="text" style="color: #ABB2BF; ">,</span>
            non_local_variable_patterns<span class="text" style="color: #ABB2BF; ">,</span>
            injection_content_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
            injection_language_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
            local_def_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
            local_def_value_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
            local_ref_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
            local_scope_capture_index<span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Get a slice containing all of the highlight names used in the configuration.</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">]</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">capture_names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Set the list of recognized highlight names.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Tree-sitter syntax-highlighting queries specify highlights in the form of dot-separated</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// highlight names like `punctuation.bracket` and `function.method.builtin`. Consumers of</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// these queries can choose to recognize highlights with different levels of specificity.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// For example, the string `function.builtin` will match against `function.method.builtin`</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// and `function.builtin.constructor`, but will not match `function.method`.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// When highlighting, results are returned as `Highlight` values, which contain the index</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// of the matched highlight this list of highlight names.</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">configure</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">recognized_names</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span><span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">AsRef</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> capture_parts = <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_indices</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clear</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_indices</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">capture_names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span><span class="keyword" style="color: #E06C75; ">move</span> |capture_name| <span class="text" style="color: #ABB2BF; ">{</span>
                capture_parts<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clear</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                capture_parts<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span>capture_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">split</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&#39;.&#39;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> best_index = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> best_match_len = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">for</span> <span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">,</span> recognized_name<span class="text" style="color: #ABB2BF; ">)</span> <span class="keyword" style="color: #E06C75; ">in</span> recognized_names<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">into_iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">enumerate</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> len = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> matches = <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">for</span> part <span class="keyword" style="color: #E06C75; ">in</span> recognized_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">split</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&#39;.&#39;</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        len += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> !capture_parts<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">contains</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span>part<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            matches = <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> matches &amp;&amp; len &gt; best_match_len <span class="text" style="color: #ABB2BF; ">{</span>
                        best_index = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        best_match_len = len<span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                best_index<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">// Return the list of this configuration&#39;s capture names that are neither present in the</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// list of predefined &#39;canonical&#39; names nor start with an underscore (denoting &#39;private&#39; captures</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// used as part of capture internals).</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">nonconformant_capture_names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">capture_names</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">HashSet</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> capture_names = <span class="keyword" style="color: #E06C75; ">if</span> capture_names<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">*</span><span class="constructor" style="color: #61AFEF; ">STANDARD_CAPTURE_NAMES</span>
        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="operator" style="color: #C678DD; ">&amp;</span>capture_names
        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">names</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">filter</span><span class="text" style="color: #ABB2BF; ">(</span>|<span class="operator" style="color: #C678DD; ">&amp;</span>n| !<span class="text" style="color: #ABB2BF; ">(</span>n<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">starts_with</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&#39;_&#39;</span><span class="text" style="color: #ABB2BF; ">)</span> || capture_names<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">contains</span><span class="text" style="color: #ABB2BF; ">(</span>n<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span>|n| <span class="operator" style="color: #C678DD; ">*</span>n<span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">collect</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// Create a new &#39;layer&#39; of highlighting for this document.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">///</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// In the even that the new layer contains &quot;combined injections&quot; (injections where multiple</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// disjoint ranges are parsed as one syntax tree), these will be eagerly processed and</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">/// added to the returned vector.</span>
    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">FnMut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="variable parameter" style="color: #E06C75; ">source</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">parent_name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">highlighter</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">Highlighter</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">cancellation_flag</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">AtomicUsize</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">injection_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable parameter" style="color: #E06C75; ">config</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable parameter" style="color: #E06C75; ">depth</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable parameter" style="color: #E06C75; ">ranges</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Self</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> result = <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">with_capacity</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> queue = <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">loop</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">if</span> highlighter<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">set_included_ranges</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span>ranges<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                highlighter
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">set_language</span><span class="text" style="color: #ABB2BF; ">(</span>config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">language</span><span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map_err</span><span class="text" style="color: #ABB2BF; ">(</span>|_| <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">InvalidLanguage</span><span class="text" style="color: #ABB2BF; ">)</span>?<span class="text" style="color: #ABB2BF; ">;</span>

                <span class="keyword" style="color: #E06C75; ">unsafe</span> <span class="text" style="color: #ABB2BF; ">{</span> highlighter<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">set_cancellation_flag</span><span class="text" style="color: #ABB2BF; ">(</span>cancellation_flag<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> tree = highlighter
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">parse</span><span class="text" style="color: #ABB2BF; ">(</span>source<span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">ok_or</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">Cancelled</span><span class="text" style="color: #ABB2BF; ">)</span>?<span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">unsafe</span> <span class="text" style="color: #ABB2BF; ">{</span> highlighter<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">parser</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">set_cancellation_flag</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> cursor = highlighter<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">cursors</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap_or</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">QueryCursor</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// Process combined injections.</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>combined_injections_query<span class="text" style="color: #ABB2BF; ">)</span> = <span class="operator" style="color: #C678DD; ">&amp;</span>config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">combined_injections_query</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> injections_by_pattern_index =
                        <span class="function macro" style="color: #C678DD; ">vec</span><span class="function macro" style="color: #C678DD; ">!</span><span class="text" style="color: #ABB2BF; ">[</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span>new<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span> combined_injections_query<span class="text" style="color: #ABB2BF; ">.</span>pattern_count<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> matches =
                        cursor<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">matches</span><span class="text" style="color: #ABB2BF; ">(</span>combined_injections_query<span class="text" style="color: #ABB2BF; ">,</span> tree<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">root_node</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> source<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">for</span> mat <span class="keyword" style="color: #E06C75; ">in</span> matches <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">let</span> entry = <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> injections_by_pattern_index<span class="text" style="color: #ABB2BF; ">[</span>mat<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">,</span> content_node<span class="text" style="color: #ABB2BF; ">,</span> include_children<span class="text" style="color: #ABB2BF; ">)</span> = <span class="function" style="color: #61AFEF; ">injection_for_match</span><span class="text" style="color: #ABB2BF; ">(</span>
                            config<span class="text" style="color: #ABB2BF; ">,</span>
                            parent_name<span class="text" style="color: #ABB2BF; ">,</span>
                            combined_injections_query<span class="text" style="color: #ABB2BF; ">,</span>
                            <span class="operator" style="color: #C678DD; ">&amp;</span>mat<span class="text" style="color: #ABB2BF; ">,</span>
                            source<span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> language_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            entry<span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">0</span> = language_name<span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>content_node<span class="text" style="color: #ABB2BF; ">)</span> = content_node <span class="text" style="color: #ABB2BF; ">{</span>
                            entry<span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>content_node<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                        entry<span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">2</span> = include_children<span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="keyword" style="color: #E06C75; ">for</span> <span class="text" style="color: #ABB2BF; ">(</span>lang_name<span class="text" style="color: #ABB2BF; ">,</span> content_nodes<span class="text" style="color: #ABB2BF; ">,</span> includes_children<span class="text" style="color: #ABB2BF; ">)</span> <span class="keyword" style="color: #E06C75; ">in</span> injections_by_pattern_index
                    <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>lang_name<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">)</span> = <span class="text" style="color: #ABB2BF; ">(</span>lang_name<span class="text" style="color: #ABB2BF; ">,</span> content_nodes<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>next_config<span class="text" style="color: #ABB2BF; ">)</span> = <span class="text" style="color: #ABB2BF; ">(</span>injection_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">(</span>lang_name<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                <span class="keyword" style="color: #E06C75; ">let</span> ranges = <span class="type" style="color: #E5C07B; ">Self</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">intersect_ranges</span><span class="text" style="color: #ABB2BF; ">(</span>
                                    <span class="operator" style="color: #C678DD; ">&amp;</span>ranges<span class="text" style="color: #ABB2BF; ">,</span>
                                    <span class="operator" style="color: #C678DD; ">&amp;</span>content_nodes<span class="text" style="color: #ABB2BF; ">,</span>
                                    includes_children<span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                                <span class="keyword" style="color: #E06C75; ">if</span> !ranges<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                    queue<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>next_config<span class="text" style="color: #ABB2BF; ">,</span> depth + <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">,</span> ranges<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                                <span class="text" style="color: #ABB2BF; ">}</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// The `captures` iterator borrows the `Tree` and the `QueryCursor`, which</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// prevents them from being moved. But both of these values are really just</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// pointers, so it&#39;s actually ok to move them.</span>
                <span class="keyword" style="color: #E06C75; ">let</span> tree_ref = <span class="keyword" style="color: #E06C75; ">unsafe</span> <span class="text" style="color: #ABB2BF; ">{</span> mem<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">transmute</span><span class="text" style="color: #ABB2BF; ">::</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">_</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">static</span> <span class="type" style="color: #E5C07B; ">Tree</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span>tree<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> cursor_ref =
                    <span class="keyword" style="color: #E06C75; ">unsafe</span> <span class="text" style="color: #ABB2BF; ">{</span> mem<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">transmute</span><span class="text" style="color: #ABB2BF; ">::</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">_</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">static</span> <span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">QueryCursor</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> cursor<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> captures = cursor_ref
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">captures</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span>config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">,</span> tree_ref<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">root_node</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> source<span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peekable</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                result<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightIterLayer</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="function macro" style="color: #C678DD; ">vec</span><span class="function macro" style="color: #C678DD; ">!</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constructor" style="color: #61AFEF; ">LocalScope</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        inherits<span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">,</span>
                        range<span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">.</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">,</span>
                        local_defs<span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span>new<span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
                    cursor<span class="text" style="color: #ABB2BF; ">,</span>
                    depth<span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">_tree</span><span class="text" style="color: #ABB2BF; ">:</span> tree<span class="text" style="color: #ABB2BF; ">,</span>
                    captures<span class="text" style="color: #ABB2BF; ">,</span>
                    config<span class="text" style="color: #ABB2BF; ">,</span>
                    ranges<span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="keyword" style="color: #E06C75; ">if</span> queue<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span>next_config<span class="text" style="color: #ABB2BF; ">,</span> next_depth<span class="text" style="color: #ABB2BF; ">,</span> next_ranges<span class="text" style="color: #ABB2BF; ">)</span> = queue<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                config = next_config<span class="text" style="color: #ABB2BF; ">;</span>
                depth = next_depth<span class="text" style="color: #ABB2BF; ">;</span>
                ranges = next_ranges<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>

        <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>result<span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">// Compute the ranges that should be included when parsing an injection.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// This takes into account three things:</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// * `parent_ranges` - The ranges must all fall within the *current* layer&#39;s ranges.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// * `nodes` - Every injection takes place within a set of nodes. The injection ranges</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">//   are the ranges of those nodes.</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// * `includes_children` - For some injections, the content nodes&#39; children should be</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">//   excluded from the nested document, so that only the content nodes&#39; *own* content</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">//   is reparsed. For other injections, the content nodes&#39; entire ranges should be</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">//   reparsed, including the ranges of their children.</span>
    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">intersect_ranges</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="variable parameter" style="color: #E06C75; ">parent_ranges</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">nodes</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">Node</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">includes_children</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Range</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> cursor = nodes<span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">walk</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> result = <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> parent_range_iter = parent_ranges<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> parent_range = parent_range_iter
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">expect</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">&quot;Layers should only be constructed with non-empty ranges vectors&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> node <span class="keyword" style="color: #E06C75; ">in</span> nodes<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> preceding_range = <span class="type" style="color: #E5C07B; ">Range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Point</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">:</span> node<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">:</span> node<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_position</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">let</span> following_range = <span class="type" style="color: #E5C07B; ">Range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">:</span> node<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">:</span> node<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">end_position</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">:</span> usize<span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Point</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>usize<span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">,</span> usize<span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">MAX</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>

            <span class="keyword" style="color: #E06C75; ">for</span> excluded_range <span class="keyword" style="color: #E06C75; ">in</span> node
                <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">children</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> cursor<span class="text" style="color: #ABB2BF; ">)</span>
                <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">filter_map</span><span class="text" style="color: #ABB2BF; ">(</span>|child| <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> includes_children <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="constructor" style="color: #61AFEF; ">None</span>
                    <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>child<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">range</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span>
                <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">chain</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">[</span>following_range<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">cloned</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> range = <span class="type" style="color: #E5C07B; ">Range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">:</span> preceding_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">:</span> preceding_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">:</span> excluded_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">:</span> excluded_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                preceding_range = excluded_range<span class="text" style="color: #ABB2BF; ">;</span>

                <span class="keyword" style="color: #E06C75; ">if</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> &lt; parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">continue</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>

                <span class="keyword" style="color: #E06C75; ">while</span> parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> &lt;= range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> &gt; range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> &lt; parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> = parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">;</span>
                            range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_point</span> = parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>

                        <span class="keyword" style="color: #E06C75; ">if</span> parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> &lt; range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="keyword" style="color: #E06C75; ">if</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> &lt; parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                result<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                    <span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">:</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">,</span>
                                    <span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">:</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_point</span><span class="text" style="color: #ABB2BF; ">,</span>
                                    <span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">:</span> parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">,</span>
                                    <span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">:</span> parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                            range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> = parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span><span class="text" style="color: #ABB2BF; ">;</span>
                            range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_point</span> = parent_range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_point</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="keyword" style="color: #E06C75; ">if</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start_byte</span> &lt; range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end_byte</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                result<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>range<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                            <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>

                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>next_range<span class="text" style="color: #ABB2BF; ">)</span> = parent_range_iter<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        parent_range = next_range<span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">return</span> result<span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        result
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="comment" style="font-style: italic; color: #5C6370; ">// First, sort scope boundaries by their byte offset in the document. At a</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// given position, emit scope endings before scope beginnings. Finally, emit</span>
    <span class="comment" style="font-style: italic; color: #5C6370; ">// scope boundaries from deeper layers first.</span>
    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">sort_key</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">isize</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> depth = -<span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">depth</span> <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">isize</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> next_start = <span class="variable builtin" style="color: #61AFEF; ">self</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peek</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span>|<span class="text" style="color: #ABB2BF; ">(</span>m<span class="text" style="color: #ABB2BF; ">,</span> i<span class="text" style="color: #ABB2BF; ">)</span>| m<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">*</span>i<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_byte</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">let</span> next_end = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">cloned</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">match</span> <span class="text" style="color: #ABB2BF; ">(</span>next_start<span class="text" style="color: #ABB2BF; ">,</span> next_end<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>start<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>end<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> start &lt; end <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>start<span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">,</span> depth<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
                <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>end<span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">,</span> depth<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">,</span> depth<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>j<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>j<span class="text" style="color: #ABB2BF; ">,</span> <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">,</span> depth<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            _ =&gt; <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="type" style="color: #E5C07B; ">HighlightIter</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span>
<span class="keyword" style="color: #E06C75; ">where</span>
    <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">FnMut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">emit_event</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">offset</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">event</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> result<span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span> &lt; offset <span class="text" style="color: #ABB2BF; ">{</span>
            result = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Source</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="text" style="color: #ABB2BF; ">start</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">end</span><span class="text" style="color: #ABB2BF; ">:</span> offset<span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span> = offset<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">next_event</span> = event<span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
            result = event<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        result
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">while</span> !<span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>sort_key<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_key</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> i = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">while</span> i + <span class="constant builtin" style="color: #D19A66; ">1</span> &lt; <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>next_offset<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span>i + <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_key</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> next_offset &lt; sort_key <span class="text" style="color: #ABB2BF; ">{</span>
                            i += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="keyword" style="color: #E06C75; ">continue</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="keyword" style="color: #E06C75; ">if</span> i &gt; <span class="constant builtin" style="color: #D19A66; ">0</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span>..<span class="text" style="color: #ABB2BF; ">(</span>i + <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">rotate_left</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> layer = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlighter</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">cursors</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">cursor</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">insert_layer</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable parameter" style="color: #E06C75; ">layer</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>sort_key<span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_key</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> i = <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">while</span> i &lt; <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>sort_key_i<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span>i<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_key</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> sort_key_i &gt; sort_key <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">insert</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">,</span> layer<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">return</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                    i += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>layer<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="type" style="color: #E5C07B; ">Iterator</span> <span class="keyword" style="color: #E06C75; ">for</span> <span class="type" style="color: #E5C07B; ">HighlightIter</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span>
<span class="keyword" style="color: #E06C75; ">where</span>
    <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">FnMut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">&gt;</span> + <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">type</span> <span class="type" style="color: #E5C07B; ">Item</span> = <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">;</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Self</span><span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Item</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="operator" style="color: #C678DD; ">&#39;</span>main<span class="text" style="color: #ABB2BF; ">:</span> <span class="keyword" style="color: #E06C75; ">loop</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// If we&#39;ve already determined the next highlight boundary, just return it.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>e<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">next_event</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">take</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">return</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>e<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Periodically check for cancellation, returning `Cancelled` error if the</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// cancellation flag was flipped.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>cancellation_flag<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">cancellation_flag</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">iter_count</span> += <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">iter_count</span> &gt;= <span class="constructor" style="color: #61AFEF; ">CANCELLATION_CHECK_INTERVAL</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">iter_count</span> = <span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> cancellation_flag<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">load</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Ordering</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">Relaxed</span><span class="text" style="color: #ABB2BF; ">)</span> != <span class="constant builtin" style="color: #D19A66; ">0</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">return</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Err</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">Cancelled</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// If none of the layers have any more highlight boundaries, terminate.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">return</span> <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span> &lt; <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> result = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="type" style="color: #E5C07B; ">Source</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="text" style="color: #ABB2BF; ">start</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span><span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">end</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">byte_offset</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    result
                <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="constructor" style="color: #61AFEF; ">None</span>
                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Get the next capture from whichever layer has the earliest highlight boundary.</span>
            <span class="keyword" style="color: #E06C75; ">let</span> range<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">let</span> layer = <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>next_match<span class="text" style="color: #ABB2BF; ">,</span> capture_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peek</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> next_capture = next_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">*</span>capture_index<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                range = next_capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">byte_range</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// If any previous highlight ends before this node starts, then before</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// processing this capture, emit the source code up until the end of the</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// previous highlight, and an end event for that highlight.</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>end_byte<span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">cloned</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> end_byte &lt;= range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">return</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">emit_event</span><span class="text" style="color: #ABB2BF; ">(</span>end_byte<span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HighlightEnd</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// If there are no more captures, then emit any remaining highlight end events.</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// And if there are none of those, then just advance to the end of the document.</span>
            <span class="keyword" style="color: #E06C75; ">else</span> <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>end_byte<span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">cloned</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">return</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">emit_event</span><span class="text" style="color: #ABB2BF; ">(</span>end_byte<span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HighlightEnd</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">return</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">emit_event</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>

            <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span><span class="keyword" style="color: #E06C75; ">mut</span> match_<span class="text" style="color: #ABB2BF; ">,</span> capture_index<span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> capture = match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span>capture_index<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// If this capture represents an injection, then process the injection.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span> &lt; layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">locals_pattern_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">,</span> content_node<span class="text" style="color: #ABB2BF; ">,</span> include_children<span class="text" style="color: #ABB2BF; ">)</span> = <span class="function" style="color: #61AFEF; ">injection_for_match</span><span class="text" style="color: #ABB2BF; ">(</span>
                    layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="operator" style="color: #C678DD; ">&amp;</span>layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="operator" style="color: #C678DD; ">&amp;</span>match_<span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">,</span>
                <span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// Explicitly remove this match so that none of its other captures will remain</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// in the stream of captures.</span>
                match_<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// If a language is found with the given name, then add a new language layer</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// to the highlighted document.</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>content_node<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = <span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">,</span> content_node<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>config<span class="text" style="color: #ABB2BF; ">)</span> = <span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">injection_callback</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">let</span> ranges = <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">intersect_ranges</span><span class="text" style="color: #ABB2BF; ">(</span>
                            <span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">ranges</span><span class="text" style="color: #ABB2BF; ">,</span>
                            <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span>content_node<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
                            include_children<span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> !ranges<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="keyword" style="color: #E06C75; ">match</span> <span class="type" style="color: #E5C07B; ">HighlightIterLayer</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>
                                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlighter</span><span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">cancellation_flag</span><span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">injection_callback</span><span class="text" style="color: #ABB2BF; ">,</span>
                                config<span class="text" style="color: #ABB2BF; ">,</span>
                                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">layers</span><span class="text" style="color: #ABB2BF; ">[</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">depth</span> + <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">,</span>
                                ranges<span class="text" style="color: #ABB2BF; ">,</span>
                            <span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>layers<span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                                    <span class="keyword" style="color: #E06C75; ">for</span> layer <span class="keyword" style="color: #E06C75; ">in</span> layers <span class="text" style="color: #ABB2BF; ">{</span>
                                        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">insert_layer</span><span class="text" style="color: #ABB2BF; ">(</span>layer<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                                    <span class="text" style="color: #ABB2BF; ">}</span>
                                <span class="text" style="color: #ABB2BF; ">}</span>
                                <span class="constructor" style="color: #61AFEF; ">Err</span><span class="text" style="color: #ABB2BF; ">(</span>e<span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="keyword" style="color: #E06C75; ">return</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">Err</span><span class="text" style="color: #ABB2BF; ">(</span>e<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>

                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">continue</span> <span class="operator" style="color: #C678DD; ">&#39;</span>main<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Remove from the local scope stack any local scopes that have already ended.</span>
            <span class="keyword" style="color: #E06C75; ">while</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span> &gt; layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">range</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end</span> <span class="text" style="color: #ABB2BF; ">{</span>
                layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// If this capture is for tracking local variables, then process the</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// local variable info.</span>
            <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> reference_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> definition_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">while</span> match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span> &lt; layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlights_pattern_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// If the node represents a local scope, push a new local scope onto</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// the scope stack.</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span><span class="text" style="color: #ABB2BF; ">)</span> == layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_scope_capture_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    definition_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> scope = <span class="type" style="color: #E5C07B; ">LocalScope</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="text" style="color: #ABB2BF; ">inherits</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">range</span><span class="text" style="color: #ABB2BF; ">:</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clone</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">local_defs</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
                    <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">for</span> prop <span class="keyword" style="color: #E06C75; ">in</span> layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">query</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">property_settings</span><span class="text" style="color: #ABB2BF; ">(</span>match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">match</span> prop<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">key</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="string" style="color: #98C379; ">&quot;local.scope-inherits&quot;</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                                scope<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">inherits</span> =
                                    prop<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">value</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map_or</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">,</span> |r| r<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> == <span class="string" style="color: #98C379; ">&quot;true&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                            _ =&gt; <span class="text" style="color: #ABB2BF; ">{</span><span class="text" style="color: #ABB2BF; ">}</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                    layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>scope<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// If the node represents a definition, add a new definition to the</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// local scope at the top of the scope stack.</span>
                <span class="keyword" style="color: #E06C75; ">else</span> <span class="keyword" style="color: #E06C75; ">if</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span><span class="text" style="color: #ABB2BF; ">)</span> == layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_def_capture_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    reference_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
                    definition_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> scope = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last_mut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>

                    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> value_range = <span class="constant builtin" style="color: #D19A66; ">0</span>..<span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">for</span> capture <span class="keyword" style="color: #E06C75; ">in</span> match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span><span class="text" style="color: #ABB2BF; ">)</span> == layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_def_value_capture_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            value_range = capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">byte_range</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>

                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>name<span class="text" style="color: #ABB2BF; ">)</span> = str<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">from_utf8</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">[</span>range<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clone</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        scope<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_defs</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">LocalDef</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            name<span class="text" style="color: #ABB2BF; ">,</span>
                            value_range<span class="text" style="color: #ABB2BF; ">,</span>
                            <span class="text" style="color: #ABB2BF; ">highlight</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
                        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        definition_highlight =
                            scope<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_defs</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last_mut</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span>|s| <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> s<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// If the node represents a reference, then try to find the corresponding</span>
                <span class="comment" style="font-style: italic; color: #5C6370; ">// definition in the scope stack.</span>
                <span class="keyword" style="color: #E06C75; ">else</span> <span class="keyword" style="color: #E06C75; ">if</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span><span class="text" style="color: #ABB2BF; ">)</span> == layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_ref_capture_index</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> definition_highlight<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_none</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        definition_highlight = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span>name<span class="text" style="color: #ABB2BF; ">)</span> = str<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">from_utf8</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">source</span><span class="text" style="color: #ABB2BF; ">[</span>range<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clone</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            <span class="keyword" style="color: #E06C75; ">for</span> scope <span class="keyword" style="color: #E06C75; ">in</span> layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">scope_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">rev</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>highlight<span class="text" style="color: #ABB2BF; ">)</span> =
                                    scope<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">local_defs</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">rev</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">find_map</span><span class="text" style="color: #ABB2BF; ">(</span>|def| <span class="text" style="color: #ABB2BF; ">{</span>
                                        <span class="keyword" style="color: #E06C75; ">if</span> def<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">name</span> == name &amp;&amp; range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span> &gt;= def<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">value_range</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                            <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>def<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight</span><span class="text" style="color: #ABB2BF; ">)</span>
                                        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                            <span class="constructor" style="color: #61AFEF; ">None</span>
                                        <span class="text" style="color: #ABB2BF; ">}</span>
                                    <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span>
                                <span class="text" style="color: #ABB2BF; ">{</span>
                                    reference_highlight = highlight<span class="text" style="color: #ABB2BF; ">;</span>
                                    <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                                <span class="text" style="color: #ABB2BF; ">}</span>
                                <span class="keyword" style="color: #E06C75; ">if</span> !scope<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">inherits</span> <span class="text" style="color: #ABB2BF; ">{</span>
                                    <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                                <span class="text" style="color: #ABB2BF; ">}</span>
                            <span class="text" style="color: #ABB2BF; ">}</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>

                <span class="comment" style="font-style: italic; color: #5C6370; ">// Continue processing any additional matches for the same node.</span>
                <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>next_match<span class="text" style="color: #ABB2BF; ">,</span> next_capture_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peek</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">let</span> next_capture = next_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">*</span>next_capture_index<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> next_capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> == capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        capture = next_capture<span class="text" style="color: #ABB2BF; ">;</span>
                        match_ = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">continue</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span>

                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">continue</span> <span class="operator" style="color: #C678DD; ">&#39;</span>main<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Otherwise, this capture must represent a highlight.</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// If this exact range has already been highlighted by an earlier pattern, or by</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// a different layer, then skip over this one.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>last_start<span class="text" style="color: #ABB2BF; ">,</span> last_end<span class="text" style="color: #ABB2BF; ">,</span> last_depth<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">last_highlight_range</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span> == last_start &amp;&amp; range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end</span> == last_end &amp;&amp; layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">depth</span> &lt; last_depth <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">continue</span> <span class="operator" style="color: #C678DD; ">&#39;</span>main<span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// If the current node was found to be a local variable, then skip over any</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// highlighting patterns that are disabled for local variables.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> definition_highlight<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> || reference_highlight<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">while</span> layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">non_local_variable_patterns</span><span class="text" style="color: #ABB2BF; ">[</span>match_<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span><span class="text" style="color: #ABB2BF; ">]</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    match_<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>next_match<span class="text" style="color: #ABB2BF; ">,</span> next_capture_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peek</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        <span class="keyword" style="color: #E06C75; ">let</span> next_capture = next_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">*</span>next_capture_index<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="keyword" style="color: #E06C75; ">if</span> next_capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> == capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> <span class="text" style="color: #ABB2BF; ">{</span>
                            capture = next_capture<span class="text" style="color: #ABB2BF; ">;</span>
                            match_ = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                            <span class="keyword" style="color: #E06C75; ">continue</span><span class="text" style="color: #ABB2BF; ">;</span>
                        <span class="text" style="color: #ABB2BF; ">}</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>

                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="keyword" style="color: #E06C75; ">continue</span> <span class="operator" style="color: #C678DD; ">&#39;</span>main<span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Once a highlighting pattern is found for the current node, skip over</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// any later highlighting patterns that also match this node. Captures</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// for a given node are ordered by pattern index, so these subsequent</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// captures are guaranteed to be for highlighting, not injections or</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// local variables.</span>
            <span class="keyword" style="color: #E06C75; ">while</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>next_match<span class="text" style="color: #ABB2BF; ">,</span> next_capture_index<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">peek</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> next_capture = next_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">[</span><span class="operator" style="color: #C678DD; ">*</span>next_capture_index<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">if</span> next_capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> == capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">apply_all_captures</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        match_<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">remove</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                        capture = next_capture<span class="text" style="color: #ABB2BF; ">;</span>
                        match_ = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                        layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">next</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="keyword" style="color: #E06C75; ">break</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="keyword" style="color: #E06C75; ">let</span> current_highlight = layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">config</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_indices</span><span class="text" style="color: #ABB2BF; ">[</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span> <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">;</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// If this node represents a local definition, then store the current</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// highlight value on the local scope entry representing this node.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>definition_highlight<span class="text" style="color: #ABB2BF; ">)</span> = definition_highlight <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="operator" style="color: #C678DD; ">*</span>definition_highlight = current_highlight<span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Emit a scope start event and push the node&#39;s end position to the stack.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>highlight<span class="text" style="color: #ABB2BF; ">)</span> = reference_highlight<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">or</span><span class="text" style="color: #ABB2BF; ">(</span>current_highlight<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">last_highlight_range</span> = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span>range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span><span class="text" style="color: #ABB2BF; ">,</span> range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end</span><span class="text" style="color: #ABB2BF; ">,</span> layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">depth</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                layer<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">highlight_end_stack</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">end</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">return</span> <span class="variable builtin" style="color: #61AFEF; ">self</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">emit_event</span><span class="text" style="color: #ABB2BF; ">(</span>range<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">start</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HighlightStart</span><span class="text" style="color: #ABB2BF; ">(</span>highlight<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">sort_layers</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">HtmlRenderer</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Self</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> result = <span class="type" style="color: #E5C07B; ">HtmlRenderer</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">with_capacity</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">BUFFER_HTML_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">with_capacity</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constructor" style="color: #61AFEF; ">BUFFER_LINES_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">carriage_return_highlight</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
        result<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        result
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">set_carriage_return_highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">highlight</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">carriage_return_highlight</span> = highlight<span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">reset</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="function" style="color: #61AFEF; ">shrink_and_clear</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">BUFFER_HTML_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="function" style="color: #61AFEF; ">shrink_and_clear</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="constructor" style="color: #61AFEF; ">BUFFER_LINES_RESERVE_CAPACITY</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="constant builtin" style="color: #D19A66; ">0</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">render</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span>
        <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">highlighter</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">Iterator</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Item</span> = <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">source</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
        <span class="variable parameter" style="color: #E06C75; ">attribute_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="type" style="color: #E5C07B; ">Result</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Error</span><span class="text" style="color: #ABB2BF; ">&gt;</span>
    <span class="keyword" style="color: #E06C75; ">where</span>
        <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Fn</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> highlights = <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> event <span class="keyword" style="color: #E06C75; ">in</span> highlighter <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">match</span> event <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HighlightStart</span><span class="text" style="color: #ABB2BF; ">(</span>s<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                    highlights<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>s<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_highlight</span><span class="text" style="color: #ABB2BF; ">(</span>s<span class="text" style="color: #ABB2BF; ">,</span> attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">HighlightEnd</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                    highlights<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">end_highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">HighlightEvent</span><span class="text" style="color: #ABB2BF; ">::</span><span class="constructor" style="color: #61AFEF; ">Source</span> <span class="text" style="color: #ABB2BF; ">{</span> start<span class="text" style="color: #ABB2BF; ">,</span> end <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">add_text</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span>source<span class="text" style="color: #ABB2BF; ">[</span>start..end<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&amp;</span>highlights<span class="text" style="color: #ABB2BF; ">,</span> attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                <span class="constructor" style="color: #61AFEF; ">Err</span><span class="text" style="color: #ABB2BF; ">(</span>a<span class="text" style="color: #ABB2BF; ">)</span> =&gt; <span class="keyword" style="color: #E06C75; ">return</span> <span class="constructor" style="color: #61AFEF; ">Err</span><span class="text" style="color: #ABB2BF; ">(</span>a<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">,</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> != <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="string" style="color: #98C379; ">b&#39;\n&#39;</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&#39;\n&#39;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="keyword" style="color: #E06C75; ">if</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">last</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> == <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">pop</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="constructor" style="color: #61AFEF; ">Ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">pub</span> <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">lines</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="keyword" style="color: #E06C75; ">impl</span> <span class="type" style="color: #E5C07B; ">Iterator</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Item</span> = <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">enumerate</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span><span class="keyword" style="color: #E06C75; ">move</span> |<span class="text" style="color: #ABB2BF; ">(</span>i<span class="text" style="color: #ABB2BF; ">,</span> line_start<span class="text" style="color: #ABB2BF; ">)</span>| <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">let</span> line_start = <span class="operator" style="color: #C678DD; ">*</span>line_start <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">let</span> line_end = <span class="keyword" style="color: #E06C75; ">if</span> i + <span class="constant builtin" style="color: #D19A66; ">1</span> == <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
                <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">[</span>i + <span class="constant builtin" style="color: #D19A66; ">1</span><span class="text" style="color: #ABB2BF; ">]</span> <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">usize</span>
                <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">;</span>
                str<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">from_utf8</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">[</span>line_start..line_end<span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">unwrap</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
            <span class="text" style="color: #ABB2BF; ">}</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">add_carriage_return</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">attribute_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="keyword" style="color: #E06C75; ">where</span>
        <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Fn</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>highlight<span class="text" style="color: #ABB2BF; ">)</span> = <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">carriage_return_highlight</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="keyword" style="color: #E06C75; ">let</span> attribute_string = <span class="text" style="color: #ABB2BF; ">(</span>attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">(</span>highlight<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="keyword" style="color: #E06C75; ">if</span> !attribute_string<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot;&lt;span &quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span>attribute_string<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot;&gt;&lt;/span&gt;&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">start_highlight</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">h</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">attribute_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="keyword" style="color: #E06C75; ">where</span>
        <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Fn</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> attribute_string = <span class="text" style="color: #ABB2BF; ">(</span>attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">(</span>h<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot;&lt;span&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">if</span> !attribute_string<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_empty</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot; &quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span>attribute_string<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot;&gt;&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">end_highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend</span><span class="text" style="color: #ABB2BF; ">(</span><span class="string" style="color: #98C379; ">b&quot;&lt;/span&gt;&quot;</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">add_text</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">src</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">highlights</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">attribute_callback</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">)</span>
    <span class="keyword" style="color: #E06C75; ">where</span>
        <span class="type" style="color: #E5C07B; ">F</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Fn</span><span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Highlight</span><span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> last_char_was_cr = <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">for</span> c <span class="keyword" style="color: #E06C75; ">in</span> <span class="type" style="color: #E5C07B; ">LossyUtf8</span><span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">new</span><span class="text" style="color: #ABB2BF; ">(</span>src<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">flat_map</span><span class="text" style="color: #ABB2BF; ">(</span>|p| p<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">bytes</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// Don&#39;t render carriage return characters, but allow lone carriage returns (not</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// followed by line feeds) to be styled via the attribute callback.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> c == <span class="string" style="color: #98C379; ">b&#39;\r&#39;</span> <span class="text" style="color: #ABB2BF; ">{</span>
                last_char_was_cr = <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="keyword" style="color: #E06C75; ">continue</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="keyword" style="color: #E06C75; ">if</span> last_char_was_cr <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> c != <span class="string" style="color: #98C379; ">b&#39;\n&#39;</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">add_carriage_return</span><span class="text" style="color: #ABB2BF; ">(</span>attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
                last_char_was_cr = <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// At line boundaries, close and re-open all of the open tags.</span>
            <span class="keyword" style="color: #E06C75; ">if</span> c == <span class="string" style="color: #98C379; ">b&#39;\n&#39;</span> <span class="text" style="color: #ABB2BF; ">{</span>
                highlights<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">for_each</span><span class="text" style="color: #ABB2BF; ">(</span>|_| <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">end_highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>c<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">line_offsets</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="keyword" style="color: #E06C75; ">as</span> <span class="type" style="color: #E5C07B; ">u32</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                highlights
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">iter</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span>
                    <span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">for_each</span><span class="text" style="color: #ABB2BF; ">(</span>|scope| <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">start_highlight</span><span class="text" style="color: #ABB2BF; ">(</span><span class="operator" style="color: #C678DD; ">*</span>scope<span class="text" style="color: #ABB2BF; ">,</span> attribute_callback<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="keyword" style="color: #E06C75; ">if</span> <span class="keyword" style="color: #E06C75; ">let</span> <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>escape<span class="text" style="color: #ABB2BF; ">)</span> = util<span class="text" style="color: #ABB2BF; ">::</span><span class="function" style="color: #61AFEF; ">html_escape</span><span class="text" style="color: #ABB2BF; ">(</span>c<span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">extend_from_slice</span><span class="text" style="color: #ABB2BF; ">(</span>escape<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="variable builtin" style="color: #61AFEF; ">self</span><span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">html</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">push</span><span class="text" style="color: #ABB2BF; ">(</span>c<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
            <span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">injection_for_match</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span>
    <span class="variable parameter" style="color: #E06C75; ">config</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">HighlightConfiguration</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="variable parameter" style="color: #E06C75; ">parent_name</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="variable parameter" style="color: #E06C75; ">query</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">Query</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="variable parameter" style="color: #E06C75; ">query_match</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="type" style="color: #E5C07B; ">QueryMatch</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span>
    <span class="variable parameter" style="color: #E06C75; ">source</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="text" style="color: #ABB2BF; ">[</span><span class="type" style="color: #E5C07B; ">u8</span><span class="text" style="color: #ABB2BF; ">]</span><span class="text" style="color: #ABB2BF; ">,</span>
<span class="text" style="color: #ABB2BF; ">)</span> -&gt; <span class="text" style="color: #ABB2BF; ">(</span><span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&amp;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span> <span class="type" style="color: #E5C07B; ">str</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">Option</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">Node</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="operator" style="color: #C678DD; ">&#39;</span><span class="label" style="color: #C678DD; ">a</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="type" style="color: #E5C07B; ">bool</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">let</span> content_capture_index = config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">injection_content_capture_index</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="keyword" style="color: #E06C75; ">let</span> language_capture_index = config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">injection_language_capture_index</span><span class="text" style="color: #ABB2BF; ">;</span>

    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> language_name = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> content_node = <span class="constructor" style="color: #61AFEF; ">None</span><span class="text" style="color: #ABB2BF; ">;</span>

    <span class="keyword" style="color: #E06C75; ">for</span> capture <span class="keyword" style="color: #E06C75; ">in</span> query_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">captures</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">let</span> index = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">index</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="keyword" style="color: #E06C75; ">if</span> index == language_capture_index <span class="text" style="color: #ABB2BF; ">{</span>
            language_name = capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">utf8_text</span><span class="text" style="color: #ABB2BF; ">(</span>source<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">ok</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span> <span class="keyword" style="color: #E06C75; ">else</span> <span class="keyword" style="color: #E06C75; ">if</span> index == content_capture_index <span class="text" style="color: #ABB2BF; ">{</span>
            content_node = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>capture<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">node</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="keyword" style="color: #E06C75; ">let</span> <span class="keyword" style="color: #E06C75; ">mut</span> include_children = <span class="constant builtin" style="color: #D19A66; ">false</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="keyword" style="color: #E06C75; ">for</span> prop <span class="keyword" style="color: #E06C75; ">in</span> query<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">property_settings</span><span class="text" style="color: #ABB2BF; ">(</span>query_match<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">pattern_index</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
        <span class="keyword" style="color: #E06C75; ">match</span> prop<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">key</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// In addition to specifying the language name via the text of a</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// captured node, it can also be hard-coded via a `#set!` predicate</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// that sets the injection.language key.</span>
            <span class="string" style="color: #98C379; ">&quot;injection.language&quot;</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> language_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_none</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    language_name = prop<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">value</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">map</span><span class="text" style="color: #ABB2BF; ">(</span>|s| s<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_ref</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Setting the `injection.self` key can be used to specify that the</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// language name should be the same as the language of the current</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// layer.</span>
            <span class="string" style="color: #98C379; ">&quot;injection.self&quot;</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> language_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_none</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    language_name = <span class="constructor" style="color: #61AFEF; ">Some</span><span class="text" style="color: #ABB2BF; ">(</span>config<span class="text" style="color: #ABB2BF; ">.</span><span class="text" style="color: #ABB2BF; ">language_name</span><span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">as_str</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// Setting the `injection.parent` key can be used to specify that</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// the language name should be the same as the language of the</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// parent layer</span>
            <span class="string" style="color: #98C379; ">&quot;injection.parent&quot;</span> =&gt; <span class="text" style="color: #ABB2BF; ">{</span>
                <span class="keyword" style="color: #E06C75; ">if</span> language_name<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">is_none</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
                    language_name = parent_name<span class="text" style="color: #ABB2BF; ">;</span>
                <span class="text" style="color: #ABB2BF; ">}</span>
            <span class="text" style="color: #ABB2BF; ">}</span>

            <span class="comment" style="font-style: italic; color: #5C6370; ">// By default, injections do not include the *children* of an</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// `injection.content` node - only the ranges that belong to the</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// node itself. This can be changed using a `#set!` predicate that</span>
            <span class="comment" style="font-style: italic; color: #5C6370; ">// sets the `injection.include-children` key.</span>
            <span class="string" style="color: #98C379; ">&quot;injection.include-children&quot;</span> =&gt; include_children = <span class="constant builtin" style="color: #D19A66; ">true</span><span class="text" style="color: #ABB2BF; ">,</span>
            _ =&gt; <span class="text" style="color: #ABB2BF; ">{</span><span class="text" style="color: #ABB2BF; ">}</span>
        <span class="text" style="color: #ABB2BF; ">}</span>
    <span class="text" style="color: #ABB2BF; ">}</span>

    <span class="text" style="color: #ABB2BF; ">(</span>language_name<span class="text" style="color: #ABB2BF; ">,</span> content_node<span class="text" style="color: #ABB2BF; ">,</span> include_children<span class="text" style="color: #ABB2BF; ">)</span>
<span class="text" style="color: #ABB2BF; ">}</span>

<span class="keyword" style="color: #E06C75; ">fn</span> <span class="function" style="color: #61AFEF; ">shrink_and_clear</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">T</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">(</span><span class="variable parameter" style="color: #E06C75; ">vec</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="operator" style="color: #C678DD; ">&amp;</span><span class="keyword" style="color: #E06C75; ">mut</span> <span class="type" style="color: #E5C07B; ">Vec</span><span class="text" style="color: #ABB2BF; ">&lt;</span><span class="type" style="color: #E5C07B; ">T</span><span class="text" style="color: #ABB2BF; ">&gt;</span><span class="text" style="color: #ABB2BF; ">,</span> <span class="variable parameter" style="color: #E06C75; ">capacity</span><span class="text" style="color: #ABB2BF; ">:</span> <span class="type" style="color: #E5C07B; ">usize</span><span class="text" style="color: #ABB2BF; ">)</span> <span class="text" style="color: #ABB2BF; ">{</span>
    <span class="keyword" style="color: #E06C75; ">if</span> vec<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">len</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span> &gt; capacity <span class="text" style="color: #ABB2BF; ">{</span>
        vec<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">truncate</span><span class="text" style="color: #ABB2BF; ">(</span>capacity<span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
        vec<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">shrink_to_fit</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
    <span class="text" style="color: #ABB2BF; ">}</span>
    vec<span class="text" style="color: #ABB2BF; ">.</span><span class="function" style="color: #61AFEF; ">clear</span><span class="text" style="color: #ABB2BF; ">(</span><span class="text" style="color: #ABB2BF; ">)</span><span class="text" style="color: #ABB2BF; ">;</span>
<span class="text" style="color: #ABB2BF; ">}</span>
</code></pre>
</body>
</html>
