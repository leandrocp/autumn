<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Autumn Sample - ruby - catppuccin_latte (inline)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.5;
    }
    pre {
      font-size: 15px;
      margin: 20px;
      padding: 50px;
      border-radius: 10px;
    }
  </style>
  <style>
  /* catppuccin_latte */
pre.autumn-hl { background-color: #eff1f5; color: #4c4f69; }
.ahl-info { color: #04a5e5; }
.ahl-label { color: #209fb5; }
.ahl-markup.ahl-heading.ahl-marker { font-weight: bold; color: #fe640b; }
.ahl-markup.ahl-bold { font-weight: bold; }
.ahl-namespace { font-style: italic; color: #1e66f5; }
.ahl-keyword.ahl-control.ahl-conditional { font-style: italic; color: #8839ef; }
.ahl-markup.ahl-heading.ahl-1 { color: #7287fd; }
.ahl-constant.ahl-builtin { color: #fe640b; }
.ahl-markup.ahl-heading.ahl-6 { color: #179299; }
.ahl-attribute { color: #1e66f5; }
.ahl-type { color: #df8e1d; }
.ahl-diagnostic.ahl-warning { color: #df8e1d; }
.ahl-hint { color: #179299; }
.ahl-string.ahl-special { color: #1e66f5; }
.ahl-constant { color: #fe640b; }
.ahl-punctuation.ahl-special { color: #04a5e5; }
.ahl-warning { color: #df8e1d; }
.ahl-string.ahl-regexp { color: #fe640b; }
.ahl-variable { color: #4c4f69; }
.ahl-constructor { color: #209fb5; }
.ahl-markup.ahl-heading.ahl-2 { color: #8839ef; }
.ahl-keyword.ahl-storage.ahl-modifier.ahl-ref { color: #179299; }
.ahl-diagnostic.ahl-error { color: #d20f39; }
.ahl-diff.ahl-minus { color: #d20f39; }
.ahl-constant.ahl-character { color: #179299; }
.ahl-markup.ahl-raw { color: #dd7878; }
.ahl-tag { color: #8839ef; }
.ahl-comment { font-style: italic; color: #8c8fa1; }
.ahl-markup.ahl-link.ahl-text { color: #1e66f5; }
.ahl-punctuation { color: #7c7f93; }
.ahl-markup.ahl-italic { font-style: italic; }
.ahl-function.ahl-macro { color: #8839ef; }
.ahl-special { color: #1e66f5; }
.ahl-diff.ahl-plus { color: #40a02b; }
.ahl-operator { color: #04a5e5; }
.ahl-diagnostic.ahl-info { color: #04a5e5; }
.ahl-constant.ahl-character.ahl-escape { color: #ea76cb; }
.ahl-markup.ahl-link.ahl-url {  color: #dc8a78; }
.ahl-variable.ahl-builtin { color: #d20f39; }
.ahl-variable.ahl-parameter { font-style: italic; color: #e64553; }
.ahl-string { color: #40a02b; }
.ahl-diff.ahl-delta { color: #1e66f5; }
.ahl-keyword { color: #8839ef; }
.ahl-markup.ahl-heading.ahl-3 { color: #40a02b; }
.ahl-markup.ahl-heading.ahl-5 { color: #ea76cb; }
.ahl-markup.ahl-heading.ahl-4 { color: #df8e1d; }
.ahl-markup.ahl-list { color: #8839ef; }
.ahl-diagnostic.ahl-hint { color: #179299; }
.ahl-variable.ahl-other.ahl-member { color: #179299; }
.ahl-function { color: #1e66f5; }
.ahl-error { color: #d20f39; }

  </style>
</head>
<body>
  <pre class="autumn-hl"><code class="language-ruby" translate="no"><span class="ahl-comment"># frozen_string_literal: true</span>

<span class="ahl-keyword ahl-control ahl-import">require_relative</span> <span class="ahl-string">&#x27;constants&#x27;</span>
<span class="ahl-keyword ahl-control ahl-import">require_relative</span> <span class="ahl-string">&#x27;utils&#x27;</span>
<span class="ahl-keyword ahl-control ahl-import">require_relative</span> <span class="ahl-string">&#x27;media_type&#x27;</span>

<span class="ahl-keyword">module</span> <span class="ahl-constructor">Rack</span>
  <span class="ahl-comment"># Rack::Request provides a convenient interface to a Rack</span>
  <span class="ahl-comment"># environment.  It is stateless, the environment +env+ passed to the</span>
  <span class="ahl-comment"># constructor will be directly modified.</span>
  <span class="ahl-comment">#</span>
  <span class="ahl-comment">#   req = Rack::Request.new(env)</span>
  <span class="ahl-comment">#   req.post?</span>
  <span class="ahl-comment">#   req.params[&quot;data&quot;]</span>

  <span class="ahl-keyword">class</span> <span class="ahl-constructor">Request</span>
    <span class="ahl-keyword">class</span> &lt;&lt; <span class="ahl-variable ahl-builtin">self</span>
      <span class="ahl-function ahl-builtin">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol">:ip_filter</span>

      <span class="ahl-comment"># The priority when checking forwarded headers. The default</span>
      <span class="ahl-comment"># is &lt;tt&gt;[:forwarded, :x_forwarded]&lt;&#x2f;tt&gt;, which means, check the</span>
      <span class="ahl-comment"># +Forwarded+ header first, followed by the appropriate</span>
      <span class="ahl-comment"># &lt;tt&gt;X-Forwarded-*&lt;&#x2f;tt&gt; header.  You can revert the priority by</span>
      <span class="ahl-comment"># reversing the priority, or remove checking of either</span>
      <span class="ahl-comment"># or both headers by removing elements from the array.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># This should be set as appropriate in your environment</span>
      <span class="ahl-comment"># based on what reverse proxies are in use.  If you are not</span>
      <span class="ahl-comment"># using reverse proxies, you should probably use an empty</span>
      <span class="ahl-comment"># array.</span>
      <span class="ahl-function ahl-builtin">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol">:forwarded_priority</span>

      <span class="ahl-comment"># The priority when checking either the &lt;tt&gt;X-Forwarded-Proto&lt;&#x2f;tt&gt;</span>
      <span class="ahl-comment"># or &lt;tt&gt;X-Forwarded-Scheme&lt;&#x2f;tt&gt; header for the forwarded protocol.</span>
      <span class="ahl-comment"># The default is &lt;tt&gt;[:proto, :scheme]&lt;&#x2f;tt&gt;, to try the</span>
      <span class="ahl-comment"># &lt;tt&gt;X-Forwarded-Proto&lt;&#x2f;tt&gt; header before the</span>
      <span class="ahl-comment"># &lt;tt&gt;X-Forwarded-Scheme&lt;&#x2f;tt&gt; header.  Rack 2 had behavior</span>
      <span class="ahl-comment"># similar to &lt;tt&gt;[:scheme, :proto]&lt;&#x2f;tt&gt;.  You can remove either or</span>
      <span class="ahl-comment"># both of the entries in array to ignore that respective header.</span>
      <span class="ahl-function ahl-builtin">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded_proto_priority</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-variable ahl-other ahl-member">@forwarded_priority</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string ahl-special ahl-symbol">:forwarded</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded</span><span class="ahl-punctuation ahl-bracket">]</span>
    <span class="ahl-variable ahl-other ahl-member">@x_forwarded_proto_priority</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string ahl-special ahl-symbol">:proto</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string ahl-special ahl-symbol">:scheme</span><span class="ahl-punctuation ahl-bracket">]</span>

    <span class="ahl-variable">valid_ipv4_octet</span> <span class="ahl-operator">=</span> <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\.</span>(25[0-5]|2[0-4][0-9]|[01]?[0-9]?[0-9])&#x2f;</span>

    <span class="ahl-variable">trusted_proxies</span> <span class="ahl-operator">=</span> <span class="ahl-constructor">Regexp</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">union</span><span class="ahl-punctuation ahl-bracket">(</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>127<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special">}</span>{3}<span class="ahl-constant ahl-character escape">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span>                          <span class="ahl-comment"># localhost IPv4 range 127.x.x.x, per RFC-3330</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>::1<span class="ahl-constant ahl-character escape">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span>                                                <span class="ahl-comment"># localhost IPv6 ::1</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>f[cd][0-9a-f]{2}(?::[0-9a-f]{0,4}){0,7}<span class="ahl-constant ahl-character escape">\z</span>&#x2f;i</span><span class="ahl-punctuation ahl-delimiter">,</span>           <span class="ahl-comment"># private IPv6 range fc00 .. fdff</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>10<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special">}</span>{3}<span class="ahl-constant ahl-character escape">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span>                           <span class="ahl-comment"># private IPv4 range 10.x.x.x</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>172<span class="ahl-constant ahl-character escape">\.</span>(1[6-9]|2[0-9]|3[01])<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special">}</span>{2}<span class="ahl-constant ahl-character escape">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span>   <span class="ahl-comment"># private IPv4 range 172.16.0.0 .. 172.31.255.255</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>192<span class="ahl-constant ahl-character escape">\.</span>168<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special">}</span>{2}<span class="ahl-constant ahl-character escape">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span>                     <span class="ahl-comment"># private IPv4 range 192.168.x.x</span>
      <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>localhost<span class="ahl-constant ahl-character escape">\z</span>|<span class="ahl-constant ahl-character escape">\A</span>unix(<span class="ahl-constant ahl-character escape">\z</span>|:)&#x2f;i</span><span class="ahl-punctuation ahl-delimiter">,</span>                            <span class="ahl-comment"># localhost hostname, and unix domain sockets</span>
    <span class="ahl-punctuation ahl-bracket">)</span>

    <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">ip_filter</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">lambda</span> <span class="ahl-punctuation ahl-bracket">{</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">|</span> <span class="ahl-variable">trusted_proxies</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">match?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-punctuation ahl-bracket">}</span>

    <span class="ahl-constant">ALLOWED_SCHEMES</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">%w(</span><span class="ahl-string">https</span> <span class="ahl-string">http</span> <span class="ahl-string">wss</span> <span class="ahl-string">ws</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">freeze</span>

    <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">initialize</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">env</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-variable ahl-other ahl-member">@env</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">env</span>
      <span class="ahl-variable ahl-other ahl-member">@params</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">nil</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">params</span>
      <span class="ahl-variable ahl-other ahl-member">@params</span> <span class="ahl-operator">||=</span> <span class="ahl-function ahl-builtin">super</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">update_param</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-function ahl-builtin">super</span>
      <span class="ahl-variable ahl-other ahl-member">@params</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">nil</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">delete_param</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-variable">v</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-builtin">super</span>
      <span class="ahl-variable ahl-other ahl-member">@params</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">nil</span>
      <span class="ahl-variable">v</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-keyword">module</span> <span class="ahl-constructor">Env</span>
      <span class="ahl-comment"># The environment of the request.</span>
      <span class="ahl-function ahl-builtin">attr_reader</span> <span class="ahl-string ahl-special ahl-symbol">:env</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">initialize</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">env</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">env</span>
        <span class="ahl-comment"># This module is included at least in `ActionDispatch::Request`</span>
        <span class="ahl-comment"># The call to `super()` allows additional mixed-in initializers are called</span>
        <span class="ahl-function ahl-builtin">super</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Predicate method to test to see if `name` has been set as request</span>
      <span class="ahl-comment"># specific data</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">has_header?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">key?</span> <span class="ahl-variable ahl-parameter">name</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Get a request specific value for `name`.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># If a block is given, it yields to the block if the value hasn&#x27;t been set</span>
      <span class="ahl-comment"># on the request.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">fetch_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-delimiter">,</span> &amp;<span class="ahl-variable ahl-parameter">block</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">fetch</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-delimiter">,</span> &amp;<span class="ahl-variable ahl-parameter">block</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Loops through each key &#x2f; value pair in the request specific data.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">each_header</span><span class="ahl-punctuation ahl-bracket">(</span>&amp;<span class="ahl-variable ahl-parameter">block</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span><span class="ahl-punctuation ahl-bracket">(</span>&amp;<span class="ahl-variable ahl-parameter">block</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Set a request specific value for `name` to `v`</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">v</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Add a header that may have multiple values.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># Example:</span>
      <span class="ahl-comment">#   request.add_header &#x27;Accept&#x27;, &#x27;image&#x2f;png&#x27;</span>
      <span class="ahl-comment">#   request.add_header &#x27;Accept&#x27;, &#x27;*&#x2f;*&#x27;</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment">#   assert_equal &#x27;image&#x2f;png,*&#x2f;*&#x27;, request.get_header(&#x27;Accept&#x27;)</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># http:&#x2f;&#x2f;www.w3.org&#x2f;Protocols&#x2f;rfc2616&#x2f;rfc2616-sec4.html#sec4.2</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">add_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">nil?</span>
          <span class="ahl-function ahl-method">get_header</span> <span class="ahl-variable ahl-parameter">key</span>
        <span class="ahl-keyword ahl-control ahl-conditional">elsif</span> <span class="ahl-function ahl-method">has_header?</span> <span class="ahl-variable ahl-parameter">key</span>
          <span class="ahl-function ahl-method">set_header</span> <span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string">&quot;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-function ahl-method">get_header</span> <span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-special">}</span>,<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-special">}</span>&quot;</span>
        <span class="ahl-keyword ahl-control ahl-conditional">else</span>
          <span class="ahl-function ahl-method">set_header</span> <span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Delete a request specific value for `name`.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">delete_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">name</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">delete</span> <span class="ahl-variable ahl-parameter">name</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">initialize_copy</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">other</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-other ahl-member">@env</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">other</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">env</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">dup</span>
      <span class="ahl-keyword">end</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-keyword">module</span> <span class="ahl-constructor">Helpers</span>
      <span class="ahl-comment"># The set of form-data media-types. Requests that do not indicate</span>
      <span class="ahl-comment"># one of the media types present in this list will not be eligible</span>
      <span class="ahl-comment"># for form-data &#x2f; param parsing.</span>
      <span class="ahl-constant">FORM_DATA_MEDIA_TYPES</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">[</span>
        <span class="ahl-string">&#x27;application&#x2f;x-www-form-urlencoded&#x27;</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string">&#x27;multipart&#x2f;form-data&#x27;</span>
      <span class="ahl-punctuation ahl-bracket">]</span>

      <span class="ahl-comment"># The set of media-types. Requests that do not indicate</span>
      <span class="ahl-comment"># one of the media types present in this list will not be eligible</span>
      <span class="ahl-comment"># for param parsing like soap attachments or generic multiparts</span>
      <span class="ahl-constant">PARSEABLE_DATA_MEDIA_TYPES</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">[</span>
        <span class="ahl-string">&#x27;multipart&#x2f;related&#x27;</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string">&#x27;multipart&#x2f;mixed&#x27;</span>
      <span class="ahl-punctuation ahl-bracket">]</span>

      <span class="ahl-comment"># Default ports depending on scheme. Used to decide whether or not</span>
      <span class="ahl-comment"># to include the port in a generated URI.</span>
      <span class="ahl-constant">DEFAULT_PORTS</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">{</span> <span class="ahl-string">&#x27;http&#x27;</span> <span class="ahl-operator">=&gt;</span> <span class="ahl-constant ahl-numeric integer">80</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string">&#x27;https&#x27;</span> <span class="ahl-operator">=&gt;</span> <span class="ahl-constant ahl-numeric integer">443</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string">&#x27;coffee&#x27;</span> <span class="ahl-operator">=&gt;</span> <span class="ahl-constant ahl-numeric integer">80</span> <span class="ahl-punctuation ahl-bracket">}</span>

      <span class="ahl-comment"># The address of the client which connected to the proxy.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_FOR</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>

      <span class="ahl-comment"># The contents of the host&#x2f;:authority header sent to the proxy.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_HOST</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_HOST&#x27;</span>

      <span class="ahl-constant">HTTP_FORWARDED</span>          <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_FORWARDED&#x27;</span>

      <span class="ahl-comment"># The value of the scheme sent to the proxy.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_SCHEME</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_SCHEME&#x27;</span>

      <span class="ahl-comment"># The protocol used to connect to the proxy.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_PROTO</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_PROTO&#x27;</span>

      <span class="ahl-comment"># The port used to connect to the proxy.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_PORT</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_PORT&#x27;</span>

      <span class="ahl-comment"># Another way for specifying https scheme was used.</span>
      <span class="ahl-constant">HTTP_X_FORWARDED_SSL</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;HTTP_X_FORWARDED_SSL&#x27;</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">body</span><span class="ahl-punctuation ahl-delimiter">;</span>            <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span>                         <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">script_name</span><span class="ahl-punctuation ahl-delimiter">;</span>     <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">SCRIPT_NAME</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span>                   <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">script_name</span>=<span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">s</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">;</span> <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">SCRIPT_NAME</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">s</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span><span class="ahl-punctuation ahl-bracket">)</span>                <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">path_info</span><span class="ahl-punctuation ahl-delimiter">;</span>       <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">PATH_INFO</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span>                     <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">path_info</span>=<span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">s</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">;</span>   <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">PATH_INFO</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">s</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span><span class="ahl-punctuation ahl-bracket">)</span>                  <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">request_method</span><span class="ahl-punctuation ahl-delimiter">;</span>  <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">REQUEST_METHOD</span><span class="ahl-punctuation ahl-bracket">)</span>                     <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">query_string</span><span class="ahl-punctuation ahl-delimiter">;</span>    <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">QUERY_STRING</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span>                  <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">content_length</span><span class="ahl-punctuation ahl-delimiter">;</span>  <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;CONTENT_LENGTH&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>                   <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">logger</span><span class="ahl-punctuation ahl-delimiter">;</span>          <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_LOGGER</span><span class="ahl-punctuation ahl-bracket">)</span>                        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">user_agent</span><span class="ahl-punctuation ahl-delimiter">;</span>      <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;HTTP_USER_AGENT&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>                  <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># the referer of the client</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">referer</span><span class="ahl-punctuation ahl-delimiter">;</span>         <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;HTTP_REFERER&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>                     <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">alias</span> <span class="ahl-function ahl-method">referrer</span> <span class="ahl-function ahl-method">referer</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">session</span>
        <span class="ahl-function ahl-method">fetch_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_SESSION</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_SESSION</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">default_session</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">session_options</span>
        <span class="ahl-function ahl-method">fetch_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_SESSION_OPTIONS</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_SESSION_OPTIONS</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-punctuation ahl-bracket">{</span><span class="ahl-punctuation ahl-bracket">}</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type DELETE</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">delete?</span><span class="ahl-punctuation ahl-delimiter">;</span>  <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">DELETE</span>  <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type GET</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">get?</span><span class="ahl-punctuation ahl-delimiter">;</span>     <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">GET</span>     <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type HEAD</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">head?</span><span class="ahl-punctuation ahl-delimiter">;</span>    <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">HEAD</span>    <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type OPTIONS</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">options?</span><span class="ahl-punctuation ahl-delimiter">;</span> <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">OPTIONS</span> <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type LINK</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">link?</span><span class="ahl-punctuation ahl-delimiter">;</span>    <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">LINK</span>    <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type PATCH</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">patch?</span><span class="ahl-punctuation ahl-delimiter">;</span>   <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">PATCH</span>   <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type POST</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">post?</span><span class="ahl-punctuation ahl-delimiter">;</span>    <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">POST</span>    <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type PUT</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">put?</span><span class="ahl-punctuation ahl-delimiter">;</span>     <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">PUT</span>     <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type TRACE</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">trace?</span><span class="ahl-punctuation ahl-delimiter">;</span>   <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">TRACE</span>   <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Checks the HTTP request method (or verb) to see if it was of type UNLINK</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">unlink?</span><span class="ahl-punctuation ahl-delimiter">;</span>  <span class="ahl-function ahl-method">request_method</span> <span class="ahl-operator">==</span> <span class="ahl-constant">UNLINK</span>  <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">scheme</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTPS</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">==</span> <span class="ahl-string">&#x27;on&#x27;</span>
          <span class="ahl-string">&#x27;https&#x27;</span>
        <span class="ahl-keyword ahl-control ahl-conditional">elsif</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_X_FORWARDED_SSL</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">==</span> <span class="ahl-string">&#x27;on&#x27;</span>
          <span class="ahl-string">&#x27;https&#x27;</span>
        <span class="ahl-keyword ahl-control ahl-conditional">elsif</span> <span class="ahl-function ahl-method">forwarded_scheme</span>
          <span class="ahl-function ahl-method">forwarded_scheme</span>
        <span class="ahl-keyword ahl-control ahl-conditional">else</span>
          <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_URL_SCHEME</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The authority of the incoming request as defined by RFC3976.</span>
      <span class="ahl-comment"># https:&#x2f;&#x2f;tools.ietf.org&#x2f;html&#x2f;rfc3986#section-3.2</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># In HTTP&#x2f;1, this is the `host` header.</span>
      <span class="ahl-comment"># In HTTP&#x2f;2, this is the `:authority` pseudo-header.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">authority</span>
        <span class="ahl-function ahl-method">forwarded_authority</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">host_authority</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">server_authority</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The authority as defined by the `SERVER_NAME` and `SERVER_PORT`</span>
      <span class="ahl-comment"># variables.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">server_authority</span>
        <span class="ahl-variable">host</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">server_name</span>
        <span class="ahl-variable">port</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">server_port</span>

        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">host</span>
          <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">port</span>
            <span class="ahl-string">&quot;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">host</span><span class="ahl-punctuation ahl-special">}</span>:<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">port</span><span class="ahl-punctuation ahl-special">}</span>&quot;</span>
          <span class="ahl-keyword ahl-control ahl-conditional">else</span>
            <span class="ahl-variable">host</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">server_name</span>
        <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">SERVER_NAME</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">server_port</span>
        <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">SERVER_PORT</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">cookies</span>
        <span class="ahl-variable">hash</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">fetch_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_COOKIE_HASH</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-punctuation ahl-bracket">{</span><span class="ahl-punctuation ahl-bracket">}</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-variable">string</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_COOKIE</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional">unless</span> <span class="ahl-variable">string</span> <span class="ahl-operator">==</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_COOKIE_STRING</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-variable">hash</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">replace</span> <span class="ahl-constructor">Utils</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">parse_cookies_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">string</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_COOKIE_STRING</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">string</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-variable">hash</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">content_type</span>
        <span class="ahl-variable">content_type</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;CONTENT_TYPE&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">content_type</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">nil?</span> <span class="ahl-operator">||</span> <span class="ahl-variable">content_type</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">empty?</span> <span class="ahl-operator">?</span> <span class="ahl-constant ahl-builtin">nil</span> <span class="ahl-operator">:</span> <span class="ahl-variable">content_type</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">xhr?</span>
        <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;HTTP_X_REQUESTED_WITH&quot;</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">==</span> <span class="ahl-string">&quot;XMLHttpRequest&quot;</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The `HTTP_HOST` header.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">host_authority</span>
        <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_HOST</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">host_with_port</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">host</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">_</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">port</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">port</span> <span class="ahl-operator">==</span> <span class="ahl-constant">DEFAULT_PORTS</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">scheme</span><span class="ahl-punctuation ahl-bracket">]</span>
          <span class="ahl-variable">host</span>
        <span class="ahl-keyword ahl-control ahl-conditional">else</span>
          <span class="ahl-variable ahl-parameter">authority</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Returns a formatted host, suitable for being used in a URI.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">host</span>
        <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">authority</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-constant ahl-numeric integer">0</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Returns an address suitable for being to resolve to an address.</span>
      <span class="ahl-comment"># In the case of a domain name or IPv4 address, the result is the same</span>
      <span class="ahl-comment"># as +host+. In the case of IPv6 or future address formats, the square</span>
      <span class="ahl-comment"># brackets are removed.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">hostname</span>
        <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">authority</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">port</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">authority</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-variable">authority</span>
          <span class="ahl-variable">_</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">_</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">port</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">authority</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-variable">port</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">forwarded_port</span><span class="ahl-punctuation ahl-delimiter">&amp;.</span><span class="ahl-function ahl-method">last</span> <span class="ahl-operator">||</span> <span class="ahl-constant">DEFAULT_PORTS</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-function ahl-method">scheme</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">server_port</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">forwarded_for</span>
        <span class="ahl-function ahl-method">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">type</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional">case</span> <span class="ahl-variable ahl-parameter">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">forwarded_for</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-special ahl-symbol">:for</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded_for</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map!</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">|</span>
                <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">]</span>
              <span class="ahl-keyword">end</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">value</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_X_FORWARDED_FOR</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">value</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">|</span>
                <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">]</span>
              <span class="ahl-keyword">end</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-constant ahl-builtin">nil</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">forwarded_port</span>
        <span class="ahl-function ahl-method">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">type</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional">case</span> <span class="ahl-variable ahl-parameter">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">forwarded</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-special ahl-symbol">:for</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">|</span>
                <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-constant ahl-numeric integer">2</span><span class="ahl-punctuation ahl-bracket">]</span>
              <span class="ahl-keyword">end</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">compact</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">value</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_X_FORWARDED_PORT</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">value</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map</span><span class="ahl-punctuation ahl-bracket">(</span>&amp;<span class="ahl-string ahl-special ahl-symbol">:to_i</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-constant ahl-builtin">nil</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">forwarded_authority</span>
        <span class="ahl-function ahl-method">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">type</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional">case</span> <span class="ahl-variable ahl-parameter">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">forwarded</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-special ahl-symbol">:host</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable">forwarded</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">last</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">value</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_X_FORWARDED_HOST</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-function ahl-method">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">value</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">last</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-constant ahl-builtin">nil</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">ssl?</span>
        <span class="ahl-function ahl-method">scheme</span> <span class="ahl-operator">==</span> <span class="ahl-string">&#x27;https&#x27;</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">scheme</span> <span class="ahl-operator">==</span> <span class="ahl-string">&#x27;wss&#x27;</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">ip</span>
        <span class="ahl-variable">remote_addresses</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;REMOTE_ADDR&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">external_addresses</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">remote_addresses</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional">unless</span> <span class="ahl-variable">external_addresses</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">empty?</span>
          <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable">external_addresses</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">last</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded_for</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-variable">forwarded_for</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">&amp;&amp;</span> <span class="ahl-operator">!</span><span class="ahl-variable">forwarded_for</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">empty?</span>
          <span class="ahl-comment"># The forwarded for addresses are ordered: client, proxy1, proxy2.</span>
          <span class="ahl-comment"># So we reject all the trusted addresses (proxy*) and return the</span>
          <span class="ahl-comment"># last client. Or if we trust everyone, we just return the first</span>
          <span class="ahl-comment"># address.</span>
          <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-function ahl-method">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded_for</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">last</span> <span class="ahl-operator">||</span> <span class="ahl-variable">forwarded_for</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">first</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-comment"># If all the addresses are trusted, and we aren&#x27;t forwarded, just return</span>
        <span class="ahl-comment"># the first remote address, which represents the source of the request.</span>
        <span class="ahl-variable">remote_addresses</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">first</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The media type (type&#x2f;subtype) portion of the CONTENT_TYPE header</span>
      <span class="ahl-comment"># without any media type parameters. e.g., when CONTENT_TYPE is</span>
      <span class="ahl-comment"># &quot;text&#x2f;plain;charset=utf-8&quot;, the media-type is &quot;text&#x2f;plain&quot;.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># For more information on the use of media types in HTTP, see:</span>
      <span class="ahl-comment"># http:&#x2f;&#x2f;www.w3.org&#x2f;Protocols&#x2f;rfc2616&#x2f;rfc2616-sec3.html#sec3.7</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">media_type</span>
        <span class="ahl-constructor">MediaType</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">type</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">content_type</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The media type parameters provided in CONTENT_TYPE as a Hash, or</span>
      <span class="ahl-comment"># an empty Hash if no CONTENT_TYPE or media-type parameters were</span>
      <span class="ahl-comment"># provided.  e.g., when the CONTENT_TYPE is &quot;text&#x2f;plain;charset=utf-8&quot;,</span>
      <span class="ahl-comment"># this method responds with the following Hash:</span>
      <span class="ahl-comment">#   { &#x27;charset&#x27; =&gt; &#x27;utf-8&#x27; }</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">media_type_params</span>
        <span class="ahl-constructor">MediaType</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">params</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">content_type</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The character set of the request body if a &quot;charset&quot; media type</span>
      <span class="ahl-comment"># parameter was given, or nil if no &quot;charset&quot; was specified. Note</span>
      <span class="ahl-comment"># that, per RFC2616, text&#x2f;* media types that specify no explicit</span>
      <span class="ahl-comment"># charset are to be considered ISO-8859-1.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">content_charset</span>
        <span class="ahl-function ahl-method">media_type_params</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string">&#x27;charset&#x27;</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Determine whether the request body contains form-data by checking</span>
      <span class="ahl-comment"># the request content-type for one of the media-types:</span>
      <span class="ahl-comment"># &quot;application&#x2f;x-www-form-urlencoded&quot; or &quot;multipart&#x2f;form-data&quot;. The</span>
      <span class="ahl-comment"># list of form-data media types can be modified through the</span>
      <span class="ahl-comment"># +FORM_DATA_MEDIA_TYPES+ array.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># A request body is also assumed to contain form-data when no</span>
      <span class="ahl-comment"># content-type header is provided and the request_method is POST.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">form_data?</span>
        <span class="ahl-variable">type</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">media_type</span>
        <span class="ahl-variable">meth</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_METHODOVERRIDE_ORIGINAL_METHOD</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">REQUEST_METHOD</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">meth</span> <span class="ahl-operator">==</span> <span class="ahl-constant">POST</span> <span class="ahl-operator">&amp;&amp;</span> <span class="ahl-variable">type</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">nil?</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">||</span> <span class="ahl-constant">FORM_DATA_MEDIA_TYPES</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">include?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">type</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Determine whether the request body contains data by checking</span>
      <span class="ahl-comment"># the request media_type against registered parse-data media-types</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">parseable_data?</span>
        <span class="ahl-constant">PARSEABLE_DATA_MEDIA_TYPES</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">include?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">media_type</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Returns the data received in the query string.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">GET</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_QUERY_STRING</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">==</span> <span class="ahl-function ahl-method">query_string</span>
          <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_QUERY_HASH</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword ahl-control ahl-conditional">else</span>
          <span class="ahl-variable">query_hash</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">parse_query</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">query_string</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_QUERY_STRING</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">query_string</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_QUERY_HASH</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">query_hash</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Returns the data received in the request body.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># This method support both application&#x2f;x-www-form-urlencoded and</span>
      <span class="ahl-comment"># multipart&#x2f;form-data.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">POST</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">error</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_ERROR</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-keyword ahl-control ahl-exception">raise</span> <span class="ahl-variable">error</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">class</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">error</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">message</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string ahl-special ahl-symbol">cause</span><span class="ahl-string ahl-special ahl-symbol">:</span> <span class="ahl-variable">error</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">cause</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-keyword">begin</span>
          <span class="ahl-variable">rack_input</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span>

          <span class="ahl-comment"># If the form hash was already memoized:</span>
          <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">form_hash</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-comment"># And it was memoized from the same input:</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">equal?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">rack_input</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable">form_hash</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword">end</span>

          <span class="ahl-comment"># Otherwise, figure out how to parse the input:</span>
          <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">rack_input</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">nil?</span>
            <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-constant ahl-builtin">nil</span>
            <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-punctuation ahl-bracket">{</span><span class="ahl-punctuation ahl-bracket">}</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-keyword ahl-control ahl-conditional">elsif</span> <span class="ahl-function ahl-method">form_data?</span> <span class="ahl-operator">||</span> <span class="ahl-function ahl-method">parseable_data?</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">pairs</span> <span class="ahl-operator">=</span> <span class="ahl-constructor">Rack</span>::<span class="ahl-constructor">Multipart</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">parse_multipart</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">env</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-constructor">Rack</span>::<span class="ahl-constructor">Multipart</span>::<span class="ahl-constructor">ParamList</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_PAIRS</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">pairs</span>
              <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">expand_param_pairs</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">pairs</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword ahl-control ahl-conditional">else</span>
              <span class="ahl-variable">form_vars</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">read</span>

              <span class="ahl-comment"># Fix for Safari Ajax postings that always append \0</span>
              <span class="ahl-comment"># form_vars.sub!(&#x2f;\0\z&#x2f;, &#x27;&#x27;) # performance replacement:</span>
              <span class="ahl-variable">form_vars</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">slice!</span><span class="ahl-punctuation ahl-bracket">(</span>-<span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">form_vars</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">end_with?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;<span class="ahl-constant ahl-character escape">\0</span>&quot;</span><span class="ahl-punctuation ahl-bracket">)</span>

              <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_VARS</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">form_vars</span>
              <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">parse_query</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">form_vars</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-keyword">end</span>

            <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-function ahl-method">get_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_HASH</span>
          <span class="ahl-keyword ahl-control ahl-conditional">else</span>
            <span class="ahl-function ahl-method">set_header</span> <span class="ahl-constant">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket">)</span>
            <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-punctuation ahl-bracket">{</span><span class="ahl-punctuation ahl-bracket">}</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">rescue</span> <span class="ahl-operator">=&gt;</span> <span class="ahl-variable">error</span>
          <span class="ahl-function ahl-method">set_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">RACK_REQUEST_FORM_ERROR</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">error</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-keyword ahl-control ahl-exception">raise</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># The union of GET and POST data.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">params</span>
        <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">GET</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">merge</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">POST</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Destructively update a parameter, whether it&#x27;s in GET and&#x2f;or POST. Returns nil.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># The parameter is updated wherever it was previous defined, so GET, POST, or both. If it wasn&#x27;t previously defined, it&#x27;s inserted into GET.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># &lt;tt&gt;env[&#x27;rack.input&#x27;]&lt;&#x2f;tt&gt; is not touched.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">update_param</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">found</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">false</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">GET</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">has_key?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-variable">found</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">true</span>
          <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">GET</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">v</span>
        <span class="ahl-keyword">end</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">POST</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">has_key?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-variable">found</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-builtin">true</span>
          <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">POST</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">v</span>
        <span class="ahl-keyword">end</span>
        <span class="ahl-keyword ahl-control ahl-conditional">unless</span> <span class="ahl-variable">found</span>
          <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">GET</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">v</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Destructively delete a parameter, whether it&#x27;s in GET or POST. Returns the value of the deleted parameter.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># If the parameter is in both GET and POST, the POST value takes precedence since that&#x27;s how #params works.</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># &lt;tt&gt;env[&#x27;rack.input&#x27;]&lt;&#x2f;tt&gt; is not touched.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">delete_param</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">post_value</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">get_value</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">POST</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">delete</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">GET</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">delete</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">post_value</span> <span class="ahl-operator">||</span> <span class="ahl-variable">get_value</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">base_url</span>
        <span class="ahl-string">&quot;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-function ahl-method">scheme</span><span class="ahl-punctuation ahl-special">}</span>:&#x2f;&#x2f;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-function ahl-method">host_with_port</span><span class="ahl-punctuation ahl-special">}</span>&quot;</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Tries to return a remake of the original request URL as a string.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">url</span>
        <span class="ahl-function ahl-method">base_url</span> <span class="ahl-operator">+</span> <span class="ahl-function ahl-method">fullpath</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">path</span>
        <span class="ahl-function ahl-method">script_name</span> <span class="ahl-operator">+</span> <span class="ahl-function ahl-method">path_info</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">fullpath</span>
        <span class="ahl-function ahl-method">query_string</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">empty?</span> <span class="ahl-operator">?</span> <span class="ahl-function ahl-method">path</span> <span class="ahl-operator">:</span> <span class="ahl-string">&quot;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-function ahl-method">path</span><span class="ahl-punctuation ahl-special">}</span>?<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-function ahl-method">query_string</span><span class="ahl-punctuation ahl-special">}</span>&quot;</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">accept_encoding</span>
        <span class="ahl-function ahl-method">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;HTTP_ACCEPT_ENCODING&quot;</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">accept_language</span>
        <span class="ahl-function ahl-method">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">trusted_proxy?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-constructor">Rack</span>::<span class="ahl-constructor">Request</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">ip_filter</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">call</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># shortcut for &lt;tt&gt;request.params[key]&lt;&#x2f;tt&gt;</span>
      <span class="ahl-keyword ahl-function">def</span> []<span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-function ahl-method">warn</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;Request#[] is deprecated and will be removed in a future version of Rack. Please use request.params[] instead&quot;</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string ahl-special ahl-symbol">uplevel</span><span class="ahl-string ahl-special ahl-symbol">:</span> <span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-function ahl-method">params</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># shortcut for &lt;tt&gt;request.params[key] = value&lt;&#x2f;tt&gt;</span>
      <span class="ahl-comment">#</span>
      <span class="ahl-comment"># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="ahl-keyword ahl-function">def</span> []=<span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">value</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-function ahl-method">warn</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&quot;Request#[]= is deprecated and will be removed in a future version of Rack. Please use request.params[]= instead&quot;</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-string ahl-special ahl-symbol">uplevel</span><span class="ahl-string ahl-special ahl-symbol">:</span> <span class="ahl-constant ahl-numeric integer">1</span><span class="ahl-punctuation ahl-bracket">)</span>

        <span class="ahl-function ahl-method">params</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">value</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># like Hash#values_at</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">values_at</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">*<span class="ahl-variable ahl-parameter">keys</span></span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-parameter">keys</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map</span> <span class="ahl-punctuation ahl-bracket">{</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-bracket">|</span> <span class="ahl-function ahl-method">params</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">key</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-punctuation ahl-bracket">}</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-function ahl-builtin">private</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">default_session</span><span class="ahl-punctuation ahl-delimiter">;</span> <span class="ahl-punctuation ahl-bracket">{</span><span class="ahl-punctuation ahl-bracket">}</span><span class="ahl-punctuation ahl-delimiter">;</span> <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Assist with compatibility when processing `X-Forwarded-For`.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">host</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-comment"># Even thought IPv6 addresses should be wrapped in square brackets,</span>
        <span class="ahl-comment"># sometimes this is not done in various legacy&#x2f;underspecified headers.</span>
        <span class="ahl-comment"># So we try to fix this situation for compatibility reasons.</span>

        <span class="ahl-comment"># Try to detect IPv6 addresses which aren&#x27;t escaped yet:</span>
        <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-operator">!</span><span class="ahl-variable ahl-parameter">host</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">start_with?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;[&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">&amp;&amp;</span> <span class="ahl-variable ahl-parameter">host</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">count</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string">&#x27;:&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">&gt;</span> <span class="ahl-constant ahl-numeric integer">1</span>
          <span class="ahl-string">&quot;[<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable ahl-parameter">host</span><span class="ahl-punctuation ahl-special">}</span>]&quot;</span>
        <span class="ahl-keyword ahl-control ahl-conditional">else</span>
          <span class="ahl-variable ahl-parameter">host</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">header</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-parameter">header</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_s</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">split</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\s</span>*,<span class="ahl-constant ahl-character escape">\s</span>*&#x2f;</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">map</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">part</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-variable">attribute</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">parameters</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">part</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">split</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\s</span>*;<span class="ahl-constant ahl-character escape">\s</span>*&#x2f;</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-constant ahl-numeric integer">2</span><span class="ahl-punctuation ahl-bracket">)</span>
          <span class="ahl-variable">quality</span> <span class="ahl-operator">=</span> <span class="ahl-constant ahl-numeric integer">1.0</span>
          <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">parameters</span> <span class="ahl-keyword ahl-operator">and</span> <span class="ahl-string ahl-regexp">&#x2f;<span class="ahl-constant ahl-character escape">\A</span>q=([<span class="ahl-constant ahl-character escape">\d</span>.]+)&#x2f;</span> <span class="ahl-operator">=~</span> <span class="ahl-variable">parameters</span>
            <span class="ahl-variable">quality</span> <span class="ahl-operator">=</span> $1<span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_f</span>
          <span class="ahl-keyword">end</span>
          <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable">attribute</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">quality</span><span class="ahl-punctuation ahl-bracket">]</span>
        <span class="ahl-keyword">end</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># Get an array of values set in the RFC 7239 `Forwarded` request header.</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">token</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-constructor">Utils</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">forwarded_values</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constant">HTTP_FORWARDED</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">&amp;.</span>[]<span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">token</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">query_parser</span>
        <span class="ahl-constructor">Utils</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">default_query_parser</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">parse_query</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">qs</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">d</span> <span class="ahl-operator">=</span> <span class="ahl-string">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-function ahl-method">query_parser</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">parse_nested_query</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">qs</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">d</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">parse_multipart</span>
        <span class="ahl-constructor">Rack</span>::<span class="ahl-constructor">Multipart</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">extract_multipart</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-builtin">self</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-function ahl-method">query_parser</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">expand_param_pairs</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">pairs</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">query_parser</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">query_parser</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable">params</span> <span class="ahl-operator">=</span> <span class="ahl-variable ahl-parameter">query_parser</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">make_params</span>

        <span class="ahl-variable ahl-parameter">pairs</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-variable ahl-parameter">query_parser</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">normalize_params</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">params</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">k</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable ahl-parameter">v</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-variable">params</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">to_params_hash</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">value</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-parameter">value</span> <span class="ahl-operator">?</span> <span class="ahl-variable ahl-parameter">value</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">strip</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">split</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-regexp">&#x2f;[,<span class="ahl-constant ahl-character escape">\s</span>]+&#x2f;</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">:</span> <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-punctuation ahl-bracket">]</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-comment"># ipv6 extracted from resolv stdlib, simplified</span>
      <span class="ahl-comment"># to remove numbered match group creation.</span>
      <span class="ahl-variable">ipv6</span> <span class="ahl-operator">=</span> <span class="ahl-constructor">Regexp</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">union</span><span class="ahl-punctuation ahl-bracket">(</span>
        <span class="ahl-string ahl-regexp">&#x2f;(?:[0-9A-Fa-f]{1,4}:){7}
         [0-9A-Fa-f]{1,4}&#x2f;x</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-regexp">&#x2f;(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
         (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?&#x2f;x</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-regexp">&#x2f;(?:[0-9A-Fa-f]{1,4}:){6,6}
         <span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-regexp">&#x2f;(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
         (?:[0-9A-Fa-f]{1,4}:)*
         <span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+<span class="ahl-constant ahl-character escape">\.</span><span class="ahl-constant ahl-character escape">\d</span>+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-regexp">&#x2f;[Ff][Ee]80
         (?::[0-9A-Fa-f]{1,4}){7}
         %[-0-9A-Za-z._~]+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-regexp">&#x2f;[Ff][Ee]80:
         (?:
           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?
           |
           :(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?
         )?
         :[0-9A-Fa-f]{1,4}%[-0-9A-Za-z._~]+&#x2f;x</span><span class="ahl-punctuation ahl-bracket">)</span>

      <span class="ahl-constant">AUTHORITY</span> <span class="ahl-operator">=</span> <span class="ahl-string ahl-regexp">&#x2f;
        <span class="ahl-constant ahl-character escape">\A</span>
        (?&lt;host&gt;
          # Match IPv6 as a string of hex digits and colons in square brackets
          <span class="ahl-constant ahl-character escape">\[</span>(?&lt;address&gt;<span class="ahl-punctuation ahl-special">#{</span><span class="ahl-variable">ipv6</span><span class="ahl-punctuation ahl-special">}</span>)<span class="ahl-constant ahl-character escape">\]</span>
          |
          # Match any other printable string (except square brackets) as a hostname
          (?&lt;address&gt;[[[:graph:]&amp;&amp;[^<span class="ahl-constant ahl-character escape">\[</span><span class="ahl-constant ahl-character escape">\]</span>]]]*?)
        )
        (:(?&lt;port&gt;<span class="ahl-constant ahl-character escape">\d</span>+))?
        <span class="ahl-constant ahl-character escape">\z</span>
      &#x2f;x</span>

      <span class="ahl-function ahl-method">private_constant</span> <span class="ahl-string ahl-special ahl-symbol">:AUTHORITY</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">split_authority</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">nil?</span>
        <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-punctuation ahl-bracket">]</span> <span class="ahl-keyword ahl-control ahl-conditional">unless</span> <span class="ahl-variable">match</span> <span class="ahl-operator">=</span> <span class="ahl-constant">AUTHORITY</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-variable">match</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">authority</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable">match</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string ahl-special ahl-symbol">:host</span><span class="ahl-punctuation ahl-bracket">]</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">match</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string ahl-special ahl-symbol">:address</span><span class="ahl-punctuation ahl-bracket">]</span><span class="ahl-punctuation ahl-delimiter">,</span> <span class="ahl-variable">match</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-string ahl-special ahl-symbol">:port</span><span class="ahl-punctuation ahl-bracket">]</span><span class="ahl-punctuation ahl-delimiter">&amp;.</span><span class="ahl-function ahl-method">to_i</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">ip_addresses</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-parameter">ip_addresses</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">reject</span> <span class="ahl-punctuation ahl-bracket">{</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">|</span> <span class="ahl-function ahl-method">trusted_proxy?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">ip</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-punctuation ahl-bracket">}</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-constant">FORWARDED_SCHEME_HEADERS</span> <span class="ahl-operator">=</span> <span class="ahl-punctuation ahl-bracket">{</span>
        <span class="ahl-string ahl-special ahl-symbol">proto</span><span class="ahl-string ahl-special ahl-symbol">:</span> <span class="ahl-constant">HTTP_X_FORWARDED_PROTO</span><span class="ahl-punctuation ahl-delimiter">,</span>
        <span class="ahl-string ahl-special ahl-symbol">scheme</span><span class="ahl-string ahl-special ahl-symbol">:</span> <span class="ahl-constant">HTTP_X_FORWARDED_SCHEME</span>
      <span class="ahl-punctuation ahl-bracket">}</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">freeze</span>
      <span class="ahl-function ahl-method">private_constant</span> <span class="ahl-string ahl-special ahl-symbol">:FORWARDED_SCHEME_HEADERS</span>
      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">forwarded_scheme</span>
        <span class="ahl-function ahl-method">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">type</span><span class="ahl-punctuation ahl-bracket">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional">case</span> <span class="ahl-variable ahl-parameter">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded_proto</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-string ahl-special ahl-symbol">:proto</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span> <span class="ahl-operator">&amp;&amp;</span>
               <span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">scheme</span> <span class="ahl-operator">=</span> <span class="ahl-function ahl-method">allowed_scheme</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">forwarded_proto</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">last</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span>
              <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable">scheme</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional">when</span> <span class="ahl-string ahl-special ahl-symbol">:x_forwarded</span>
            <span class="ahl-function ahl-method">x_forwarded_proto_priority</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">x_type</span><span class="ahl-punctuation ahl-bracket">|</span>
              <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-variable">header</span> <span class="ahl-operator">=</span> <span class="ahl-constant">FORWARDED_SCHEME_HEADERS</span><span class="ahl-punctuation ahl-bracket">[</span><span class="ahl-variable ahl-parameter">x_type</span><span class="ahl-punctuation ahl-bracket">]</span>
                <span class="ahl-function ahl-method">split_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-function ahl-method">get_header</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable">header</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-bracket">)</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">reverse_each</span> <span class="ahl-keyword">do</span> <span class="ahl-punctuation ahl-bracket">|</span><span class="ahl-variable ahl-parameter">scheme</span><span class="ahl-punctuation ahl-bracket">|</span>
                  <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-function ahl-method">allowed_scheme</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">scheme</span><span class="ahl-punctuation ahl-bracket">)</span>
                    <span class="ahl-keyword ahl-control ahl-return">return</span> <span class="ahl-variable ahl-parameter">scheme</span>
                  <span class="ahl-keyword">end</span>
                <span class="ahl-keyword">end</span>
              <span class="ahl-keyword">end</span>
            <span class="ahl-keyword">end</span>
          <span class="ahl-keyword">end</span>
        <span class="ahl-keyword">end</span>

        <span class="ahl-constant ahl-builtin">nil</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">allowed_scheme</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">header</span><span class="ahl-punctuation ahl-bracket">)</span>
        <span class="ahl-variable ahl-parameter">header</span> <span class="ahl-keyword ahl-control ahl-conditional">if</span> <span class="ahl-constant">ALLOWED_SCHEMES</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">include?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-variable ahl-parameter">header</span><span class="ahl-punctuation ahl-bracket">)</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">forwarded_priority</span>
        <span class="ahl-constructor">Request</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">forwarded_priority</span>
      <span class="ahl-keyword">end</span>

      <span class="ahl-keyword ahl-function">def</span> <span class="ahl-function ahl-method">x_forwarded_proto_priority</span>
        <span class="ahl-constructor">Request</span><span class="ahl-punctuation ahl-delimiter">.</span><span class="ahl-function ahl-method">x_forwarded_proto_priority</span>
      <span class="ahl-keyword">end</span>
    <span class="ahl-keyword">end</span>

    <span class="ahl-function ahl-builtin">include</span> <span class="ahl-constructor">Env</span>
    <span class="ahl-function ahl-builtin">include</span> <span class="ahl-constructor">Helpers</span>
  <span class="ahl-keyword">end</span>
<span class="ahl-keyword">end</span>

<span class="ahl-comment"># :nocov:</span>
<span class="ahl-keyword ahl-control ahl-import">require_relative</span> <span class="ahl-string">&#x27;multipart&#x27;</span> <span class="ahl-keyword ahl-control ahl-conditional">unless</span> <span class="ahl-function ahl-builtin">defined?</span><span class="ahl-punctuation ahl-bracket">(</span><span class="ahl-constructor">Rack</span>::<span class="ahl-constructor">Multipart</span><span class="ahl-punctuation ahl-bracket">)</span>
<span class="ahl-comment"># :nocov:</span>
</code></pre>
</body>
</html>
