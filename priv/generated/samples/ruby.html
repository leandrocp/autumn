<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Autumn Sample - ruby</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
    }
    body {
      background-color: #282C34;
    }
  </style>
</head>
<body>
  <pre class="autumn highlight" class="background" style="background-color: #282C34; ">
<code class="language-ruby">
<span class="comment" style="color: #6272A4; "># frozen_string_literal: true</span>

<span class="function method" style="color: #50fa7b; ">require_relative</span> <span class="string" style="color: #f1fa8c; ">&#39;constants&#39;</span>
<span class="function method" style="color: #50fa7b; ">require_relative</span> <span class="string" style="color: #f1fa8c; ">&#39;utils&#39;</span>
<span class="function method" style="color: #50fa7b; ">require_relative</span> <span class="string" style="color: #f1fa8c; ">&#39;media_type&#39;</span>

<span class="keyword" style="color: #ff79c6; ">module</span> <span class="constructor" style="color: #BD93F9; ">Rack</span>
  <span class="comment" style="color: #6272A4; "># Rack::Request provides a convenient interface to a Rack</span>
  <span class="comment" style="color: #6272A4; "># environment.  It is stateless, the environment +env+ passed to the</span>
  <span class="comment" style="color: #6272A4; "># constructor will be directly modified.</span>
  <span class="comment" style="color: #6272A4; ">#</span>
  <span class="comment" style="color: #6272A4; ">#   req = Rack::Request.new(env)</span>
  <span class="comment" style="color: #6272A4; ">#   req.post?</span>
  <span class="comment" style="color: #6272A4; ">#   req.params[&quot;data&quot;]</span>

  <span class="keyword" style="color: #ff79c6; ">class</span> <span class="constructor" style="color: #BD93F9; ">Request</span>
    <span class="keyword" style="color: #ff79c6; ">class</span> &lt;&lt; <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span>
      <span class="function method" style="color: #50fa7b; ">attr_accessor</span> <span class="string special" style="color: #ffb86c; ">:ip_filter</span>

      <span class="comment" style="color: #6272A4; "># The priority when checking forwarded headers. The default</span>
      <span class="comment" style="color: #6272A4; "># is &lt;tt&gt;[:forwarded, :x_forwarded]&lt;/tt&gt;, which means, check the</span>
      <span class="comment" style="color: #6272A4; "># +Forwarded+ header first, followed by the appropriate</span>
      <span class="comment" style="color: #6272A4; "># &lt;tt&gt;X-Forwarded-*&lt;/tt&gt; header.  You can revert the priority by</span>
      <span class="comment" style="color: #6272A4; "># reversing the priority, or remove checking of either</span>
      <span class="comment" style="color: #6272A4; "># or both headers by removing elements from the array.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># This should be set as appropriate in your environment</span>
      <span class="comment" style="color: #6272A4; "># based on what reverse proxies are in use.  If you are not</span>
      <span class="comment" style="color: #6272A4; "># using reverse proxies, you should probably use an empty</span>
      <span class="comment" style="color: #6272A4; "># array.</span>
      <span class="function method" style="color: #50fa7b; ">attr_accessor</span> <span class="string special" style="color: #ffb86c; ">:forwarded_priority</span>

      <span class="comment" style="color: #6272A4; "># The priority when checking either the &lt;tt&gt;X-Forwarded-Proto&lt;/tt&gt;</span>
      <span class="comment" style="color: #6272A4; "># or &lt;tt&gt;X-Forwarded-Scheme&lt;/tt&gt; header for the forwarded protocol.</span>
      <span class="comment" style="color: #6272A4; "># The default is &lt;tt&gt;[:proto, :scheme]&lt;/tt&gt;, to try the</span>
      <span class="comment" style="color: #6272A4; "># &lt;tt&gt;X-Forwarded-Proto&lt;/tt&gt; header before the</span>
      <span class="comment" style="color: #6272A4; "># &lt;tt&gt;X-Forwarded-Scheme&lt;/tt&gt; header.  Rack 2 had behavior</span>
      <span class="comment" style="color: #6272A4; "># similar to &lt;tt&gt;[:scheme, :proto]&lt;/tt&gt;.  You can remove either or</span>
      <span class="comment" style="color: #6272A4; "># both of the entries in array to ignore that respective header.</span>
      <span class="function method" style="color: #50fa7b; ">attr_accessor</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded_proto_priority</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span>@forwarded_priority</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string special" style="color: #ffb86c; ">:forwarded</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
    <span>@x_forwarded_proto_priority</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string special" style="color: #ffb86c; ">:proto</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string special" style="color: #ffb86c; ">:scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>

    <span class="variable" style="color: #f8f8f2; ">valid_ipv4_octet</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string special" style="color: #ffb86c; ">/<span>\.</span>(25[0-5]|2[0-4][0-9]|[01]?[0-9]?[0-9])/</span>

    <span class="variable" style="color: #f8f8f2; ">trusted_proxies</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constructor" style="color: #BD93F9; ">Regexp</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">union</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>127<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">valid_ipv4_octet</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>{3}<span>\z</span>/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>                          <span class="comment" style="color: #6272A4; "># localhost IPv4 range 127.x.x.x, per RFC-3330</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>::1<span>\z</span>/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>                                                <span class="comment" style="color: #6272A4; "># localhost IPv6 ::1</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>f[cd][0-9a-f]{2}(?::[0-9a-f]{0,4}){0,7}<span>\z</span>/i</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>           <span class="comment" style="color: #6272A4; "># private IPv6 range fc00 .. fdff</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>10<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">valid_ipv4_octet</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>{3}<span>\z</span>/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>                           <span class="comment" style="color: #6272A4; "># private IPv4 range 10.x.x.x</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>172<span>\.</span>(1[6-9]|2[0-9]|3[01])<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">valid_ipv4_octet</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>{2}<span>\z</span>/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>   <span class="comment" style="color: #6272A4; "># private IPv4 range 172.16.0.0 .. 172.31.255.255</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>192<span>\.</span>168<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">valid_ipv4_octet</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>{2}<span>\z</span>/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>                     <span class="comment" style="color: #6272A4; "># private IPv4 range 192.168.x.x</span>
      <span class="string special" style="color: #ffb86c; ">/<span>\A</span>localhost<span>\z</span>|<span>\A</span>unix(<span>\z</span>|:)/i</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>                            <span class="comment" style="color: #6272A4; "># localhost hostname, and unix domain sockets</span>
    <span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

    <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">ip_filter</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">lambda</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span>| <span class="variable" style="color: #f8f8f2; ">trusted_proxies</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">match?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="punctuation bracket" style="color: #f8f8f2; ">}</span>

    <span class="constant" style="color: #BD93F9; ">ALLOWED_SCHEMES</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">%w(</span><span class="string" style="color: #f1fa8c; ">https</span> <span class="string" style="color: #f1fa8c; ">http</span> <span class="string" style="color: #f1fa8c; ">wss</span> <span class="string" style="color: #f1fa8c; ">ws</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">freeze</span>

    <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">initialize</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">env</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span>@env</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">env</span>
      <span>@params</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">nil</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">params</span>
      <span>@params</span> ||= <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">super</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">update_param</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">super</span>
      <span>@params</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">nil</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">delete_param</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="variable" style="color: #f8f8f2; ">v</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">super</span>
      <span>@params</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">nil</span>
      <span class="variable" style="color: #f8f8f2; ">v</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="keyword" style="color: #ff79c6; ">module</span> <span class="constructor" style="color: #BD93F9; ">Env</span>
      <span class="comment" style="color: #6272A4; "># The environment of the request.</span>
      <span class="function method" style="color: #50fa7b; ">attr_reader</span> <span class="string special" style="color: #ffb86c; ">:env</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">initialize</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">env</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">env</span>
        <span class="comment" style="color: #6272A4; "># This module is included at least in `ActionDispatch::Request`</span>
        <span class="comment" style="color: #6272A4; "># The call to `super()` allows additional mixed-in initializers are called</span>
        <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">super</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Predicate method to test to see if `name` has been set as request</span>
      <span class="comment" style="color: #6272A4; "># specific data</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">has_header?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">key?</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Get a request specific value for `name`.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># If a block is given, it yields to the block if the value hasn&#39;t been set</span>
      <span class="comment" style="color: #6272A4; "># on the request.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">fetch_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> &amp;<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">block</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">fetch</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> &amp;<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">block</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Loops through each key / value pair in the request specific data.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">each_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>&amp;<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">block</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>&amp;<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">block</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Set a request specific value for `name` to `v`</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Add a header that may have multiple values.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># Example:</span>
      <span class="comment" style="color: #6272A4; ">#   request.add_header &#39;Accept&#39;, &#39;image/png&#39;</span>
      <span class="comment" style="color: #6272A4; ">#   request.add_header &#39;Accept&#39;, &#39;*/*&#39;</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; ">#   assert_equal &#39;image/png,*/*&#39;, request.get_header(&#39;Accept&#39;)</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.2</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">add_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">nil?</span>
          <span class="function method" style="color: #50fa7b; ">get_header</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span>
        <span class="keyword" style="color: #ff79c6; ">elsif</span> <span class="function method" style="color: #50fa7b; ">has_header?</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string" style="color: #f1fa8c; ">&quot;<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="function method" style="color: #50fa7b; ">get_header</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>,<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>&quot;</span>
        <span class="keyword" style="color: #ff79c6; ">else</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Delete a request specific value for `name`.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">delete_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">delete</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">name</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">initialize_copy</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">other</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span>@env</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">other</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">dup</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="keyword" style="color: #ff79c6; ">module</span> <span class="constructor" style="color: #BD93F9; ">Helpers</span>
      <span class="comment" style="color: #6272A4; "># The set of form-data media-types. Requests that do not indicate</span>
      <span class="comment" style="color: #6272A4; "># one of the media types present in this list will not be eligible</span>
      <span class="comment" style="color: #6272A4; "># for form-data / param parsing.</span>
      <span class="constant" style="color: #BD93F9; ">FORM_DATA_MEDIA_TYPES</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span>
        <span class="string" style="color: #f1fa8c; ">&#39;application/x-www-form-urlencoded&#39;</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string" style="color: #f1fa8c; ">&#39;multipart/form-data&#39;</span>
      <span class="punctuation bracket" style="color: #f8f8f2; ">]</span>

      <span class="comment" style="color: #6272A4; "># The set of media-types. Requests that do not indicate</span>
      <span class="comment" style="color: #6272A4; "># one of the media types present in this list will not be eligible</span>
      <span class="comment" style="color: #6272A4; "># for param parsing like soap attachments or generic multiparts</span>
      <span class="constant" style="color: #BD93F9; ">PARSEABLE_DATA_MEDIA_TYPES</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span>
        <span class="string" style="color: #f1fa8c; ">&#39;multipart/related&#39;</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string" style="color: #f1fa8c; ">&#39;multipart/mixed&#39;</span>
      <span class="punctuation bracket" style="color: #f8f8f2; ">]</span>

      <span class="comment" style="color: #6272A4; "># Default ports depending on scheme. Used to decide whether or not</span>
      <span class="comment" style="color: #6272A4; "># to include the port in a generated URI.</span>
      <span class="constant" style="color: #BD93F9; ">DEFAULT_PORTS</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span> <span class="string" style="color: #f1fa8c; ">&#39;http&#39;</span> <span class="operator" style="color: #ff79c6; ">=&gt;</span> <span>80</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string" style="color: #f1fa8c; ">&#39;https&#39;</span> <span class="operator" style="color: #ff79c6; ">=&gt;</span> <span>443</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string" style="color: #f1fa8c; ">&#39;coffee&#39;</span> <span class="operator" style="color: #ff79c6; ">=&gt;</span> <span>80</span> <span class="punctuation bracket" style="color: #f8f8f2; ">}</span>

      <span class="comment" style="color: #6272A4; "># The address of the client which connected to the proxy.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_FOR</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_FOR&#39;</span>

      <span class="comment" style="color: #6272A4; "># The contents of the host/:authority header sent to the proxy.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_HOST</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_HOST&#39;</span>

      <span class="constant" style="color: #BD93F9; ">HTTP_FORWARDED</span>          <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_FORWARDED&#39;</span>

      <span class="comment" style="color: #6272A4; "># The value of the scheme sent to the proxy.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_SCHEME</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_SCHEME&#39;</span>

      <span class="comment" style="color: #6272A4; "># The protocol used to connect to the proxy.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_PROTO</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_PROTO&#39;</span>

      <span class="comment" style="color: #6272A4; "># The port used to connect to the proxy.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_PORT</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_PORT&#39;</span>

      <span class="comment" style="color: #6272A4; "># Another way for specifying https scheme was used.</span>
      <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_SSL</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;HTTP_X_FORWARDED_SSL&#39;</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">body</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>            <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                         <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">script_name</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>     <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">SCRIPT_NAME</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span>                   <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">script_name</span><span class="operator" style="color: #ff79c6; ">=</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">s</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span> <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">SCRIPT_NAME</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">s</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">path_info</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>       <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">PATH_INFO</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span>                     <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">path_info</span><span class="operator" style="color: #ff79c6; ">=</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">s</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>   <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">PATH_INFO</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">s</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                  <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">request_method</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>  <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">REQUEST_METHOD</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                     <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">query_string</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>    <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">QUERY_STRING</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span>                  <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">content_length</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>  <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;CONTENT_LENGTH&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                   <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">logger</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>          <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_LOGGER</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">user_agent</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>      <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;HTTP_USER_AGENT&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                  <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># the referer of the client</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">referer</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>         <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;HTTP_REFERER&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>                     <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">alias</span> <span class="function method" style="color: #50fa7b; ">referrer</span> <span class="function method" style="color: #50fa7b; ">referer</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">session</span>
        <span class="function method" style="color: #50fa7b; ">fetch_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_SESSION</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span>|
          <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_SESSION</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">default_session</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">session_options</span>
        <span class="function method" style="color: #50fa7b; ">fetch_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_SESSION_OPTIONS</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span>|
          <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_SESSION_OPTIONS</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span><span class="punctuation bracket" style="color: #f8f8f2; ">}</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type DELETE</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">delete?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>  <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">DELETE</span>  <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type GET</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">get?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>     <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">GET</span>     <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type HEAD</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">head?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>    <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">HEAD</span>    <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type OPTIONS</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">options?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span> <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">OPTIONS</span> <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type LINK</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">link?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>    <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">LINK</span>    <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type PATCH</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">patch?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>   <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">PATCH</span>   <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type POST</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">post?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>    <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">POST</span>    <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type PUT</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">put?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>     <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">PUT</span>     <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type TRACE</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">trace?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>   <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">TRACE</span>   <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Checks the HTTP request method (or verb) to see if it was of type UNLINK</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">unlink?</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span>  <span class="function method" style="color: #50fa7b; ">request_method</span> == <span class="constant" style="color: #BD93F9; ">UNLINK</span>  <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">scheme</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTPS</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> == <span class="string" style="color: #f1fa8c; ">&#39;on&#39;</span>
          <span class="string" style="color: #f1fa8c; ">&#39;https&#39;</span>
        <span class="keyword" style="color: #ff79c6; ">elsif</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_SSL</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> == <span class="string" style="color: #f1fa8c; ">&#39;on&#39;</span>
          <span class="string" style="color: #f1fa8c; ">&#39;https&#39;</span>
        <span class="keyword" style="color: #ff79c6; ">elsif</span> <span class="function method" style="color: #50fa7b; ">forwarded_scheme</span>
          <span class="function method" style="color: #50fa7b; ">forwarded_scheme</span>
        <span class="keyword" style="color: #ff79c6; ">else</span>
          <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_URL_SCHEME</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The authority of the incoming request as defined by RFC3976.</span>
      <span class="comment" style="color: #6272A4; "># https://tools.ietf.org/html/rfc3986#section-3.2</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># In HTTP/1, this is the `host` header.</span>
      <span class="comment" style="color: #6272A4; "># In HTTP/2, this is the `:authority` pseudo-header.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">authority</span>
        <span class="function method" style="color: #50fa7b; ">forwarded_authority</span> || <span class="function method" style="color: #50fa7b; ">host_authority</span> || <span class="function method" style="color: #50fa7b; ">server_authority</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The authority as defined by the `SERVER_NAME` and `SERVER_PORT`</span>
      <span class="comment" style="color: #6272A4; "># variables.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">server_authority</span>
        <span class="variable" style="color: #f8f8f2; ">host</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">server_name</span>
        <span class="variable" style="color: #f8f8f2; ">port</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">server_port</span>

        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">host</span>
          <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">port</span>
            <span class="string" style="color: #f1fa8c; ">&quot;<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">host</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>:<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">port</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>&quot;</span>
          <span class="keyword" style="color: #ff79c6; ">else</span>
            <span class="variable" style="color: #f8f8f2; ">host</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">server_name</span>
        <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">SERVER_NAME</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">server_port</span>
        <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">SERVER_PORT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">cookies</span>
        <span class="variable" style="color: #f8f8f2; ">hash</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">fetch_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_COOKIE_HASH</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span>|
          <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span><span class="punctuation bracket" style="color: #f8f8f2; ">}</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="variable" style="color: #f8f8f2; ">string</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_COOKIE</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="keyword" style="color: #ff79c6; ">unless</span> <span class="variable" style="color: #f8f8f2; ">string</span> == <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_COOKIE_STRING</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="variable" style="color: #f8f8f2; ">hash</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">replace</span> <span class="constructor" style="color: #BD93F9; ">Utils</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">parse_cookies_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">string</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_COOKIE_STRING</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">string</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="variable" style="color: #f8f8f2; ">hash</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">content_type</span>
        <span class="variable" style="color: #f8f8f2; ">content_type</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;CONTENT_TYPE&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">content_type</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">nil?</span> || <span class="variable" style="color: #f8f8f2; ">content_type</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">empty?</span> ? <span class="constant builtin" style="color: #BD93F9; ">nil</span> : <span class="variable" style="color: #f8f8f2; ">content_type</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">xhr?</span>
        <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;HTTP_X_REQUESTED_WITH&quot;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> == <span class="string" style="color: #f1fa8c; ">&quot;XMLHttpRequest&quot;</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The `HTTP_HOST` header.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">host_authority</span>
        <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_HOST</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">host_with_port</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">host</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">_</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">port</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">port</span> == <span class="constant" style="color: #BD93F9; ">DEFAULT_PORTS</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
          <span class="variable" style="color: #f8f8f2; ">host</span>
        <span class="keyword" style="color: #ff79c6; ">else</span>
          <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Returns a formatted host, suitable for being used in a URI.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">host</span>
        <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span>0</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Returns an address suitable for being to resolve to an address.</span>
      <span class="comment" style="color: #6272A4; "># In the case of a domain name or IPv4 address, the result is the same</span>
      <span class="comment" style="color: #6272A4; "># as +host+. In the case of IPv6 or future address formats, the square</span>
      <span class="comment" style="color: #6272A4; "># brackets are removed.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">hostname</span>
        <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">port</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">authority</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="variable" style="color: #f8f8f2; ">authority</span>
          <span class="variable" style="color: #f8f8f2; ">_</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">_</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">port</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="variable" style="color: #f8f8f2; ">port</span> || <span class="function method" style="color: #50fa7b; ">forwarded_port</span>&amp;.<span class="function method" style="color: #50fa7b; ">last</span> || <span class="constant" style="color: #BD93F9; ">DEFAULT_PORTS</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="function method" style="color: #50fa7b; ">scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> || <span class="function method" style="color: #50fa7b; ">server_port</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">forwarded_for</span>
        <span class="function method" style="color: #50fa7b; ">forwarded_priority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>|
          <span class="keyword" style="color: #ff79c6; ">case</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">forwarded_for</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_http_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">:for</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded_for</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map!</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span>|
                <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
              <span class="keyword" style="color: #ff79c6; ">end</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">value</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_FOR</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">value</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span>|
                <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">wrap_ipv6</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
              <span class="keyword" style="color: #ff79c6; ">end</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="constant builtin" style="color: #BD93F9; ">nil</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">forwarded_port</span>
        <span class="function method" style="color: #50fa7b; ">forwarded_priority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>|
          <span class="keyword" style="color: #ff79c6; ">case</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">forwarded</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_http_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">:for</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span>|
                <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span>2</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
              <span class="keyword" style="color: #ff79c6; ">end</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">compact</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">value</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_PORT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span> <span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">value</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>&amp;<span class="string special" style="color: #ffb86c; ">:to_i</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="constant builtin" style="color: #BD93F9; ">nil</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">forwarded_authority</span>
        <span class="function method" style="color: #50fa7b; ">forwarded_priority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>|
          <span class="keyword" style="color: #ff79c6; ">case</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">forwarded</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_http_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">:host</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable" style="color: #f8f8f2; ">forwarded</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">last</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">value</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_HOST</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span> <span class="function method" style="color: #50fa7b; ">wrap_ipv6</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">value</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">last</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="constant builtin" style="color: #BD93F9; ">nil</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">ssl?</span>
        <span class="function method" style="color: #50fa7b; ">scheme</span> == <span class="string" style="color: #f1fa8c; ">&#39;https&#39;</span> || <span class="function method" style="color: #50fa7b; ">scheme</span> == <span class="string" style="color: #f1fa8c; ">&#39;wss&#39;</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">ip</span>
        <span class="variable" style="color: #f8f8f2; ">remote_addresses</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;REMOTE_ADDR&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">external_addresses</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">reject_trusted_ip_addresses</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">remote_addresses</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="keyword" style="color: #ff79c6; ">unless</span> <span class="variable" style="color: #f8f8f2; ">external_addresses</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">empty?</span>
          <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable" style="color: #f8f8f2; ">external_addresses</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">last</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded_for</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="variable" style="color: #f8f8f2; ">forwarded_for</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> &amp;&amp; !<span class="variable" style="color: #f8f8f2; ">forwarded_for</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">empty?</span>
          <span class="comment" style="color: #6272A4; "># The forwarded for addresses are ordered: client, proxy1, proxy2.</span>
          <span class="comment" style="color: #6272A4; "># So we reject all the trusted addresses (proxy*) and return the</span>
          <span class="comment" style="color: #6272A4; "># last client. Or if we trust everyone, we just return the first</span>
          <span class="comment" style="color: #6272A4; "># address.</span>
          <span class="keyword" style="color: #ff79c6; ">return</span> <span class="function method" style="color: #50fa7b; ">reject_trusted_ip_addresses</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded_for</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">last</span> || <span class="variable" style="color: #f8f8f2; ">forwarded_for</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">first</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="comment" style="color: #6272A4; "># If all the addresses are trusted, and we aren&#39;t forwarded, just return</span>
        <span class="comment" style="color: #6272A4; "># the first remote address, which represents the source of the request.</span>
        <span class="variable" style="color: #f8f8f2; ">remote_addresses</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">first</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The media type (type/subtype) portion of the CONTENT_TYPE header</span>
      <span class="comment" style="color: #6272A4; "># without any media type parameters. e.g., when CONTENT_TYPE is</span>
      <span class="comment" style="color: #6272A4; "># &quot;text/plain;charset=utf-8&quot;, the media-type is &quot;text/plain&quot;.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># For more information on the use of media types in HTTP, see:</span>
      <span class="comment" style="color: #6272A4; "># http://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.7</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">media_type</span>
        <span class="constructor" style="color: #BD93F9; ">MediaType</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">type</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">content_type</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The media type parameters provided in CONTENT_TYPE as a Hash, or</span>
      <span class="comment" style="color: #6272A4; "># an empty Hash if no CONTENT_TYPE or media-type parameters were</span>
      <span class="comment" style="color: #6272A4; "># provided.  e.g., when the CONTENT_TYPE is &quot;text/plain;charset=utf-8&quot;,</span>
      <span class="comment" style="color: #6272A4; "># this method responds with the following Hash:</span>
      <span class="comment" style="color: #6272A4; ">#   { &#39;charset&#39; =&gt; &#39;utf-8&#39; }</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">media_type_params</span>
        <span class="constructor" style="color: #BD93F9; ">MediaType</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">params</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">content_type</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The character set of the request body if a &quot;charset&quot; media type</span>
      <span class="comment" style="color: #6272A4; "># parameter was given, or nil if no &quot;charset&quot; was specified. Note</span>
      <span class="comment" style="color: #6272A4; "># that, per RFC2616, text/* media types that specify no explicit</span>
      <span class="comment" style="color: #6272A4; "># charset are to be considered ISO-8859-1.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">content_charset</span>
        <span class="function method" style="color: #50fa7b; ">media_type_params</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string" style="color: #f1fa8c; ">&#39;charset&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Determine whether the request body contains form-data by checking</span>
      <span class="comment" style="color: #6272A4; "># the request content-type for one of the media-types:</span>
      <span class="comment" style="color: #6272A4; "># &quot;application/x-www-form-urlencoded&quot; or &quot;multipart/form-data&quot;. The</span>
      <span class="comment" style="color: #6272A4; "># list of form-data media types can be modified through the</span>
      <span class="comment" style="color: #6272A4; "># +FORM_DATA_MEDIA_TYPES+ array.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># A request body is also assumed to contain form-data when no</span>
      <span class="comment" style="color: #6272A4; "># content-type header is provided and the request_method is POST.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">form_data?</span>
        <span class="variable" style="color: #f8f8f2; ">type</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">media_type</span>
        <span class="variable" style="color: #f8f8f2; ">meth</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_METHODOVERRIDE_ORIGINAL_METHOD</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> || <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">REQUEST_METHOD</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">meth</span> == <span class="constant" style="color: #BD93F9; ">POST</span> &amp;&amp; <span class="variable" style="color: #f8f8f2; ">type</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">nil?</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> || <span class="constant" style="color: #BD93F9; ">FORM_DATA_MEDIA_TYPES</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">include?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">type</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Determine whether the request body contains data by checking</span>
      <span class="comment" style="color: #6272A4; "># the request media_type against registered parse-data media-types</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">parseable_data?</span>
        <span class="constant" style="color: #BD93F9; ">PARSEABLE_DATA_MEDIA_TYPES</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">include?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">media_type</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Returns the data received in the query string.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">GET</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_QUERY_STRING</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> == <span class="function method" style="color: #50fa7b; ">query_string</span>
          <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_QUERY_HASH</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">else</span>
          <span class="variable" style="color: #f8f8f2; ">query_hash</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">parse_query</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">query_string</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string" style="color: #f1fa8c; ">&#39;&amp;&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_QUERY_STRING</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">query_string</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_QUERY_HASH</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">query_hash</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Returns the data received in the request body.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># This method support both application/x-www-form-urlencoded and</span>
      <span class="comment" style="color: #6272A4; "># multipart/form-data.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">POST</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">error</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_ERROR</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="function method" style="color: #50fa7b; ">raise</span> <span class="variable" style="color: #f8f8f2; ">error</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">class</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">error</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">message</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string special" style="color: #ffb86c; ">cause</span>: <span class="variable" style="color: #f8f8f2; ">error</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">cause</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="keyword" style="color: #ff79c6; ">begin</span>
          <span class="variable" style="color: #f8f8f2; ">rack_input</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

          <span class="comment" style="color: #6272A4; "># If the form hash was already memoized:</span>
          <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">form_hash</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="comment" style="color: #6272A4; "># And it was memoized from the same input:</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">equal?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">rack_input</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable" style="color: #f8f8f2; ">form_hash</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>

          <span class="comment" style="color: #6272A4; "># Otherwise, figure out how to parse the input:</span>
          <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">rack_input</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">nil?</span>
            <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_INPUT</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="constant builtin" style="color: #BD93F9; ">nil</span>
            <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span><span class="punctuation bracket" style="color: #f8f8f2; ">}</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="keyword" style="color: #ff79c6; ">elsif</span> <span class="function method" style="color: #50fa7b; ">form_data?</span> || <span class="function method" style="color: #50fa7b; ">parseable_data?</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">pairs</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constructor" style="color: #BD93F9; ">Rack</span>::<span class="constructor" style="color: #BD93F9; ">Multipart</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">parse_multipart</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">env</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="constructor" style="color: #BD93F9; ">Rack</span>::<span class="constructor" style="color: #BD93F9; ">Multipart</span>::<span class="constructor" style="color: #BD93F9; ">ParamList</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_PAIRS</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">pairs</span>
              <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">expand_param_pairs</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">pairs</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">else</span>
              <span class="variable" style="color: #f8f8f2; ">form_vars</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">read</span>

              <span class="comment" style="color: #6272A4; "># Fix for Safari Ajax postings that always append \0</span>
              <span class="comment" style="color: #6272A4; "># form_vars.sub!(/\0\z/, &#39;&#39;) # performance replacement:</span>
              <span class="variable" style="color: #f8f8f2; ">form_vars</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">slice!</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>-<span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">form_vars</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">end_with?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;<span>\0</span>&quot;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

              <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_VARS</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">form_vars</span>
              <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">parse_query</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">form_vars</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string" style="color: #f1fa8c; ">&#39;&amp;&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>

            <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_INPUT</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="function method" style="color: #50fa7b; ">get_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span>
          <span class="keyword" style="color: #ff79c6; ">else</span>
            <span class="function method" style="color: #50fa7b; ">set_header</span> <span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_INPUT</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_INPUT</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
            <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_HASH</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span><span class="punctuation bracket" style="color: #f8f8f2; ">}</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">rescue</span> <span class="operator" style="color: #ff79c6; ">=&gt;</span> <span class="variable" style="color: #f8f8f2; ">error</span>
          <span class="function method" style="color: #50fa7b; ">set_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">RACK_REQUEST_FORM_ERROR</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">error</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="function method" style="color: #50fa7b; ">raise</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># The union of GET and POST data.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">params</span>
        <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">GET</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">merge</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">POST</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Destructively update a parameter, whether it&#39;s in GET and/or POST. Returns nil.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># The parameter is updated wherever it was previous defined, so GET, POST, or both. If it wasn&#39;t previously defined, it&#39;s inserted into GET.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># &lt;tt&gt;env[&#39;rack.input&#39;]&lt;/tt&gt; is not touched.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">update_param</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">found</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">false</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">GET</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">has_key?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="variable" style="color: #f8f8f2; ">found</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">true</span>
          <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">GET</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">POST</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">has_key?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="variable" style="color: #f8f8f2; ">found</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant builtin" style="color: #BD93F9; ">true</span>
          <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">POST</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">unless</span> <span class="variable" style="color: #f8f8f2; ">found</span>
          <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">GET</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Destructively delete a parameter, whether it&#39;s in GET or POST. Returns the value of the deleted parameter.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># If the parameter is in both GET and POST, the POST value takes precedence since that&#39;s how #params works.</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># &lt;tt&gt;env[&#39;rack.input&#39;]&lt;/tt&gt; is not touched.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">delete_param</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">post_value</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">get_value</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">POST</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">delete</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">GET</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">delete</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">post_value</span> || <span class="variable" style="color: #f8f8f2; ">get_value</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">base_url</span>
        <span class="string" style="color: #f1fa8c; ">&quot;<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="function method" style="color: #50fa7b; ">scheme</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>://<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="function method" style="color: #50fa7b; ">host_with_port</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>&quot;</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Tries to return a remake of the original request URL as a string.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">url</span>
        <span class="function method" style="color: #50fa7b; ">base_url</span> + <span class="function method" style="color: #50fa7b; ">fullpath</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">path</span>
        <span class="function method" style="color: #50fa7b; ">script_name</span> + <span class="function method" style="color: #50fa7b; ">path_info</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">fullpath</span>
        <span class="function method" style="color: #50fa7b; ">query_string</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">empty?</span> ? <span class="function method" style="color: #50fa7b; ">path</span> : <span class="string" style="color: #f1fa8c; ">&quot;<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="function method" style="color: #50fa7b; ">path</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>?<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="function method" style="color: #50fa7b; ">query_string</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>&quot;</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">accept_encoding</span>
        <span class="function method" style="color: #50fa7b; ">parse_http_accept_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;HTTP_ACCEPT_ENCODING&quot;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">accept_language</span>
        <span class="function method" style="color: #50fa7b; ">parse_http_accept_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">trusted_proxy?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="constructor" style="color: #BD93F9; ">Rack</span>::<span class="constructor" style="color: #BD93F9; ">Request</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">ip_filter</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">call</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># shortcut for &lt;tt&gt;request.params[key]&lt;/tt&gt;</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> []<span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="function method" style="color: #50fa7b; ">warn</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;Request#[] is deprecated and will be removed in a future version of Rack. Please use request.params[] instead&quot;</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string special" style="color: #ffb86c; ">uplevel</span>: <span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="function method" style="color: #50fa7b; ">params</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># shortcut for &lt;tt&gt;request.params[key] = value&lt;/tt&gt;</span>
      <span class="comment" style="color: #6272A4; ">#</span>
      <span class="comment" style="color: #6272A4; "># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> []=<span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">value</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="function method" style="color: #50fa7b; ">warn</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&quot;Request#[]= is deprecated and will be removed in a future version of Rack. Please use request.params[]= instead&quot;</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="string special" style="color: #ffb86c; ">uplevel</span>: <span>1</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

        <span class="function method" style="color: #50fa7b; ">params</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">value</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># like Hash#values_at</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">values_at</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>*<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">keys</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">keys</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span>| <span class="function method" style="color: #50fa7b; ">params</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">key</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="punctuation bracket" style="color: #f8f8f2; ">}</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">private</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">default_session</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span><span class="punctuation bracket" style="color: #f8f8f2; ">}</span><span class="punctuation delimiter" style="color: #f8f8f2; ">;</span> <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Assist with compatibility when processing `X-Forwarded-For`.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">wrap_ipv6</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">host</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="comment" style="color: #6272A4; "># Even thought IPv6 addresses should be wrapped in square brackets,</span>
        <span class="comment" style="color: #6272A4; "># sometimes this is not done in various legacy/underspecified headers.</span>
        <span class="comment" style="color: #6272A4; "># So we try to fix this situation for compatibility reasons.</span>

        <span class="comment" style="color: #6272A4; "># Try to detect IPv6 addresses which aren&#39;t escaped yet:</span>
        <span class="keyword" style="color: #ff79c6; ">if</span> !<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">host</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">start_with?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;[&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> &amp;&amp; <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">host</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">count</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string" style="color: #f1fa8c; ">&#39;:&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> &gt; <span>1</span>
          <span class="string" style="color: #f1fa8c; ">&quot;[<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">host</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>]&quot;</span>
        <span class="keyword" style="color: #ff79c6; ">else</span>
          <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">host</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">parse_http_accept_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">header</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">header</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_s</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">split</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">/<span>\s</span>*,<span>\s</span>*/</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">map</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">part</span>|
          <span class="variable" style="color: #f8f8f2; ">attribute</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">parameters</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">part</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">split</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">/<span>\s</span>*;<span>\s</span>*/</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span>2</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
          <span class="variable" style="color: #f8f8f2; ">quality</span> <span class="operator" style="color: #ff79c6; ">=</span> <span>1.0</span>
          <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">parameters</span> <span class="keyword" style="color: #ff79c6; ">and</span> <span class="string special" style="color: #ffb86c; ">/<span>\A</span>q=([<span>\d</span>.]+)/</span> =~ <span class="variable" style="color: #f8f8f2; ">parameters</span>
            <span class="variable" style="color: #f8f8f2; ">quality</span> <span class="operator" style="color: #ff79c6; ">=</span> $1<span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_f</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable" style="color: #f8f8f2; ">attribute</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">quality</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># Get an array of values set in the RFC 7239 `Forwarded` request header.</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">get_http_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">token</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="constructor" style="color: #BD93F9; ">Utils</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">forwarded_values</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constant" style="color: #BD93F9; ">HTTP_FORWARDED</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>&amp;.[]<span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">token</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">query_parser</span>
        <span class="constructor" style="color: #BD93F9; ">Utils</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">default_query_parser</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">parse_query</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">qs</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">d</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string" style="color: #f1fa8c; ">&#39;&amp;&#39;</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="function method" style="color: #50fa7b; ">query_parser</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">parse_nested_query</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">qs</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">d</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">parse_multipart</span>
        <span class="constructor" style="color: #BD93F9; ">Rack</span>::<span class="constructor" style="color: #BD93F9; ">Multipart</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">extract_multipart</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable builtin" style="text-decoration: underline; color: #BD93F9; ">self</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="function method" style="color: #50fa7b; ">query_parser</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">expand_param_pairs</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">pairs</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">query_parser</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">query_parser</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable" style="color: #f8f8f2; ">params</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">query_parser</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">make_params</span>

        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">pairs</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span>|
          <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">query_parser</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">normalize_params</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">params</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">k</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">v</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="variable" style="color: #f8f8f2; ">params</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">to_params_hash</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">value</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">value</span> ? <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">value</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">strip</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">split</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">/[,<span>\s</span>]+/</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> : <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="comment" style="color: #6272A4; "># ipv6 extracted from resolv stdlib, simplified</span>
      <span class="comment" style="color: #6272A4; "># to remove numbered match group creation.</span>
      <span class="variable" style="color: #f8f8f2; ">ipv6</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constructor" style="color: #BD93F9; ">Regexp</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">union</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span>
        <span class="string special" style="color: #ffb86c; ">/(?:[0-9A-Fa-f]{1,4}:){7}</span>
<span class="string special" style="color: #ffb86c; ">         [0-9A-Fa-f]{1,4}/x</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">/(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::</span>
<span class="string special" style="color: #ffb86c; ">         (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?/x</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">/(?:[0-9A-Fa-f]{1,4}:){6,6}</span>
<span class="string special" style="color: #ffb86c; ">         <span>\d</span>+<span>\.</span><span>\d</span>+<span>\.</span><span>\d</span>+<span>\.</span><span>\d</span>+/x</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">/(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::</span>
<span class="string special" style="color: #ffb86c; ">         (?:[0-9A-Fa-f]{1,4}:)*</span>
<span class="string special" style="color: #ffb86c; ">         <span>\d</span>+<span>\.</span><span>\d</span>+<span>\.</span><span>\d</span>+<span>\.</span><span>\d</span>+/x</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">/[Ff][Ee]80</span>
<span class="string special" style="color: #ffb86c; ">         (?::[0-9A-Fa-f]{1,4}){7}</span>
<span class="string special" style="color: #ffb86c; ">         %[-0-9A-Za-z._~]+/x</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">/[Ff][Ee]80:</span>
<span class="string special" style="color: #ffb86c; ">         (?:</span>
<span class="string special" style="color: #ffb86c; ">           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::</span>
<span class="string special" style="color: #ffb86c; ">           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?</span>
<span class="string special" style="color: #ffb86c; ">           |</span>
<span class="string special" style="color: #ffb86c; ">           :(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?</span>
<span class="string special" style="color: #ffb86c; ">         )?</span>
<span class="string special" style="color: #ffb86c; ">         :[0-9A-Fa-f]{1,4}%[-0-9A-Za-z._~]+/x</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>

      <span class="constant" style="color: #BD93F9; ">AUTHORITY</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="string special" style="color: #ffb86c; ">/</span>
<span class="string special" style="color: #ffb86c; ">        <span>\A</span></span>
<span class="string special" style="color: #ffb86c; ">        (?&lt;host&gt;</span>
<span class="string special" style="color: #ffb86c; ">          # Match IPv6 as a string of hex digits and colons in square brackets</span>
<span class="string special" style="color: #ffb86c; ">          <span>\[</span>(?&lt;address&gt;<span><span class="punctuation special" style="color: #ff79c6; ">#{</span><span class="variable" style="color: #f8f8f2; ">ipv6</span><span class="punctuation special" style="color: #ff79c6; ">}</span></span>)<span>\]</span></span>
<span class="string special" style="color: #ffb86c; ">          |</span>
<span class="string special" style="color: #ffb86c; ">          # Match any other printable string (except square brackets) as a hostname</span>
<span class="string special" style="color: #ffb86c; ">          (?&lt;address&gt;[[[:graph:]&amp;&amp;[^<span>\[</span><span>\]</span>]]]*?)</span>
<span class="string special" style="color: #ffb86c; ">        )</span>
<span class="string special" style="color: #ffb86c; ">        (:(?&lt;port&gt;<span>\d</span>+))?</span>
<span class="string special" style="color: #ffb86c; ">        <span>\z</span></span>
<span class="string special" style="color: #ffb86c; ">      /x</span>

      <span class="function method" style="color: #50fa7b; ">private_constant</span> <span class="string special" style="color: #ffb86c; ">:AUTHORITY</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">split_authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">return</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">nil?</span>
        <span class="keyword" style="color: #ff79c6; ">return</span> <span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span> <span class="keyword" style="color: #ff79c6; ">unless</span> <span class="variable" style="color: #f8f8f2; ">match</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant" style="color: #BD93F9; ">AUTHORITY</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="variable" style="color: #f8f8f2; ">match</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">authority</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable" style="color: #f8f8f2; ">match</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string special" style="color: #ffb86c; ">:host</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">match</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string special" style="color: #ffb86c; ">:address</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span> <span class="variable" style="color: #f8f8f2; ">match</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="string special" style="color: #ffb86c; ">:port</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>&amp;.<span class="function method" style="color: #50fa7b; ">to_i</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">reject_trusted_ip_addresses</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip_addresses</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip_addresses</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">reject</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span>| <span class="function method" style="color: #50fa7b; ">trusted_proxy?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">ip</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> <span class="punctuation bracket" style="color: #f8f8f2; ">}</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="constant" style="color: #BD93F9; ">FORWARDED_SCHEME_HEADERS</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="punctuation bracket" style="color: #f8f8f2; ">{</span>
        <span class="string special" style="color: #ffb86c; ">proto</span>: <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_PROTO</span><span class="punctuation delimiter" style="color: #f8f8f2; ">,</span>
        <span class="string special" style="color: #ffb86c; ">scheme</span>: <span class="constant" style="color: #BD93F9; ">HTTP_X_FORWARDED_SCHEME</span>
      <span class="punctuation bracket" style="color: #f8f8f2; ">}</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">freeze</span>
      <span class="function method" style="color: #50fa7b; ">private_constant</span> <span class="string special" style="color: #ffb86c; ">:FORWARDED_SCHEME_HEADERS</span>
      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">forwarded_scheme</span>
        <span class="function method" style="color: #50fa7b; ">forwarded_priority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>|
          <span class="keyword" style="color: #ff79c6; ">case</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">type</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:forwarded</span>
            <span class="keyword" style="color: #ff79c6; ">if</span> <span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded_proto</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">get_http_forwarded</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="string special" style="color: #ffb86c; ">:proto</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span> &amp;&amp;
               <span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">scheme</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="function method" style="color: #50fa7b; ">allowed_scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">forwarded_proto</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">last</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
              <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable" style="color: #f8f8f2; ">scheme</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">when</span> <span class="string special" style="color: #ffb86c; ">:x_forwarded</span>
            <span class="function method" style="color: #50fa7b; ">x_forwarded_proto_priority</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">x_type</span>|
              <span class="keyword" style="color: #ff79c6; ">if</span> <span class="variable" style="color: #f8f8f2; ">header</span> <span class="operator" style="color: #ff79c6; ">=</span> <span class="constant" style="color: #BD93F9; ">FORWARDED_SCHEME_HEADERS</span><span class="punctuation bracket" style="color: #f8f8f2; ">[</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">x_type</span><span class="punctuation bracket" style="color: #f8f8f2; ">]</span>
                <span class="function method" style="color: #50fa7b; ">split_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="function method" style="color: #50fa7b; ">get_header</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable" style="color: #f8f8f2; ">header</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">reverse_each</span> <span class="keyword" style="color: #ff79c6; ">do</span> |<span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">scheme</span>|
                  <span class="keyword" style="color: #ff79c6; ">if</span> <span class="function method" style="color: #50fa7b; ">allowed_scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
                    <span class="keyword" style="color: #ff79c6; ">return</span> <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">scheme</span>
                  <span class="keyword" style="color: #ff79c6; ">end</span>
                <span class="keyword" style="color: #ff79c6; ">end</span>
              <span class="keyword" style="color: #ff79c6; ">end</span>
            <span class="keyword" style="color: #ff79c6; ">end</span>
          <span class="keyword" style="color: #ff79c6; ">end</span>
        <span class="keyword" style="color: #ff79c6; ">end</span>

        <span class="constant builtin" style="color: #BD93F9; ">nil</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">allowed_scheme</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">header</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
        <span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">header</span> <span class="keyword" style="color: #ff79c6; ">if</span> <span class="constant" style="color: #BD93F9; ">ALLOWED_SCHEMES</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">include?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="variable parameter" style="text-decoration: underline; color: #ffb86c; ">header</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">forwarded_priority</span>
        <span class="constructor" style="color: #BD93F9; ">Request</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">forwarded_priority</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>

      <span class="keyword" style="color: #ff79c6; ">def</span> <span class="function method" style="color: #50fa7b; ">x_forwarded_proto_priority</span>
        <span class="constructor" style="color: #BD93F9; ">Request</span><span class="punctuation delimiter" style="color: #f8f8f2; ">.</span><span class="function method" style="color: #50fa7b; ">x_forwarded_proto_priority</span>
      <span class="keyword" style="color: #ff79c6; ">end</span>
    <span class="keyword" style="color: #ff79c6; ">end</span>

    <span class="function method" style="color: #50fa7b; ">include</span> <span class="constructor" style="color: #BD93F9; ">Env</span>
    <span class="function method" style="color: #50fa7b; ">include</span> <span class="constructor" style="color: #BD93F9; ">Helpers</span>
  <span class="keyword" style="color: #ff79c6; ">end</span>
<span class="keyword" style="color: #ff79c6; ">end</span>

<span class="comment" style="color: #6272A4; "># :nocov:</span>
<span class="function method" style="color: #50fa7b; ">require_relative</span> <span class="string" style="color: #f1fa8c; ">&#39;multipart&#39;</span> <span class="keyword" style="color: #ff79c6; ">unless</span> <span class="function builtin" style="color: #50fa7b; ">defined?</span><span class="punctuation bracket" style="color: #f8f8f2; ">(</span><span class="constructor" style="color: #BD93F9; ">Rack</span>::<span class="constructor" style="color: #BD93F9; ">Multipart</span><span class="punctuation bracket" style="color: #f8f8f2; ">)</span>
<span class="comment" style="color: #6272A4; "># :nocov:</span>
</code></pre>
</body>
</html>
