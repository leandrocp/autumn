<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Autumn Sample - rust - catppuccin_macchiato</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <pre class="autumn highlight" class="background" style="background-color: #24273a; ">
<code class="language-rust">
#![doc = include_str!(&quot;../README.md&quot;)]

<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">mod</span> c_lib<span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">mod</span> util<span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">use</span> c_lib <span class="keyword" style="color: #c6a0f6;">as</span> c<span class="punctuation" style="color: #939ab7;">;</span>

<span class="keyword" style="color: #c6a0f6;">use</span> lazy_static<span class="punctuation" style="color: #939ab7;">::</span>lazy_static<span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">use</span> std<span class="punctuation" style="color: #939ab7;">::</span>collections<span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HashSet</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">use</span> std<span class="punctuation" style="color: #939ab7;">::</span>sync<span class="punctuation" style="color: #939ab7;">::</span>atomic<span class="punctuation" style="color: #939ab7;">::</span><span class="punctuation" style="color: #939ab7;">{</span><span class="constructor" style="color: #7dc4e4;">AtomicUsize</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Ordering</span><span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">use</span> std<span class="punctuation" style="color: #939ab7;">::</span><span class="punctuation" style="color: #939ab7;">{</span>iter<span class="punctuation" style="color: #939ab7;">,</span> mem<span class="punctuation" style="color: #939ab7;">,</span> ops<span class="punctuation" style="color: #939ab7;">,</span> str<span class="punctuation" style="color: #939ab7;">,</span> usize<span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">use</span> thiserror<span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">Error</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">use</span> tree_sitter<span class="punctuation" style="color: #939ab7;">::</span><span class="punctuation" style="color: #939ab7;">{</span>
    <span class="constructor" style="color: #7dc4e4;">Language</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">LossyUtf8</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Node</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Parser</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Point</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Query</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">QueryCaptures</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">QueryCursor</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">QueryError</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="constructor" style="color: #7dc4e4;">QueryMatch</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Range</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Tree</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>

<span class="keyword" style="color: #c6a0f6;">const</span> <span class="constructor" style="color: #7dc4e4;">CANCELLATION_CHECK_INTERVAL</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span> = <span class="constant builtin" style="color: #f5a97f;">100</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">const</span> <span class="constructor" style="color: #7dc4e4;">BUFFER_HTML_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span> = <span class="constant builtin" style="color: #f5a97f;">10</span> <span class="operator" style="color: #91d7e3; ">*</span> <span class="constant builtin" style="color: #f5a97f;">1024</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="keyword" style="color: #c6a0f6;">const</span> <span class="constructor" style="color: #7dc4e4;">BUFFER_LINES_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span> = <span class="constant builtin" style="color: #f5a97f;">1000</span><span class="punctuation" style="color: #939ab7;">;</span>

<span class="function macro" style="color: #c6a0f6;">lazy_static</span><span class="function macro" style="color: #c6a0f6;">!</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">static</span> ref <span class="constructor" style="color: #7dc4e4;">STANDARD_CAPTURE_NAMES</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">HashSet</span>&lt;<span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="keyword" style="color: #c6a0f6;">static</span> <span class="type" style="color: #eed49f;">str</span>&gt; = vec!<span class="punctuation" style="color: #939ab7;">[</span>
        <span class="string" style="color: #a6da95;">&quot;attribute&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;boolean&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;carriage-return&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;comment&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;comment.documentation&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;constant&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;constant.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;constructor&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;constructor.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;embedded&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;error&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;escape&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;function&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;function.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;keyword&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.bold&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.heading&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.italic&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.link&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.link.url&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.list&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.list.checked&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.list.numbered&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.list.unchecked&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.list.unnumbered&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.quote&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.raw&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.raw.block&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.raw.inline&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;markup.strikethrough&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;module&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;number&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;operator&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;property&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;property.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;punctuation&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;punctuation.bracket&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;punctuation.delimiter&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;punctuation.special&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;string&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;string.escape&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;string.regexp&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;string.special&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;string.special.symbol&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;tag&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;type&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;type.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;variable&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;variable.builtin&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;variable.member&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="string" style="color: #a6da95;">&quot;variable.parameter&quot;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">]</span>
    <span class="punctuation" style="color: #939ab7;">.</span>into_iter<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">.</span>collect<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Indicates which highlight should be applied to a region of source code.</span>
<span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>derive<span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Copy</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Clone</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Debug</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">PartialEq</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Eq</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="keyword" style="color: #c6a0f6;">pub</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Represents the reason why syntax highlighting failed.</span>
<span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>derive<span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Debug</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Error</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">PartialEq</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Eq</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">enum</span> <span class="type" style="color: #eed49f;">Error</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>error<span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&quot;Cancelled&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
    <span class="constructor" style="color: #7dc4e4;">Cancelled</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>error<span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&quot;Invalid language&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
    <span class="constructor" style="color: #7dc4e4;">InvalidLanguage</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>error<span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&quot;Unknown error&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
    <span class="constructor" style="color: #7dc4e4;">Unknown</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Represents a single step in rendering a syntax-highlighted document.</span>
<span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>derive<span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Copy</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Clone</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Debug</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">enum</span> <span class="type" style="color: #eed49f;">HighlightEvent</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="constructor" style="color: #7dc4e4;">Source</span> <span class="punctuation" style="color: #939ab7;">{</span> <span class="text" style="color: #cad3f5; ">start</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="text" style="color: #cad3f5; ">end</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span> <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="constructor" style="color: #7dc4e4;">HighlightStart</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="constructor" style="color: #7dc4e4;">HighlightEnd</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Contains the data needed to highlight code written in a particular language.</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">/// This struct is immutable and can be shared between threads.</span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">language</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Language</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">String</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Query</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">apply_all_captures</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">combined_injections_query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Query</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">locals_pattern_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">highlights_pattern_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">highlight_indices</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">non_local_variable_patterns</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">injection_content_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">injection_language_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">local_scope_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">local_def_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">local_def_value_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">local_ref_capture_index</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Performs syntax highlighting, recognizing a given list of highlight names.</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">/// For the best performance `Highlighter` values should be reused between</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">/// syntax highlighting calls. A separate highlighter is needed for each thread that</span>
<span class="comment" style="font-style: italic; color: #8087a2; ">/// is performing highlighting.</span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">Highlighter</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="text" style="color: #cad3f5; ">parser</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Parser</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">cursors</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">QueryCursor</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="comment" style="font-style: italic; color: #8087a2; ">/// Converts a general-purpose syntax highlighting iterator into a sequence of lines of HTML.</span>
<span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">HtmlRenderer</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">carriage_return_highlight</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>derive<span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Debug</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
<span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">LocalDef</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="text" style="color: #cad3f5; ">name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">value_range</span><span class="punctuation" style="color: #939ab7;">:</span> ops<span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">highlight</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="attribute" style="color: #8aadf4;">#<span class="punctuation" style="color: #939ab7;">[</span>derive<span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Debug</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span></span>
<span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">LocalScope</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="text" style="color: #cad3f5; ">inherits</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">range</span><span class="punctuation" style="color: #939ab7;">:</span> ops<span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">local_defs</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">LocalDef</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">HighlightIter</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span>
<span class="keyword" style="color: #c6a0f6;">where</span>
    <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">FnMut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">{</span>
    <span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">byte_offset</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">highlighter</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">Highlighter</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">injection_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">cancellation_flag</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">AtomicUsize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">iter_count</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">next_event</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">last_highlight_range</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">apply_all_captures</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">struct</span> <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="text" style="color: #cad3f5; ">_tree</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Tree</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">cursor</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">QueryCursor</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">:</span> iter<span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Peekable</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">QueryCaptures</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">LocalScope</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">ranges</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="text" style="color: #cad3f5; ">depth</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">Highlighter</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Self</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="type" style="color: #eed49f;">Highlighter</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="text" style="color: #cad3f5; ">parser</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Parser</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">cursors</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">parser</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">Parser</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Iterate over the highlighted regions for a given slice of source code.</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">highlight</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">config</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">source</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">cancellation_flag</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">AtomicUsize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">injection_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">FnMut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">Iterator</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Item</span> = <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> layers = <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>
            source<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span>
            cancellation_flag<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> injection_callback<span class="punctuation" style="color: #939ab7;">,</span>
            config<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="function macro" style="color: #c6a0f6;">vec</span><span class="function macro" style="color: #c6a0f6;">!</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constructor" style="color: #7dc4e4;">Range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                start_byte<span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span>
                end_byte<span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">,</span>
                start_point<span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">Point</span><span class="punctuation" style="color: #939ab7;">::</span>new<span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                end_point<span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">Point</span><span class="punctuation" style="color: #939ab7;">::</span>new<span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">)</span>?<span class="punctuation" style="color: #939ab7;">;</span>
        <span class="function macro" style="color: #c6a0f6;">assert_ne</span><span class="function macro" style="color: #c6a0f6;">!</span><span class="punctuation" style="color: #939ab7;">(</span>layers<span class="punctuation" style="color: #939ab7;">.</span>len<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> result = <span class="type" style="color: #eed49f;">HighlightIter</span> <span class="punctuation" style="color: #939ab7;">{</span>
            source<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span>config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">byte_offset</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span>
            injection_callback<span class="punctuation" style="color: #939ab7;">,</span>
            cancellation_flag<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">highlighter</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">iter_count</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span>
            layers<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">next_event</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">last_highlight_range</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">apply_all_captures</span><span class="punctuation" style="color: #939ab7;">:</span> config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">apply_all_captures</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
        result<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>result<span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Creates a `HighlightConfiguration` for a given `Language` and set of highlighting</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// queries.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// # Parameters</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// * `language`  - The Tree-sitter `Language` that should be used for parsing.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// * `highlights_query` - A string containing tree patterns for syntax highlighting. This</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///   should be non-empty, otherwise no syntax highlights will be added.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// * `injections_query` -  A string containing tree patterns for injecting other languages</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///   into the document. This can be empty if no injections are desired.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// * `locals_query` - A string containing tree patterns for tracking local variable</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///   definitions and references. This can be empty if local variable tracking is not needed.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Returns a `HighlightConfiguration` that can then be used with the `highlight` method.</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">language</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Language</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">Into</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">String</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">highlights_query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">injection_query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">locals_query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">apply_all_captures</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">QueryError</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="comment" style="font-style: italic; color: #8087a2; ">// Concatenate the query strings, keeping track of the start offset of each section.</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> query_source = <span class="type" style="color: #eed49f;">String</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        query_source<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push_str</span><span class="punctuation" style="color: #939ab7;">(</span>injection_query<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> locals_query_offset = query_source<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        query_source<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push_str</span><span class="punctuation" style="color: #939ab7;">(</span>locals_query<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> highlights_query_offset = query_source<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        query_source<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push_str</span><span class="punctuation" style="color: #939ab7;">(</span>highlights_query<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

        <span class="comment" style="font-style: italic; color: #8087a2; ">// Construct a single query by concatenating the three query strings, but record the</span>
        <span class="comment" style="font-style: italic; color: #8087a2; ">// range of pattern indices that belong to each individual string.</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> query = <span class="type" style="color: #eed49f;">Query</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>language<span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span>query_source<span class="punctuation" style="color: #939ab7;">)</span>?<span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> locals_pattern_index = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> highlights_pattern_index = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> i <span class="keyword" style="color: #c6a0f6;">in</span> <span class="constant builtin" style="color: #f5a97f;">0</span>..<span class="punctuation" style="color: #939ab7;">(</span>query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pattern_count</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> pattern_offset = query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_byte_for_pattern</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> pattern_offset &lt; highlights_query_offset <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> pattern_offset &lt; highlights_query_offset <span class="punctuation" style="color: #939ab7;">{</span>
                    highlights_pattern_index += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> pattern_offset &lt; locals_query_offset <span class="punctuation" style="color: #939ab7;">{</span>
                    locals_pattern_index += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>

        <span class="comment" style="font-style: italic; color: #8087a2; ">// Construct a separate query just for dealing with the &#39;combined injections&#39;.</span>
        <span class="comment" style="font-style: italic; color: #8087a2; ">// Disable the combined injection patterns in the main query.</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> combined_injections_query = <span class="type" style="color: #eed49f;">Query</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>language<span class="punctuation" style="color: #939ab7;">,</span> injection_query<span class="punctuation" style="color: #939ab7;">)</span>?<span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> has_combined_queries = <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> pattern_index <span class="keyword" style="color: #c6a0f6;">in</span> <span class="constant builtin" style="color: #f5a97f;">0</span>..locals_pattern_index <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> settings = query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">property_settings</span><span class="punctuation" style="color: #939ab7;">(</span>pattern_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> settings<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">any</span><span class="punctuation" style="color: #939ab7;">(</span>|s| <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">*</span>s<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">key</span> == <span class="string" style="color: #a6da95;">&quot;injection.combined&quot;</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                has_combined_queries = <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">;</span>
                query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">disable_pattern</span><span class="punctuation" style="color: #939ab7;">(</span>pattern_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                combined_injections_query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">disable_pattern</span><span class="punctuation" style="color: #939ab7;">(</span>pattern_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> combined_injections_query = <span class="keyword" style="color: #c6a0f6;">if</span> has_combined_queries <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>combined_injections_query<span class="punctuation" style="color: #939ab7;">)</span>
        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="constructor" style="color: #7dc4e4;">None</span>
        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>

        <span class="comment" style="font-style: italic; color: #8087a2; ">// Find all of the highlighting patterns that are disabled for nodes that</span>
        <span class="comment" style="font-style: italic; color: #8087a2; ">// have been identified as local variables.</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> non_local_variable_patterns = <span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span>..query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pattern_count</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span>|i| <span class="punctuation" style="color: #939ab7;">{</span>
                query
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">property_predicates</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">any</span><span class="punctuation" style="color: #939ab7;">(</span>|<span class="punctuation" style="color: #939ab7;">(</span>prop<span class="punctuation" style="color: #939ab7;">,</span> positive<span class="punctuation" style="color: #939ab7;">)</span>| !<span class="operator" style="color: #91d7e3; ">*</span>positive &amp;&amp; prop<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">key</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> == <span class="string" style="color: #a6da95;">&quot;local&quot;</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">collect</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

        <span class="comment" style="font-style: italic; color: #8087a2; ">// Store the numeric ids for all of the special captures.</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> injection_content_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> injection_language_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> local_def_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> local_def_value_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> local_ref_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> local_scope_capture_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> <span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">,</span> name<span class="punctuation" style="color: #939ab7;">)</span> <span class="keyword" style="color: #c6a0f6;">in</span> query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">capture_names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">enumerate</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> i = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>i <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">match</span> <span class="operator" style="color: #91d7e3; ">*</span>name <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="string" style="color: #a6da95;">&quot;injection.content&quot;</span> =&gt; injection_content_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="string" style="color: #a6da95;">&quot;injection.language&quot;</span> =&gt; injection_language_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="string" style="color: #a6da95;">&quot;local.definition&quot;</span> =&gt; local_def_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="string" style="color: #a6da95;">&quot;local.definition-value&quot;</span> =&gt; local_def_value_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="string" style="color: #a6da95;">&quot;local.reference&quot;</span> =&gt; local_ref_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="string" style="color: #a6da95;">&quot;local.scope&quot;</span> =&gt; local_scope_capture_index = i<span class="punctuation" style="color: #939ab7;">,</span>
                _ =&gt; <span class="punctuation" style="color: #939ab7;">{</span><span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>

        <span class="keyword" style="color: #c6a0f6;">let</span> highlight_indices = <span class="function macro" style="color: #c6a0f6;">vec</span><span class="function macro" style="color: #c6a0f6;">!</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span> query<span class="punctuation" style="color: #939ab7;">.</span>capture_names<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span>len<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightConfiguration</span> <span class="punctuation" style="color: #939ab7;">{</span>
            language<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">:</span> name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">into</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            query<span class="punctuation" style="color: #939ab7;">,</span>
            apply_all_captures<span class="punctuation" style="color: #939ab7;">,</span>
            combined_injections_query<span class="punctuation" style="color: #939ab7;">,</span>
            locals_pattern_index<span class="punctuation" style="color: #939ab7;">,</span>
            highlights_pattern_index<span class="punctuation" style="color: #939ab7;">,</span>
            highlight_indices<span class="punctuation" style="color: #939ab7;">,</span>
            non_local_variable_patterns<span class="punctuation" style="color: #939ab7;">,</span>
            injection_content_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
            injection_language_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
            local_def_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
            local_def_value_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
            local_ref_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
            local_scope_capture_index<span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Get a slice containing all of the highlight names used in the configuration.</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">]</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">capture_names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Set the list of recognized highlight names.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Tree-sitter syntax-highlighting queries specify highlights in the form of dot-separated</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// highlight names like `punctuation.bracket` and `function.method.builtin`. Consumers of</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// these queries can choose to recognize highlights with different levels of specificity.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// For example, the string `function.builtin` will match against `function.method.builtin`</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// and `function.builtin.constructor`, but will not match `function.method`.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// When highlighting, results are returned as `Highlight` values, which contain the index</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// of the matched highlight this list of highlight names.</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">configure</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">recognized_names</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span><span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">AsRef</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> capture_parts = <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_indices</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clear</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_indices</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">capture_names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span><span class="keyword" style="color: #c6a0f6;">move</span> |capture_name| <span class="punctuation" style="color: #939ab7;">{</span>
                capture_parts<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clear</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                capture_parts<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span>capture_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">split</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&#39;.&#39;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> best_index = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> best_match_len = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">for</span> <span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">,</span> recognized_name<span class="punctuation" style="color: #939ab7;">)</span> <span class="keyword" style="color: #c6a0f6;">in</span> recognized_names<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">into_iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">enumerate</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> len = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> matches = <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">for</span> part <span class="keyword" style="color: #c6a0f6;">in</span> recognized_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">split</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&#39;.&#39;</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        len += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> !capture_parts<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">contains</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span>part<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            matches = <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> matches &amp;&amp; len &gt; best_match_len <span class="punctuation" style="color: #939ab7;">{</span>
                        best_index = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        best_match_len = len<span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                best_index<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">// Return the list of this configuration&#39;s capture names that are neither present in the</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// list of predefined &#39;canonical&#39; names nor start with an underscore (denoting &#39;private&#39; captures</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// used as part of capture internals).</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">nonconformant_capture_names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">capture_names</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">HashSet</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> capture_names = <span class="keyword" style="color: #c6a0f6;">if</span> capture_names<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">*</span><span class="constructor" style="color: #7dc4e4;">STANDARD_CAPTURE_NAMES</span>
        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="operator" style="color: #91d7e3; ">&amp;</span>capture_names
        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">names</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">filter</span><span class="punctuation" style="color: #939ab7;">(</span>|<span class="operator" style="color: #91d7e3; ">&amp;</span>n| !<span class="punctuation" style="color: #939ab7;">(</span>n<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">starts_with</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&#39;_&#39;</span><span class="punctuation" style="color: #939ab7;">)</span> || capture_names<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">contains</span><span class="punctuation" style="color: #939ab7;">(</span>n<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span>|n| <span class="operator" style="color: #91d7e3; ">*</span>n<span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">collect</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// Create a new &#39;layer&#39; of highlighting for this document.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">///</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// In the even that the new layer contains &quot;combined injections&quot; (injections where multiple</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// disjoint ranges are parsed as one syntax tree), these will be eagerly processed and</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">/// added to the returned vector.</span>
    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">FnMut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">source</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">parent_name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">highlighter</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">Highlighter</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">cancellation_flag</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">AtomicUsize</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">injection_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">config</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">depth</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">ranges</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Self</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> result = <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">with_capacity</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> queue = <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">loop</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> highlighter<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">set_included_ranges</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span>ranges<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                highlighter
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">set_language</span><span class="punctuation" style="color: #939ab7;">(</span>config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">language</span><span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map_err</span><span class="punctuation" style="color: #939ab7;">(</span>|_| <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">InvalidLanguage</span><span class="punctuation" style="color: #939ab7;">)</span>?<span class="punctuation" style="color: #939ab7;">;</span>

                <span class="keyword" style="color: #c6a0f6;">unsafe</span> <span class="punctuation" style="color: #939ab7;">{</span> highlighter<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">set_cancellation_flag</span><span class="punctuation" style="color: #939ab7;">(</span>cancellation_flag<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> tree = highlighter
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">parse</span><span class="punctuation" style="color: #939ab7;">(</span>source<span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">ok_or</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">Cancelled</span><span class="punctuation" style="color: #939ab7;">)</span>?<span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">unsafe</span> <span class="punctuation" style="color: #939ab7;">{</span> highlighter<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">parser</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">set_cancellation_flag</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> cursor = highlighter<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">cursors</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap_or</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">QueryCursor</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// Process combined injections.</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>combined_injections_query<span class="punctuation" style="color: #939ab7;">)</span> = <span class="operator" style="color: #91d7e3; ">&amp;</span>config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">combined_injections_query</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> injections_by_pattern_index =
                        <span class="function macro" style="color: #c6a0f6;">vec</span><span class="function macro" style="color: #c6a0f6;">!</span><span class="punctuation" style="color: #939ab7;">[</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span>new<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span> combined_injections_query<span class="punctuation" style="color: #939ab7;">.</span>pattern_count<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> matches =
                        cursor<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">matches</span><span class="punctuation" style="color: #939ab7;">(</span>combined_injections_query<span class="punctuation" style="color: #939ab7;">,</span> tree<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">root_node</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> source<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">for</span> mat <span class="keyword" style="color: #c6a0f6;">in</span> matches <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">let</span> entry = <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> injections_by_pattern_index<span class="punctuation" style="color: #939ab7;">[</span>mat<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">,</span> content_node<span class="punctuation" style="color: #939ab7;">,</span> include_children<span class="punctuation" style="color: #939ab7;">)</span> = <span class="function" style="color: #8aadf4;">injection_for_match</span><span class="punctuation" style="color: #939ab7;">(</span>
                            config<span class="punctuation" style="color: #939ab7;">,</span>
                            parent_name<span class="punctuation" style="color: #939ab7;">,</span>
                            combined_injections_query<span class="punctuation" style="color: #939ab7;">,</span>
                            <span class="operator" style="color: #91d7e3; ">&amp;</span>mat<span class="punctuation" style="color: #939ab7;">,</span>
                            source<span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> language_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            entry<span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">0</span> = language_name<span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>content_node<span class="punctuation" style="color: #939ab7;">)</span> = content_node <span class="punctuation" style="color: #939ab7;">{</span>
                            entry<span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>content_node<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                        entry<span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">2</span> = include_children<span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="keyword" style="color: #c6a0f6;">for</span> <span class="punctuation" style="color: #939ab7;">(</span>lang_name<span class="punctuation" style="color: #939ab7;">,</span> content_nodes<span class="punctuation" style="color: #939ab7;">,</span> includes_children<span class="punctuation" style="color: #939ab7;">)</span> <span class="keyword" style="color: #c6a0f6;">in</span> injections_by_pattern_index
                    <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>lang_name<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">)</span> = <span class="punctuation" style="color: #939ab7;">(</span>lang_name<span class="punctuation" style="color: #939ab7;">,</span> content_nodes<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>next_config<span class="punctuation" style="color: #939ab7;">)</span> = <span class="punctuation" style="color: #939ab7;">(</span>injection_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">(</span>lang_name<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                <span class="keyword" style="color: #c6a0f6;">let</span> ranges = <span class="type" style="color: #eed49f;">Self</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">intersect_ranges</span><span class="punctuation" style="color: #939ab7;">(</span>
                                    <span class="operator" style="color: #91d7e3; ">&amp;</span>ranges<span class="punctuation" style="color: #939ab7;">,</span>
                                    <span class="operator" style="color: #91d7e3; ">&amp;</span>content_nodes<span class="punctuation" style="color: #939ab7;">,</span>
                                    includes_children<span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                                <span class="keyword" style="color: #c6a0f6;">if</span> !ranges<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                    queue<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>next_config<span class="punctuation" style="color: #939ab7;">,</span> depth + <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">,</span> ranges<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                                <span class="punctuation" style="color: #939ab7;">}</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// The `captures` iterator borrows the `Tree` and the `QueryCursor`, which</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// prevents them from being moved. But both of these values are really just</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// pointers, so it&#39;s actually ok to move them.</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> tree_ref = <span class="keyword" style="color: #c6a0f6;">unsafe</span> <span class="punctuation" style="color: #939ab7;">{</span> mem<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">transmute</span><span class="punctuation" style="color: #939ab7;">::</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">_</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">static</span> <span class="type" style="color: #eed49f;">Tree</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span>tree<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> cursor_ref =
                    <span class="keyword" style="color: #c6a0f6;">unsafe</span> <span class="punctuation" style="color: #939ab7;">{</span> mem<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">transmute</span><span class="punctuation" style="color: #939ab7;">::</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">_</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">static</span> <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">QueryCursor</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> cursor<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> captures = cursor_ref
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">captures</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span>config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">,</span> tree_ref<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">root_node</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> source<span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peekable</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                result<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightIterLayer</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="function macro" style="color: #c6a0f6;">vec</span><span class="function macro" style="color: #c6a0f6;">!</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constructor" style="color: #7dc4e4;">LocalScope</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        inherits<span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">,</span>
                        range<span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">.</span><span class="punctuation" style="color: #939ab7;">.</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">,</span>
                        local_defs<span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span>new<span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
                    cursor<span class="punctuation" style="color: #939ab7;">,</span>
                    depth<span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="text" style="color: #cad3f5; ">_tree</span><span class="punctuation" style="color: #939ab7;">:</span> tree<span class="punctuation" style="color: #939ab7;">,</span>
                    captures<span class="punctuation" style="color: #939ab7;">,</span>
                    config<span class="punctuation" style="color: #939ab7;">,</span>
                    ranges<span class="punctuation" style="color: #939ab7;">,</span>
                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="keyword" style="color: #c6a0f6;">if</span> queue<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span>next_config<span class="punctuation" style="color: #939ab7;">,</span> next_depth<span class="punctuation" style="color: #939ab7;">,</span> next_ranges<span class="punctuation" style="color: #939ab7;">)</span> = queue<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                config = next_config<span class="punctuation" style="color: #939ab7;">;</span>
                depth = next_depth<span class="punctuation" style="color: #939ab7;">;</span>
                ranges = next_ranges<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>

        <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>result<span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">// Compute the ranges that should be included when parsing an injection.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// This takes into account three things:</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// * `parent_ranges` - The ranges must all fall within the *current* layer&#39;s ranges.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// * `nodes` - Every injection takes place within a set of nodes. The injection ranges</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">//   are the ranges of those nodes.</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// * `includes_children` - For some injections, the content nodes&#39; children should be</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">//   excluded from the nested document, so that only the content nodes&#39; *own* content</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">//   is reparsed. For other injections, the content nodes&#39; entire ranges should be</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">//   reparsed, including the ranges of their children.</span>
    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">intersect_ranges</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">parent_ranges</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">nodes</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">Node</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">includes_children</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Range</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> cursor = nodes<span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">walk</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> result = <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> parent_range_iter = parent_ranges<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> parent_range = parent_range_iter
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">expect</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">&quot;Layers should only be constructed with non-empty ranges vectors&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> node <span class="keyword" style="color: #c6a0f6;">in</span> nodes<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> preceding_range = <span class="type" style="color: #eed49f;">Range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Point</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">:</span> node<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_byte</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">:</span> node<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_position</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> following_range = <span class="type" style="color: #eed49f;">Range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">:</span> node<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">end_byte</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">:</span> node<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">end_position</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">:</span> usize<span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Point</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>usize<span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">,</span> usize<span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">MAX</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>

            <span class="keyword" style="color: #c6a0f6;">for</span> excluded_range <span class="keyword" style="color: #c6a0f6;">in</span> node
                <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">children</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> cursor<span class="punctuation" style="color: #939ab7;">)</span>
                <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">filter_map</span><span class="punctuation" style="color: #939ab7;">(</span>|child| <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> includes_children <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="constructor" style="color: #7dc4e4;">None</span>
                    <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>child<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">range</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span>
                <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">chain</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">[</span>following_range<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">cloned</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> range = <span class="type" style="color: #eed49f;">Range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">:</span> preceding_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">:</span> preceding_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">:</span> excluded_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">:</span> excluded_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                preceding_range = excluded_range<span class="punctuation" style="color: #939ab7;">;</span>

                <span class="keyword" style="color: #c6a0f6;">if</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> &lt; parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">continue</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>

                <span class="keyword" style="color: #c6a0f6;">while</span> parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> &lt;= range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> &gt; range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> &lt; parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> = parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">;</span>
                            range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_point</span> = parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>

                        <span class="keyword" style="color: #c6a0f6;">if</span> parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> &lt; range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="keyword" style="color: #c6a0f6;">if</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> &lt; parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                result<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                    <span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">:</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span><span class="punctuation" style="color: #939ab7;">,</span>
                                    <span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">:</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_point</span><span class="punctuation" style="color: #939ab7;">,</span>
                                    <span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">:</span> parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">,</span>
                                    <span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">:</span> parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                            range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> = parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span><span class="punctuation" style="color: #939ab7;">;</span>
                            range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_point</span> = parent_range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_point</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="keyword" style="color: #c6a0f6;">if</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start_byte</span> &lt; range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end_byte</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                result<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>range<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                            <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>

                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>next_range<span class="punctuation" style="color: #939ab7;">)</span> = parent_range_iter<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        parent_range = next_range<span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">return</span> result<span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        result
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="comment" style="font-style: italic; color: #8087a2; ">// First, sort scope boundaries by their byte offset in the document. At a</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// given position, emit scope endings before scope beginnings. Finally, emit</span>
    <span class="comment" style="font-style: italic; color: #8087a2; ">// scope boundaries from deeper layers first.</span>
    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">sort_key</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">isize</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> depth = -<span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">depth</span> <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">isize</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> next_start = <span class="variable builtin" style="color: #ed8796;">self</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peek</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span>|<span class="punctuation" style="color: #939ab7;">(</span>m<span class="punctuation" style="color: #939ab7;">,</span> i<span class="punctuation" style="color: #939ab7;">)</span>| m<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">*</span>i<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_byte</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> next_end = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">cloned</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">match</span> <span class="punctuation" style="color: #939ab7;">(</span>next_start<span class="punctuation" style="color: #939ab7;">,</span> next_end<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>start<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>end<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> start &lt; end <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>start<span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">,</span> depth<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
                <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>end<span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">,</span> depth<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">,</span> depth<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>j<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>j<span class="punctuation" style="color: #939ab7;">,</span> <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">,</span> depth<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            _ =&gt; <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="type" style="color: #eed49f;">HighlightIter</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span>
<span class="keyword" style="color: #c6a0f6;">where</span>
    <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">FnMut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">emit_event</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">offset</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">event</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> result<span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span> &lt; offset <span class="punctuation" style="color: #939ab7;">{</span>
            result = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Source</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="text" style="color: #cad3f5; ">start</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="text" style="color: #cad3f5; ">end</span><span class="punctuation" style="color: #939ab7;">:</span> offset<span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span> = offset<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">next_event</span> = event<span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
            result = event<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        result
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">while</span> !<span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>sort_key<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_key</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> i = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">while</span> i + <span class="constant builtin" style="color: #f5a97f;">1</span> &lt; <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>next_offset<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span>i + <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_key</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> next_offset &lt; sort_key <span class="punctuation" style="color: #939ab7;">{</span>
                            i += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="keyword" style="color: #c6a0f6;">continue</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> i &gt; <span class="constant builtin" style="color: #f5a97f;">0</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span>..<span class="punctuation" style="color: #939ab7;">(</span>i + <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">rotate_left</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> layer = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlighter</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">cursors</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">cursor</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">insert_layer</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">layer</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>sort_key<span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_key</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> i = <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">while</span> i &lt; <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>sort_key_i<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span>i<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_key</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> sort_key_i &gt; sort_key <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">insert</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">,</span> layer<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">return</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                    i += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>layer<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="type" style="color: #eed49f;">Iterator</span> <span class="keyword" style="color: #c6a0f6;">for</span> <span class="type" style="color: #eed49f;">HighlightIter</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span>
<span class="keyword" style="color: #c6a0f6;">where</span>
    <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">FnMut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">&gt;</span> + <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">type</span> <span class="type" style="color: #eed49f;">Item</span> = <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">;</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Self</span><span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Item</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="operator" style="color: #91d7e3; ">&#39;</span>main<span class="punctuation" style="color: #939ab7;">:</span> <span class="keyword" style="color: #c6a0f6;">loop</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// If we&#39;ve already determined the next highlight boundary, just return it.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>e<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">next_event</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">take</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">return</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>e<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Periodically check for cancellation, returning `Cancelled` error if the</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// cancellation flag was flipped.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>cancellation_flag<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">cancellation_flag</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">iter_count</span> += <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">iter_count</span> &gt;= <span class="constructor" style="color: #7dc4e4;">CANCELLATION_CHECK_INTERVAL</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">iter_count</span> = <span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> cancellation_flag<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">load</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Ordering</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">Relaxed</span><span class="punctuation" style="color: #939ab7;">)</span> != <span class="constant builtin" style="color: #f5a97f;">0</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">return</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Err</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">Cancelled</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// If none of the layers have any more highlight boundaries, terminate.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">return</span> <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span> &lt; <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> result = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="type" style="color: #eed49f;">Source</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="text" style="color: #cad3f5; ">start</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span><span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="text" style="color: #cad3f5; ">end</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">byte_offset</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    result
                <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="constructor" style="color: #7dc4e4;">None</span>
                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Get the next capture from whichever layer has the earliest highlight boundary.</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> range<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> layer = <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>next_match<span class="punctuation" style="color: #939ab7;">,</span> capture_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peek</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> next_capture = next_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">*</span>capture_index<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                range = next_capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">byte_range</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// If any previous highlight ends before this node starts, then before</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// processing this capture, emit the source code up until the end of the</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// previous highlight, and an end event for that highlight.</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>end_byte<span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">cloned</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> end_byte &lt;= range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">return</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">emit_event</span><span class="punctuation" style="color: #939ab7;">(</span>end_byte<span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HighlightEnd</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// If there are no more captures, then emit any remaining highlight end events.</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// And if there are none of those, then just advance to the end of the document.</span>
            <span class="keyword" style="color: #c6a0f6;">else</span> <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>end_byte<span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">cloned</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">return</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">emit_event</span><span class="punctuation" style="color: #939ab7;">(</span>end_byte<span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HighlightEnd</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">return</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">emit_event</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>

            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span><span class="keyword" style="color: #c6a0f6;">mut</span> match_<span class="punctuation" style="color: #939ab7;">,</span> capture_index<span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> capture = match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span>capture_index<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// If this capture represents an injection, then process the injection.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span> &lt; layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">locals_pattern_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">,</span> content_node<span class="punctuation" style="color: #939ab7;">,</span> include_children<span class="punctuation" style="color: #939ab7;">)</span> = <span class="function" style="color: #8aadf4;">injection_for_match</span><span class="punctuation" style="color: #939ab7;">(</span>
                    layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="operator" style="color: #91d7e3; ">&amp;</span>layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="operator" style="color: #91d7e3; ">&amp;</span>match_<span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">,</span>
                <span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// Explicitly remove this match so that none of its other captures will remain</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// in the stream of captures.</span>
                match_<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// If a language is found with the given name, then add a new language layer</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// to the highlighted document.</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>content_node<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = <span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">,</span> content_node<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>config<span class="punctuation" style="color: #939ab7;">)</span> = <span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">injection_callback</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">let</span> ranges = <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">intersect_ranges</span><span class="punctuation" style="color: #939ab7;">(</span>
                            <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">ranges</span><span class="punctuation" style="color: #939ab7;">,</span>
                            <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span>content_node<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
                            include_children<span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> !ranges<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="keyword" style="color: #c6a0f6;">match</span> <span class="type" style="color: #eed49f;">HighlightIterLayer</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>
                                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlighter</span><span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">cancellation_flag</span><span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">injection_callback</span><span class="punctuation" style="color: #939ab7;">,</span>
                                config<span class="punctuation" style="color: #939ab7;">,</span>
                                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">layers</span><span class="punctuation" style="color: #939ab7;">[</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">depth</span> + <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">,</span>
                                ranges<span class="punctuation" style="color: #939ab7;">,</span>
                            <span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>layers<span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                                    <span class="keyword" style="color: #c6a0f6;">for</span> layer <span class="keyword" style="color: #c6a0f6;">in</span> layers <span class="punctuation" style="color: #939ab7;">{</span>
                                        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">insert_layer</span><span class="punctuation" style="color: #939ab7;">(</span>layer<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                                    <span class="punctuation" style="color: #939ab7;">}</span>
                                <span class="punctuation" style="color: #939ab7;">}</span>
                                <span class="constructor" style="color: #7dc4e4;">Err</span><span class="punctuation" style="color: #939ab7;">(</span>e<span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="keyword" style="color: #c6a0f6;">return</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">Err</span><span class="punctuation" style="color: #939ab7;">(</span>e<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>

                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">continue</span> <span class="operator" style="color: #91d7e3; ">&#39;</span>main<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Remove from the local scope stack any local scopes that have already ended.</span>
            <span class="keyword" style="color: #c6a0f6;">while</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span> &gt; layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">range</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end</span> <span class="punctuation" style="color: #939ab7;">{</span>
                layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// If this capture is for tracking local variables, then process the</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// local variable info.</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> reference_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> definition_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">while</span> match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span> &lt; layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlights_pattern_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// If the node represents a local scope, push a new local scope onto</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// the scope stack.</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span><span class="punctuation" style="color: #939ab7;">)</span> == layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_scope_capture_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    definition_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> scope = <span class="type" style="color: #eed49f;">LocalScope</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="text" style="color: #cad3f5; ">inherits</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="text" style="color: #cad3f5; ">range</span><span class="punctuation" style="color: #939ab7;">:</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clone</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="text" style="color: #cad3f5; ">local_defs</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
                    <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">for</span> prop <span class="keyword" style="color: #c6a0f6;">in</span> layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">query</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">property_settings</span><span class="punctuation" style="color: #939ab7;">(</span>match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">match</span> prop<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">key</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="string" style="color: #a6da95;">&quot;local.scope-inherits&quot;</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                                scope<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">inherits</span> =
                                    prop<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">value</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map_or</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">,</span> |r| r<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> == <span class="string" style="color: #a6da95;">&quot;true&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                            _ =&gt; <span class="punctuation" style="color: #939ab7;">{</span><span class="punctuation" style="color: #939ab7;">}</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                    layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>scope<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// If the node represents a definition, add a new definition to the</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// local scope at the top of the scope stack.</span>
                <span class="keyword" style="color: #c6a0f6;">else</span> <span class="keyword" style="color: #c6a0f6;">if</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span><span class="punctuation" style="color: #939ab7;">)</span> == layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_def_capture_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    reference_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
                    definition_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> scope = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last_mut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>

                    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> value_range = <span class="constant builtin" style="color: #f5a97f;">0</span>..<span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">for</span> capture <span class="keyword" style="color: #c6a0f6;">in</span> match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span><span class="punctuation" style="color: #939ab7;">)</span> == layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_def_value_capture_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            value_range = capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">byte_range</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>

                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>name<span class="punctuation" style="color: #939ab7;">)</span> = str<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">from_utf8</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">[</span>range<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clone</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        scope<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_defs</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">LocalDef</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            name<span class="punctuation" style="color: #939ab7;">,</span>
                            value_range<span class="punctuation" style="color: #939ab7;">,</span>
                            <span class="text" style="color: #cad3f5; ">highlight</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
                        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        definition_highlight =
                            scope<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_defs</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last_mut</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span>|s| <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> s<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// If the node represents a reference, then try to find the corresponding</span>
                <span class="comment" style="font-style: italic; color: #8087a2; ">// definition in the scope stack.</span>
                <span class="keyword" style="color: #c6a0f6;">else</span> <span class="keyword" style="color: #c6a0f6;">if</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span><span class="punctuation" style="color: #939ab7;">)</span> == layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_ref_capture_index</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> definition_highlight<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_none</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        definition_highlight = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span>name<span class="punctuation" style="color: #939ab7;">)</span> = str<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">from_utf8</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">source</span><span class="punctuation" style="color: #939ab7;">[</span>range<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clone</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            <span class="keyword" style="color: #c6a0f6;">for</span> scope <span class="keyword" style="color: #c6a0f6;">in</span> layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">scope_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">rev</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>highlight<span class="punctuation" style="color: #939ab7;">)</span> =
                                    scope<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">local_defs</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">rev</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">find_map</span><span class="punctuation" style="color: #939ab7;">(</span>|def| <span class="punctuation" style="color: #939ab7;">{</span>
                                        <span class="keyword" style="color: #c6a0f6;">if</span> def<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">name</span> == name &amp;&amp; range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span> &gt;= def<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">value_range</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                            <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>def<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight</span><span class="punctuation" style="color: #939ab7;">)</span>
                                        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                            <span class="constructor" style="color: #7dc4e4;">None</span>
                                        <span class="punctuation" style="color: #939ab7;">}</span>
                                    <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span>
                                <span class="punctuation" style="color: #939ab7;">{</span>
                                    reference_highlight = highlight<span class="punctuation" style="color: #939ab7;">;</span>
                                    <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                                <span class="punctuation" style="color: #939ab7;">}</span>
                                <span class="keyword" style="color: #c6a0f6;">if</span> !scope<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">inherits</span> <span class="punctuation" style="color: #939ab7;">{</span>
                                    <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                                <span class="punctuation" style="color: #939ab7;">}</span>
                            <span class="punctuation" style="color: #939ab7;">}</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>

                <span class="comment" style="font-style: italic; color: #8087a2; ">// Continue processing any additional matches for the same node.</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>next_match<span class="punctuation" style="color: #939ab7;">,</span> next_capture_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peek</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">let</span> next_capture = next_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">*</span>next_capture_index<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> next_capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> == capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        capture = next_capture<span class="punctuation" style="color: #939ab7;">;</span>
                        match_ = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">continue</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span>

                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">continue</span> <span class="operator" style="color: #91d7e3; ">&#39;</span>main<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Otherwise, this capture must represent a highlight.</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// If this exact range has already been highlighted by an earlier pattern, or by</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// a different layer, then skip over this one.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>last_start<span class="punctuation" style="color: #939ab7;">,</span> last_end<span class="punctuation" style="color: #939ab7;">,</span> last_depth<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">last_highlight_range</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span> == last_start &amp;&amp; range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end</span> == last_end &amp;&amp; layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">depth</span> &lt; last_depth <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">continue</span> <span class="operator" style="color: #91d7e3; ">&#39;</span>main<span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// If the current node was found to be a local variable, then skip over any</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// highlighting patterns that are disabled for local variables.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> definition_highlight<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> || reference_highlight<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">while</span> layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">non_local_variable_patterns</span><span class="punctuation" style="color: #939ab7;">[</span>match_<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span><span class="punctuation" style="color: #939ab7;">]</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    match_<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>next_match<span class="punctuation" style="color: #939ab7;">,</span> next_capture_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peek</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        <span class="keyword" style="color: #c6a0f6;">let</span> next_capture = next_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">*</span>next_capture_index<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="keyword" style="color: #c6a0f6;">if</span> next_capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> == capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> <span class="punctuation" style="color: #939ab7;">{</span>
                            capture = next_capture<span class="punctuation" style="color: #939ab7;">;</span>
                            match_ = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                            <span class="keyword" style="color: #c6a0f6;">continue</span><span class="punctuation" style="color: #939ab7;">;</span>
                        <span class="punctuation" style="color: #939ab7;">}</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>

                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="keyword" style="color: #c6a0f6;">continue</span> <span class="operator" style="color: #91d7e3; ">&#39;</span>main<span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Once a highlighting pattern is found for the current node, skip over</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// any later highlighting patterns that also match this node. Captures</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// for a given node are ordered by pattern index, so these subsequent</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// captures are guaranteed to be for highlighting, not injections or</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// local variables.</span>
            <span class="keyword" style="color: #c6a0f6;">while</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>next_match<span class="punctuation" style="color: #939ab7;">,</span> next_capture_index<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">peek</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> next_capture = next_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">[</span><span class="operator" style="color: #91d7e3; ">*</span>next_capture_index<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> next_capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> == capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">apply_all_captures</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        match_<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">remove</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                        capture = next_capture<span class="punctuation" style="color: #939ab7;">;</span>
                        match_ = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                        layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">next</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="keyword" style="color: #c6a0f6;">break</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="keyword" style="color: #c6a0f6;">let</span> current_highlight = layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">config</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_indices</span><span class="punctuation" style="color: #939ab7;">[</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span> <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">;</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// If this node represents a local definition, then store the current</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// highlight value on the local scope entry representing this node.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>definition_highlight<span class="punctuation" style="color: #939ab7;">)</span> = definition_highlight <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="operator" style="color: #91d7e3; ">*</span>definition_highlight = current_highlight<span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Emit a scope start event and push the node&#39;s end position to the stack.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>highlight<span class="punctuation" style="color: #939ab7;">)</span> = reference_highlight<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">or</span><span class="punctuation" style="color: #939ab7;">(</span>current_highlight<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">last_highlight_range</span> = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span>range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span><span class="punctuation" style="color: #939ab7;">,</span> range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end</span><span class="punctuation" style="color: #939ab7;">,</span> layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">depth</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                layer<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">highlight_end_stack</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">end</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">return</span> <span class="variable builtin" style="color: #ed8796;">self</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">emit_event</span><span class="punctuation" style="color: #939ab7;">(</span>range<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">start</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HighlightStart</span><span class="punctuation" style="color: #939ab7;">(</span>highlight<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">sort_layers</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">HtmlRenderer</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Self</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> result = <span class="type" style="color: #eed49f;">HtmlRenderer</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">with_capacity</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">BUFFER_HTML_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">with_capacity</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constructor" style="color: #7dc4e4;">BUFFER_LINES_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="text" style="color: #cad3f5; ">carriage_return_highlight</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
        result<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        result
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">set_carriage_return_highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">highlight</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">carriage_return_highlight</span> = highlight<span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">reset</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="function" style="color: #8aadf4;">shrink_and_clear</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">BUFFER_HTML_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="function" style="color: #8aadf4;">shrink_and_clear</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="constructor" style="color: #7dc4e4;">BUFFER_LINES_RESERVE_CAPACITY</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="constant builtin" style="color: #f5a97f;">0</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">render</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span>
        <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">highlighter</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">Iterator</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Item</span> = <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">source</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
        <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">attribute_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="type" style="color: #eed49f;">Result</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Error</span><span class="punctuation" style="color: #939ab7;">&gt;</span>
    <span class="keyword" style="color: #c6a0f6;">where</span>
        <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Fn</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> highlights = <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> event <span class="keyword" style="color: #c6a0f6;">in</span> highlighter <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">match</span> event <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HighlightStart</span><span class="punctuation" style="color: #939ab7;">(</span>s<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                    highlights<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>s<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_highlight</span><span class="punctuation" style="color: #939ab7;">(</span>s<span class="punctuation" style="color: #939ab7;">,</span> attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">HighlightEnd</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                    highlights<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">end_highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">HighlightEvent</span><span class="punctuation" style="color: #939ab7;">::</span><span class="constructor" style="color: #7dc4e4;">Source</span> <span class="punctuation" style="color: #939ab7;">{</span> start<span class="punctuation" style="color: #939ab7;">,</span> end <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">add_text</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span>source<span class="punctuation" style="color: #939ab7;">[</span>start..end<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&amp;</span>highlights<span class="punctuation" style="color: #939ab7;">,</span> attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                <span class="constructor" style="color: #7dc4e4;">Err</span><span class="punctuation" style="color: #939ab7;">(</span>a<span class="punctuation" style="color: #939ab7;">)</span> =&gt; <span class="keyword" style="color: #c6a0f6;">return</span> <span class="constructor" style="color: #7dc4e4;">Err</span><span class="punctuation" style="color: #939ab7;">(</span>a<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">,</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> != <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="string" style="color: #a6da95;">b&#39;\n&#39;</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&#39;\n&#39;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">last</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> == <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">pop</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="constructor" style="color: #7dc4e4;">Ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">pub</span> <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">lines</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="keyword" style="color: #c6a0f6;">impl</span> <span class="type" style="color: #eed49f;">Iterator</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Item</span> = <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">enumerate</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span><span class="keyword" style="color: #c6a0f6;">move</span> |<span class="punctuation" style="color: #939ab7;">(</span>i<span class="punctuation" style="color: #939ab7;">,</span> line_start<span class="punctuation" style="color: #939ab7;">)</span>| <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> line_start = <span class="operator" style="color: #91d7e3; ">*</span>line_start <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">let</span> line_end = <span class="keyword" style="color: #c6a0f6;">if</span> i + <span class="constant builtin" style="color: #f5a97f;">1</span> == <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
                <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">[</span>i + <span class="constant builtin" style="color: #f5a97f;">1</span><span class="punctuation" style="color: #939ab7;">]</span> <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">usize</span>
                <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">;</span>
                str<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">from_utf8</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">[</span>line_start..line_end<span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">unwrap</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
            <span class="punctuation" style="color: #939ab7;">}</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">add_carriage_return</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">attribute_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="keyword" style="color: #c6a0f6;">where</span>
        <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Fn</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>highlight<span class="punctuation" style="color: #939ab7;">)</span> = <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">carriage_return_highlight</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="keyword" style="color: #c6a0f6;">let</span> attribute_string = <span class="punctuation" style="color: #939ab7;">(</span>attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">(</span>highlight<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> !attribute_string<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot;&lt;span &quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span>attribute_string<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot;&gt;&lt;/span&gt;&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">start_highlight</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">h</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">attribute_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="keyword" style="color: #c6a0f6;">where</span>
        <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Fn</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> attribute_string = <span class="punctuation" style="color: #939ab7;">(</span>attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">(</span>h<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot;&lt;span&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> !attribute_string<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_empty</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot; &quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span>attribute_string<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot;&gt;&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">end_highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend</span><span class="punctuation" style="color: #939ab7;">(</span><span class="string" style="color: #a6da95;">b&quot;&lt;/span&gt;&quot;</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">add_text</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">src</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">highlights</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">attribute_callback</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">)</span>
    <span class="keyword" style="color: #c6a0f6;">where</span>
        <span class="type" style="color: #eed49f;">F</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Fn</span><span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Highlight</span><span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> last_char_was_cr = <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">for</span> c <span class="keyword" style="color: #c6a0f6;">in</span> <span class="type" style="color: #eed49f;">LossyUtf8</span><span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">new</span><span class="punctuation" style="color: #939ab7;">(</span>src<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">flat_map</span><span class="punctuation" style="color: #939ab7;">(</span>|p| p<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">bytes</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// Don&#39;t render carriage return characters, but allow lone carriage returns (not</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// followed by line feeds) to be styled via the attribute callback.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> c == <span class="string" style="color: #a6da95;">b&#39;\r&#39;</span> <span class="punctuation" style="color: #939ab7;">{</span>
                last_char_was_cr = <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="keyword" style="color: #c6a0f6;">continue</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> last_char_was_cr <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> c != <span class="string" style="color: #a6da95;">b&#39;\n&#39;</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">add_carriage_return</span><span class="punctuation" style="color: #939ab7;">(</span>attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
                last_char_was_cr = <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// At line boundaries, close and re-open all of the open tags.</span>
            <span class="keyword" style="color: #c6a0f6;">if</span> c == <span class="string" style="color: #a6da95;">b&#39;\n&#39;</span> <span class="punctuation" style="color: #939ab7;">{</span>
                highlights<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">for_each</span><span class="punctuation" style="color: #939ab7;">(</span>|_| <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">end_highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>c<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">line_offsets</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="keyword" style="color: #c6a0f6;">as</span> <span class="type" style="color: #eed49f;">u32</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                highlights
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">iter</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span>
                    <span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">for_each</span><span class="punctuation" style="color: #939ab7;">(</span>|scope| <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">start_highlight</span><span class="punctuation" style="color: #939ab7;">(</span><span class="operator" style="color: #91d7e3; ">*</span>scope<span class="punctuation" style="color: #939ab7;">,</span> attribute_callback<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="keyword" style="color: #c6a0f6;">if</span> <span class="keyword" style="color: #c6a0f6;">let</span> <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>escape<span class="punctuation" style="color: #939ab7;">)</span> = util<span class="punctuation" style="color: #939ab7;">::</span><span class="function" style="color: #8aadf4;">html_escape</span><span class="punctuation" style="color: #939ab7;">(</span>c<span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">extend_from_slice</span><span class="punctuation" style="color: #939ab7;">(</span>escape<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="variable builtin" style="color: #ed8796;">self</span><span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">html</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">push</span><span class="punctuation" style="color: #939ab7;">(</span>c<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
            <span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">injection_for_match</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span>
    <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">config</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">HighlightConfiguration</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">parent_name</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">query</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">Query</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">query_match</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="type" style="color: #eed49f;">QueryMatch</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span>
    <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">source</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="punctuation" style="color: #939ab7;">[</span><span class="type" style="color: #eed49f;">u8</span><span class="punctuation" style="color: #939ab7;">]</span><span class="punctuation" style="color: #939ab7;">,</span>
<span class="punctuation" style="color: #939ab7;">)</span> -&gt; <span class="punctuation" style="color: #939ab7;">(</span><span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&amp;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span> <span class="type" style="color: #eed49f;">str</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">Option</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">Node</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="operator" style="color: #91d7e3; ">&#39;</span><span class="label" style="color: #7dc4e4;">a</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="type" style="color: #eed49f;">bool</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">let</span> content_capture_index = config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">injection_content_capture_index</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="keyword" style="color: #c6a0f6;">let</span> language_capture_index = config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">injection_language_capture_index</span><span class="punctuation" style="color: #939ab7;">;</span>

    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> language_name = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> content_node = <span class="constructor" style="color: #7dc4e4;">None</span><span class="punctuation" style="color: #939ab7;">;</span>

    <span class="keyword" style="color: #c6a0f6;">for</span> capture <span class="keyword" style="color: #c6a0f6;">in</span> query_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">captures</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">let</span> index = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">index</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="keyword" style="color: #c6a0f6;">if</span> index == language_capture_index <span class="punctuation" style="color: #939ab7;">{</span>
            language_name = capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">utf8_text</span><span class="punctuation" style="color: #939ab7;">(</span>source<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">ok</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span> <span class="keyword" style="color: #c6a0f6;">else</span> <span class="keyword" style="color: #c6a0f6;">if</span> index == content_capture_index <span class="punctuation" style="color: #939ab7;">{</span>
            content_node = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>capture<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">node</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="keyword" style="color: #c6a0f6;">let</span> <span class="keyword" style="color: #c6a0f6;">mut</span> include_children = <span class="constant builtin" style="color: #f5a97f;">false</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="keyword" style="color: #c6a0f6;">for</span> prop <span class="keyword" style="color: #c6a0f6;">in</span> query<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">property_settings</span><span class="punctuation" style="color: #939ab7;">(</span>query_match<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">pattern_index</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
        <span class="keyword" style="color: #c6a0f6;">match</span> prop<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">key</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// In addition to specifying the language name via the text of a</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// captured node, it can also be hard-coded via a `#set!` predicate</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// that sets the injection.language key.</span>
            <span class="string" style="color: #a6da95;">&quot;injection.language&quot;</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> language_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_none</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    language_name = prop<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">value</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">map</span><span class="punctuation" style="color: #939ab7;">(</span>|s| s<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_ref</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Setting the `injection.self` key can be used to specify that the</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// language name should be the same as the language of the current</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// layer.</span>
            <span class="string" style="color: #a6da95;">&quot;injection.self&quot;</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> language_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_none</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    language_name = <span class="constructor" style="color: #7dc4e4;">Some</span><span class="punctuation" style="color: #939ab7;">(</span>config<span class="punctuation" style="color: #939ab7;">.</span><span class="text" style="color: #cad3f5; ">language_name</span><span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">as_str</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// Setting the `injection.parent` key can be used to specify that</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// the language name should be the same as the language of the</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// parent layer</span>
            <span class="string" style="color: #a6da95;">&quot;injection.parent&quot;</span> =&gt; <span class="punctuation" style="color: #939ab7;">{</span>
                <span class="keyword" style="color: #c6a0f6;">if</span> language_name<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">is_none</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
                    language_name = parent_name<span class="punctuation" style="color: #939ab7;">;</span>
                <span class="punctuation" style="color: #939ab7;">}</span>
            <span class="punctuation" style="color: #939ab7;">}</span>

            <span class="comment" style="font-style: italic; color: #8087a2; ">// By default, injections do not include the *children* of an</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// `injection.content` node - only the ranges that belong to the</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// node itself. This can be changed using a `#set!` predicate that</span>
            <span class="comment" style="font-style: italic; color: #8087a2; ">// sets the `injection.include-children` key.</span>
            <span class="string" style="color: #a6da95;">&quot;injection.include-children&quot;</span> =&gt; include_children = <span class="constant builtin" style="color: #f5a97f;">true</span><span class="punctuation" style="color: #939ab7;">,</span>
            _ =&gt; <span class="punctuation" style="color: #939ab7;">{</span><span class="punctuation" style="color: #939ab7;">}</span>
        <span class="punctuation" style="color: #939ab7;">}</span>
    <span class="punctuation" style="color: #939ab7;">}</span>

    <span class="punctuation" style="color: #939ab7;">(</span>language_name<span class="punctuation" style="color: #939ab7;">,</span> content_node<span class="punctuation" style="color: #939ab7;">,</span> include_children<span class="punctuation" style="color: #939ab7;">)</span>
<span class="punctuation" style="color: #939ab7;">}</span>

<span class="keyword" style="color: #c6a0f6;">fn</span> <span class="function" style="color: #8aadf4;">shrink_and_clear</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">T</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">(</span><span class="variable parameter" style="font-style: italic; color: #ee99a0; ">vec</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="operator" style="color: #91d7e3; ">&amp;</span><span class="keyword" style="color: #c6a0f6;">mut</span> <span class="type" style="color: #eed49f;">Vec</span><span class="punctuation" style="color: #939ab7;">&lt;</span><span class="type" style="color: #eed49f;">T</span><span class="punctuation" style="color: #939ab7;">&gt;</span><span class="punctuation" style="color: #939ab7;">,</span> <span class="variable parameter" style="font-style: italic; color: #ee99a0; ">capacity</span><span class="punctuation" style="color: #939ab7;">:</span> <span class="type" style="color: #eed49f;">usize</span><span class="punctuation" style="color: #939ab7;">)</span> <span class="punctuation" style="color: #939ab7;">{</span>
    <span class="keyword" style="color: #c6a0f6;">if</span> vec<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">len</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span> &gt; capacity <span class="punctuation" style="color: #939ab7;">{</span>
        vec<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">truncate</span><span class="punctuation" style="color: #939ab7;">(</span>capacity<span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
        vec<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">shrink_to_fit</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
    <span class="punctuation" style="color: #939ab7;">}</span>
    vec<span class="punctuation" style="color: #939ab7;">.</span><span class="function" style="color: #8aadf4;">clear</span><span class="punctuation" style="color: #939ab7;">(</span><span class="punctuation" style="color: #939ab7;">)</span><span class="punctuation" style="color: #939ab7;">;</span>
<span class="punctuation" style="color: #939ab7;">}</span>
</code></pre>
</body>
</html>
