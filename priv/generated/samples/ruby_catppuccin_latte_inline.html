<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Autumn Sample - ruby - catppuccin_latte (inline)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      font-family: 'JetBrains Mono', monospace;
      line-height: 1.5;
    }
    pre {
      font-size: 15px;
      margin: 20px;
      padding: 50px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <pre class="autumn-hl" style="background-color: #eff1f5; color: #4c4f69;"><code class="language-ruby" translate="no"><span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># frozen_string_literal: true</span>

<span class="ahl-keyword ahl-control ahl-import" style="color: #8839ef;">require_relative</span> <span class="ahl-string" style="color: #40a02b;">&#x27;constants&#x27;</span>
<span class="ahl-keyword ahl-control ahl-import" style="color: #8839ef;">require_relative</span> <span class="ahl-string" style="color: #40a02b;">&#x27;utils&#x27;</span>
<span class="ahl-keyword ahl-control ahl-import" style="color: #8839ef;">require_relative</span> <span class="ahl-string" style="color: #40a02b;">&#x27;media_type&#x27;</span>

<span class="ahl-keyword" style="color: #8839ef;">module</span> <span class="ahl-constructor" style="color: #209fb5;">Rack</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Rack::Request provides a convenient interface to a Rack</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># environment.  It is stateless, the environment +env+ passed to the</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># constructor will be directly modified.</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   req = Rack::Request.new(env)</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   req.post?</span>
  <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   req.params[&quot;data&quot;]</span>

  <span class="ahl-keyword" style="color: #8839ef;">class</span> <span class="ahl-constructor" style="color: #209fb5;">Request</span>
    <span class="ahl-keyword" style="color: #8839ef;">class</span> &lt;&lt; <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span>
      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:ip_filter</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The priority when checking forwarded headers. The default</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># is &lt;tt&gt;[:forwarded, :x_forwarded]&lt;&#x2f;tt&gt;, which means, check the</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># +Forwarded+ header first, followed by the appropriate</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &lt;tt&gt;X-Forwarded-*&lt;&#x2f;tt&gt; header.  You can revert the priority by</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># reversing the priority, or remove checking of either</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># or both headers by removing elements from the array.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># This should be set as appropriate in your environment</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># based on what reverse proxies are in use.  If you are not</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># using reverse proxies, you should probably use an empty</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># array.</span>
      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded_priority</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The priority when checking either the &lt;tt&gt;X-Forwarded-Proto&lt;&#x2f;tt&gt;</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># or &lt;tt&gt;X-Forwarded-Scheme&lt;&#x2f;tt&gt; header for the forwarded protocol.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The default is &lt;tt&gt;[:proto, :scheme]&lt;&#x2f;tt&gt;, to try the</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &lt;tt&gt;X-Forwarded-Proto&lt;&#x2f;tt&gt; header before the</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &lt;tt&gt;X-Forwarded-Scheme&lt;&#x2f;tt&gt; header.  Rack 2 had behavior</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># similar to &lt;tt&gt;[:scheme, :proto]&lt;&#x2f;tt&gt;.  You can remove either or</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># both of the entries in array to ignore that respective header.</span>
      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">attr_accessor</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded_proto_priority</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@forwarded_priority</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
    <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@x_forwarded_proto_priority</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:proto</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>

    <span class="ahl-variable" style="color: #4c4f69;">valid_ipv4_octet</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span>(25[0-5]|2[0-4][0-9]|[01]?[0-9]?[0-9])&#x2f;</span>

    <span class="ahl-variable" style="color: #4c4f69;">trusted_proxies</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constructor" style="color: #209fb5;">Regexp</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">union</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>127<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>{3}<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>                          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># localhost IPv4 range 127.x.x.x, per RFC-3330</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>::1<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>                                                <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># localhost IPv6 ::1</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>f[cd][0-9a-f]{2}(?::[0-9a-f]{0,4}){0,7}<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;i</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>           <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># private IPv6 range fc00 .. fdff</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>10<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>{3}<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>                           <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># private IPv4 range 10.x.x.x</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>172<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span>(1[6-9]|2[0-9]|3[01])<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>{2}<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>   <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># private IPv4 range 172.16.0.0 .. 172.31.255.255</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>192<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span>168<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">valid_ipv4_octet</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>{2}<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>                     <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># private IPv4 range 192.168.x.x</span>
      <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>localhost<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>|<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>unix(<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>|:)&#x2f;i</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>                            <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># localhost hostname, and unix domain sockets</span>
    <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

    <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">ip_filter</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">lambda</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span> <span class="ahl-variable" style="color: #4c4f69;">trusted_proxies</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">match?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span>

    <span class="ahl-constant" style="color: #fe640b;">ALLOWED_SCHEMES</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">%w(</span><span class="ahl-string" style="color: #40a02b;">https</span> <span class="ahl-string" style="color: #40a02b;">http</span> <span class="ahl-string" style="color: #40a02b;">wss</span> <span class="ahl-string" style="color: #40a02b;">ws</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">freeze</span>

    <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">initialize</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">env</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">env</span>
      <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@params</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">params</span>
      <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@params</span> <span class="ahl-operator" style="color: #04a5e5;">||=</span> <span class="ahl-function ahl-builtin" style="color: #1e66f5;">super</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">update_param</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">super</span>
      <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@params</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">delete_param</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-variable" style="color: #4c4f69;">v</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-builtin" style="color: #1e66f5;">super</span>
      <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@params</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
      <span class="ahl-variable" style="color: #4c4f69;">v</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-keyword" style="color: #8839ef;">module</span> <span class="ahl-constructor" style="color: #209fb5;">Env</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The environment of the request.</span>
      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">attr_reader</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:env</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">initialize</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">env</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">env</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># This module is included at least in `ActionDispatch::Request`</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The call to `super()` allows additional mixed-in initializers are called</span>
        <span class="ahl-function ahl-builtin" style="color: #1e66f5;">super</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Predicate method to test to see if `name` has been set as request</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># specific data</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">has_header?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">key?</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Get a request specific value for `name`.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># If a block is given, it yields to the block if the value hasn&#x27;t been set</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># on the request.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">fetch_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> &amp;<span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">block</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">fetch</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> &amp;<span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">block</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Loops through each key &#x2f; value pair in the request specific data.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">each_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>&amp;<span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">block</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>&amp;<span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">block</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Set a request specific value for `name` to `v`</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Add a header that may have multiple values.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Example:</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   request.add_header &#x27;Accept&#x27;, &#x27;image&#x2f;png&#x27;</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   request.add_header &#x27;Accept&#x27;, &#x27;*&#x2f;*&#x27;</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   assert_equal &#x27;image&#x2f;png,*&#x2f;*&#x27;, request.get_header(&#x27;Accept&#x27;)</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># http:&#x2f;&#x2f;www.w3.org&#x2f;Protocols&#x2f;rfc2616&#x2f;rfc2616-sec4.html#sec4.2</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">add_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">nil?</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">elsif</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">has_header?</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string" style="color: #40a02b;">&quot;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>,<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>&quot;</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Delete a request specific value for `name`.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">delete_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">delete</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">name</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">initialize_copy</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">other</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-other ahl-member" style="color: #179299;">@env</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">other</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">dup</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-keyword" style="color: #8839ef;">module</span> <span class="ahl-constructor" style="color: #209fb5;">Helpers</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The set of form-data media-types. Requests that do not indicate</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># one of the media types present in this list will not be eligible</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># for form-data &#x2f; param parsing.</span>
      <span class="ahl-constant" style="color: #fe640b;">FORM_DATA_MEDIA_TYPES</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span>
        <span class="ahl-string" style="color: #40a02b;">&#x27;application&#x2f;x-www-form-urlencoded&#x27;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string" style="color: #40a02b;">&#x27;multipart&#x2f;form-data&#x27;</span>
      <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The set of media-types. Requests that do not indicate</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># one of the media types present in this list will not be eligible</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># for param parsing like soap attachments or generic multiparts</span>
      <span class="ahl-constant" style="color: #fe640b;">PARSEABLE_DATA_MEDIA_TYPES</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span>
        <span class="ahl-string" style="color: #40a02b;">&#x27;multipart&#x2f;related&#x27;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string" style="color: #40a02b;">&#x27;multipart&#x2f;mixed&#x27;</span>
      <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Default ports depending on scheme. Used to decide whether or not</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># to include the port in a generated URI.</span>
      <span class="ahl-constant" style="color: #fe640b;">DEFAULT_PORTS</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span> <span class="ahl-string" style="color: #40a02b;">&#x27;http&#x27;</span> <span class="ahl-operator" style="color: #04a5e5;">=&gt;</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">80</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string" style="color: #40a02b;">&#x27;https&#x27;</span> <span class="ahl-operator" style="color: #04a5e5;">=&gt;</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">443</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string" style="color: #40a02b;">&#x27;coffee&#x27;</span> <span class="ahl-operator" style="color: #04a5e5;">=&gt;</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">80</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The address of the client which connected to the proxy.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_FOR</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The contents of the host&#x2f;:authority header sent to the proxy.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_HOST</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_HOST&#x27;</span>

      <span class="ahl-constant" style="color: #fe640b;">HTTP_FORWARDED</span>          <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_FORWARDED&#x27;</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The value of the scheme sent to the proxy.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_SCHEME</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_SCHEME&#x27;</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The protocol used to connect to the proxy.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_PROTO</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_PROTO&#x27;</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The port used to connect to the proxy.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_PORT</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_PORT&#x27;</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Another way for specifying https scheme was used.</span>
      <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_SSL</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_X_FORWARDED_SSL&#x27;</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">body</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>            <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                         <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">script_name</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>     <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">SCRIPT_NAME</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span>                   <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">script_name</span>=<span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">SCRIPT_NAME</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">s</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">path_info</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>       <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">PATH_INFO</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span>                     <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">path_info</span>=<span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>   <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">PATH_INFO</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">s</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                  <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>  <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">REQUEST_METHOD</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                     <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>    <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">QUERY_STRING</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span>                  <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">content_length</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>  <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;CONTENT_LENGTH&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                   <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">logger</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>          <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_LOGGER</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">user_agent</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>      <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_USER_AGENT&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                  <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># the referer of the client</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">referer</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>         <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;HTTP_REFERER&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>                     <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">alias</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">referrer</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">referer</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">session</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">fetch_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_SESSION</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_SESSION</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">default_session</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">session_options</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">fetch_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_SESSION_OPTIONS</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_SESSION_OPTIONS</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type DELETE</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">delete?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>  <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">DELETE</span>  <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type GET</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>     <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">GET</span>     <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type HEAD</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">head?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>    <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">HEAD</span>    <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type OPTIONS</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">options?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">OPTIONS</span> <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type LINK</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">link?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>    <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">LINK</span>    <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type PATCH</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">patch?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>   <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">PATCH</span>   <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type POST</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">post?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>    <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">POST</span>    <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type PUT</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">put?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>     <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">PUT</span>     <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type TRACE</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">trace?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>   <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">TRACE</span>   <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Checks the HTTP request method (or verb) to see if it was of type UNLINK</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">unlink?</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span>  <span class="ahl-function ahl-method" style="color: #1e66f5;">request_method</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">UNLINK</span>  <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTPS</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-string" style="color: #40a02b;">&#x27;on&#x27;</span>
          <span class="ahl-string" style="color: #40a02b;">&#x27;https&#x27;</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">elsif</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_SSL</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-string" style="color: #40a02b;">&#x27;on&#x27;</span>
          <span class="ahl-string" style="color: #40a02b;">&#x27;https&#x27;</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">elsif</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_scheme</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_scheme</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_URL_SCHEME</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The authority of the incoming request as defined by RFC3976.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># https:&#x2f;&#x2f;tools.ietf.org&#x2f;html&#x2f;rfc3986#section-3.2</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># In HTTP&#x2f;1, this is the `host` header.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># In HTTP&#x2f;2, this is the `:authority` pseudo-header.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">authority</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_authority</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">host_authority</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">server_authority</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The authority as defined by the `SERVER_NAME` and `SERVER_PORT`</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># variables.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">server_authority</span>
        <span class="ahl-variable" style="color: #4c4f69;">host</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">server_name</span>
        <span class="ahl-variable" style="color: #4c4f69;">port</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">server_port</span>

        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">host</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">port</span>
            <span class="ahl-string" style="color: #40a02b;">&quot;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">host</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>:<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">port</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>&quot;</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
            <span class="ahl-variable" style="color: #4c4f69;">host</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">server_name</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">SERVER_NAME</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">server_port</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">SERVER_PORT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">cookies</span>
        <span class="ahl-variable" style="color: #4c4f69;">hash</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">fetch_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_COOKIE_HASH</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-variable" style="color: #4c4f69;">string</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_COOKIE</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">unless</span> <span class="ahl-variable" style="color: #4c4f69;">string</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_COOKIE_STRING</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-variable" style="color: #4c4f69;">hash</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">replace</span> <span class="ahl-constructor" style="color: #209fb5;">Utils</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">parse_cookies_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">string</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_COOKIE_STRING</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">string</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-variable" style="color: #4c4f69;">hash</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">content_type</span>
        <span class="ahl-variable" style="color: #4c4f69;">content_type</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;CONTENT_TYPE&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">content_type</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">nil?</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-variable" style="color: #4c4f69;">content_type</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">empty?</span> <span class="ahl-operator" style="color: #04a5e5;">?</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span> <span class="ahl-operator" style="color: #04a5e5;">:</span> <span class="ahl-variable" style="color: #4c4f69;">content_type</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">xhr?</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;HTTP_X_REQUESTED_WITH&quot;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-string" style="color: #40a02b;">&quot;XMLHttpRequest&quot;</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The `HTTP_HOST` header.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">host_authority</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_HOST</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">host_with_port</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">host</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">_</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">port</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">port</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">DEFAULT_PORTS</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
          <span class="ahl-variable" style="color: #4c4f69;">host</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
          <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Returns a formatted host, suitable for being used in a URI.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">host</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">0</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Returns an address suitable for being to resolve to an address.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># In the case of a domain name or IPv4 address, the result is the same</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># as +host+. In the case of IPv6 or future address formats, the square</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># brackets are removed.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">hostname</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">port</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">authority</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-variable" style="color: #4c4f69;">authority</span>
          <span class="ahl-variable" style="color: #4c4f69;">_</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">_</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">port</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-variable" style="color: #4c4f69;">port</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_port</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">&amp;.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-constant" style="color: #fe640b;">DEFAULT_PORTS</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">server_port</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_for</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">case</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:for</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map!</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
                <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
              <span class="ahl-keyword" style="color: #8839ef;">end</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">value</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_FOR</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">value</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
                <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
              <span class="ahl-keyword" style="color: #8839ef;">end</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_port</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">case</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">forwarded</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:for</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
                <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">2</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
              <span class="ahl-keyword" style="color: #8839ef;">end</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">compact</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">value</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_PORT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">value</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>&amp;<span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:to_i</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_authority</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">case</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">forwarded</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:host</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable" style="color: #4c4f69;">forwarded</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">value</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_HOST</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">value</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">ssl?</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-string" style="color: #40a02b;">&#x27;https&#x27;</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-string" style="color: #40a02b;">&#x27;wss&#x27;</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">ip</span>
        <span class="ahl-variable" style="color: #4c4f69;">remote_addresses</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;REMOTE_ADDR&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">external_addresses</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">remote_addresses</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">unless</span> <span class="ahl-variable" style="color: #4c4f69;">external_addresses</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">empty?</span>
          <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable" style="color: #4c4f69;">external_addresses</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">&amp;&amp;</span> <span class="ahl-operator" style="color: #04a5e5;">!</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">empty?</span>
          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The forwarded for addresses are ordered: client, proxy1, proxy2.</span>
          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># So we reject all the trusted addresses (proxy*) and return the</span>
          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># last client. Or if we trust everyone, we just return the first</span>
          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># address.</span>
          <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-variable" style="color: #4c4f69;">forwarded_for</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">first</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># If all the addresses are trusted, and we aren&#x27;t forwarded, just return</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># the first remote address, which represents the source of the request.</span>
        <span class="ahl-variable" style="color: #4c4f69;">remote_addresses</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">first</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The media type (type&#x2f;subtype) portion of the CONTENT_TYPE header</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># without any media type parameters. e.g., when CONTENT_TYPE is</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &quot;text&#x2f;plain;charset=utf-8&quot;, the media-type is &quot;text&#x2f;plain&quot;.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># For more information on the use of media types in HTTP, see:</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># http:&#x2f;&#x2f;www.w3.org&#x2f;Protocols&#x2f;rfc2616&#x2f;rfc2616-sec3.html#sec3.7</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">media_type</span>
        <span class="ahl-constructor" style="color: #209fb5;">MediaType</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">content_type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The media type parameters provided in CONTENT_TYPE as a Hash, or</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># an empty Hash if no CONTENT_TYPE or media-type parameters were</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># provided.  e.g., when the CONTENT_TYPE is &quot;text&#x2f;plain;charset=utf-8&quot;,</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># this method responds with the following Hash:</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#   { &#x27;charset&#x27; =&gt; &#x27;utf-8&#x27; }</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">media_type_params</span>
        <span class="ahl-constructor" style="color: #209fb5;">MediaType</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">content_type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The character set of the request body if a &quot;charset&quot; media type</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># parameter was given, or nil if no &quot;charset&quot; was specified. Note</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># that, per RFC2616, text&#x2f;* media types that specify no explicit</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># charset are to be considered ISO-8859-1.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">content_charset</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">media_type_params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string" style="color: #40a02b;">&#x27;charset&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Determine whether the request body contains form-data by checking</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># the request content-type for one of the media-types:</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &quot;application&#x2f;x-www-form-urlencoded&quot; or &quot;multipart&#x2f;form-data&quot;. The</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># list of form-data media types can be modified through the</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># +FORM_DATA_MEDIA_TYPES+ array.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># A request body is also assumed to contain form-data when no</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># content-type header is provided and the request_method is POST.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">form_data?</span>
        <span class="ahl-variable" style="color: #4c4f69;">type</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">media_type</span>
        <span class="ahl-variable" style="color: #4c4f69;">meth</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_METHODOVERRIDE_ORIGINAL_METHOD</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">REQUEST_METHOD</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">meth</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-constant" style="color: #fe640b;">POST</span> <span class="ahl-operator" style="color: #04a5e5;">&amp;&amp;</span> <span class="ahl-variable" style="color: #4c4f69;">type</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">nil?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-constant" style="color: #fe640b;">FORM_DATA_MEDIA_TYPES</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">include?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Determine whether the request body contains data by checking</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># the request media_type against registered parse-data media-types</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parseable_data?</span>
        <span class="ahl-constant" style="color: #fe640b;">PARSEABLE_DATA_MEDIA_TYPES</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">include?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">media_type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Returns the data received in the query string.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_QUERY_STRING</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">==</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_QUERY_HASH</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
          <span class="ahl-variable" style="color: #4c4f69;">query_hash</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_query</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string" style="color: #40a02b;">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_QUERY_STRING</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_QUERY_HASH</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">query_hash</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Returns the data received in the request body.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># This method support both application&#x2f;x-www-form-urlencoded and</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># multipart&#x2f;form-data.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">POST</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">error</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_ERROR</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-keyword ahl-control ahl-exception" style="color: #8839ef;">raise</span> <span class="ahl-variable" style="color: #4c4f69;">error</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">class</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">error</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">message</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">cause</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:</span> <span class="ahl-variable" style="color: #4c4f69;">error</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">cause</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-keyword" style="color: #8839ef;">begin</span>
          <span class="ahl-variable" style="color: #4c4f69;">rack_input</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># If the form hash was already memoized:</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">form_hash</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># And it was memoized from the same input:</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">equal?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">rack_input</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable" style="color: #4c4f69;">form_hash</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>

          <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Otherwise, figure out how to parse the input:</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">rack_input</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">nil?</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">elsif</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">form_data?</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parseable_data?</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">pairs</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constructor" style="color: #209fb5;">Rack</span>::<span class="ahl-constructor" style="color: #209fb5;">Multipart</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">parse_multipart</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">env</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-constructor" style="color: #209fb5;">Rack</span>::<span class="ahl-constructor" style="color: #209fb5;">Multipart</span>::<span class="ahl-constructor" style="color: #209fb5;">ParamList</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_PAIRS</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">pairs</span>
              <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">expand_param_pairs</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">pairs</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
              <span class="ahl-variable" style="color: #4c4f69;">form_vars</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">read</span>

              <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Fix for Safari Ajax postings that always append \0</span>
              <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># form_vars.sub!(&#x2f;\0\z&#x2f;, &#x27;&#x27;) # performance replacement:</span>
              <span class="ahl-variable" style="color: #4c4f69;">form_vars</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">slice!</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>-<span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">form_vars</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">end_with?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\0</span>&quot;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

              <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_VARS</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">form_vars</span>
              <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_query</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">form_vars</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string" style="color: #40a02b;">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>

            <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span> <span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_INPUT</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_INPUT</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_HASH</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">rescue</span> <span class="ahl-operator" style="color: #04a5e5;">=&gt;</span> <span class="ahl-variable" style="color: #4c4f69;">error</span>
          <span class="ahl-function ahl-method" style="color: #1e66f5;">set_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">RACK_REQUEST_FORM_ERROR</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">error</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-keyword ahl-control ahl-exception" style="color: #8839ef;">raise</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The union of GET and POST data.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">params</span>
        <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">merge</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">POST</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Destructively update a parameter, whether it&#x27;s in GET and&#x2f;or POST. Returns nil.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># The parameter is updated wherever it was previous defined, so GET, POST, or both. If it wasn&#x27;t previously defined, it&#x27;s inserted into GET.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &lt;tt&gt;env[&#x27;rack.input&#x27;]&lt;&#x2f;tt&gt; is not touched.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">update_param</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">found</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">false</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">has_key?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-variable" style="color: #4c4f69;">found</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">true</span>
          <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">POST</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">has_key?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-variable" style="color: #4c4f69;">found</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-builtin" style="color: #fe640b;">true</span>
          <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">POST</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">unless</span> <span class="ahl-variable" style="color: #4c4f69;">found</span>
          <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Destructively delete a parameter, whether it&#x27;s in GET or POST. Returns the value of the deleted parameter.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># If the parameter is in both GET and POST, the POST value takes precedence since that&#x27;s how #params works.</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># &lt;tt&gt;env[&#x27;rack.input&#x27;]&lt;&#x2f;tt&gt; is not touched.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">delete_param</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">post_value</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">get_value</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">POST</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">delete</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">GET</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">delete</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">post_value</span> <span class="ahl-operator" style="color: #04a5e5;">||</span> <span class="ahl-variable" style="color: #4c4f69;">get_value</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">base_url</span>
        <span class="ahl-string" style="color: #40a02b;">&quot;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-function ahl-method" style="color: #1e66f5;">scheme</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>:&#x2f;&#x2f;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-function ahl-method" style="color: #1e66f5;">host_with_port</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>&quot;</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Tries to return a remake of the original request URL as a string.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">url</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">base_url</span> <span class="ahl-operator" style="color: #04a5e5;">+</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">fullpath</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">path</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">script_name</span> <span class="ahl-operator" style="color: #04a5e5;">+</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">path_info</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">fullpath</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">empty?</span> <span class="ahl-operator" style="color: #04a5e5;">?</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">path</span> <span class="ahl-operator" style="color: #04a5e5;">:</span> <span class="ahl-string" style="color: #40a02b;">&quot;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-function ahl-method" style="color: #1e66f5;">path</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>?<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-function ahl-method" style="color: #1e66f5;">query_string</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>&quot;</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">accept_encoding</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;HTTP_ACCEPT_ENCODING&quot;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">accept_language</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;HTTP_ACCEPT_LANGUAGE&quot;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">trusted_proxy?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-constructor" style="color: #209fb5;">Rack</span>::<span class="ahl-constructor" style="color: #209fb5;">Request</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">ip_filter</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">call</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># shortcut for &lt;tt&gt;request.params[key]&lt;&#x2f;tt&gt;</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> []<span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">warn</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;Request#[] is deprecated and will be removed in a future version of Rack. Please use request.params[] instead&quot;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">uplevel</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-function ahl-method" style="color: #1e66f5;">params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># shortcut for &lt;tt&gt;request.params[key] = value&lt;&#x2f;tt&gt;</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;">#</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Note that modifications will not be persisted in the env. Use update_param or delete_param if you want to destructively modify params.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> []=<span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">value</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">warn</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&quot;Request#[]= is deprecated and will be removed in a future version of Rack. Please use request.params[]= instead&quot;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">uplevel</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

        <span class="ahl-function ahl-method" style="color: #1e66f5;">params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">value</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># like Hash#values_at</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">values_at</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">*<span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">keys</span></span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">keys</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">key</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-function ahl-builtin" style="color: #1e66f5;">private</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">default_session</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">;</span> <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Assist with compatibility when processing `X-Forwarded-For`.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">wrap_ipv6</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">host</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Even thought IPv6 addresses should be wrapped in square brackets,</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># sometimes this is not done in various legacy&#x2f;underspecified headers.</span>
        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># So we try to fix this situation for compatibility reasons.</span>

        <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Try to detect IPv6 addresses which aren&#x27;t escaped yet:</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-operator" style="color: #04a5e5;">!</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">host</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">start_with?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;[&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">&amp;&amp;</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">host</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">count</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string" style="color: #40a02b;">&#x27;:&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">&gt;</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1</span>
          <span class="ahl-string" style="color: #40a02b;">&quot;[<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">host</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>]&quot;</span>
        <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">else</span>
          <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">host</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_http_accept_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">header</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_s</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">split</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\s</span>*,<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\s</span>*&#x2f;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">map</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">part</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-variable" style="color: #4c4f69;">attribute</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">parameters</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">part</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">split</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\s</span>*;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\s</span>*&#x2f;</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">2</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
          <span class="ahl-variable" style="color: #4c4f69;">quality</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant ahl-numeric integer" style="color: #fe640b;">1.0</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">parameters</span> <span class="ahl-keyword ahl-operator" style="color: #8839ef;">and</span> <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>q=([<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>.]+)&#x2f;</span> <span class="ahl-operator" style="color: #04a5e5;">=~</span> <span class="ahl-variable" style="color: #4c4f69;">parameters</span>
            <span class="ahl-variable" style="color: #4c4f69;">quality</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> $1<span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_f</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable" style="color: #4c4f69;">attribute</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">quality</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># Get an array of values set in the RFC 7239 `Forwarded` request header.</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">token</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-constructor" style="color: #209fb5;">Utils</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_values</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constant" style="color: #fe640b;">HTTP_FORWARDED</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">&amp;.</span>[]<span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">token</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">query_parser</span>
        <span class="ahl-constructor" style="color: #209fb5;">Utils</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">default_query_parser</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_query</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">qs</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">d</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string" style="color: #40a02b;">&#x27;&amp;&#x27;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">query_parser</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">parse_nested_query</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">qs</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">d</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">parse_multipart</span>
        <span class="ahl-constructor" style="color: #209fb5;">Rack</span>::<span class="ahl-constructor" style="color: #209fb5;">Multipart</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">extract_multipart</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-builtin" style="color: #d20f39;">self</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">query_parser</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">expand_param_pairs</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">pairs</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">query_parser</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">query_parser</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable" style="color: #4c4f69;">params</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">query_parser</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">make_params</span>

        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">pairs</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">query_parser</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">normalize_params</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">params</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">k</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">v</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-variable" style="color: #4c4f69;">params</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_params_hash</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">value</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">value</span> <span class="ahl-operator" style="color: #04a5e5;">?</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">value</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">strip</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">split</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;[,<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\s</span>]+&#x2f;</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">:</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># ipv6 extracted from resolv stdlib, simplified</span>
      <span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># to remove numbered match group creation.</span>
      <span class="ahl-variable" style="color: #4c4f69;">ipv6</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constructor" style="color: #209fb5;">Regexp</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">union</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;(?:[0-9A-Fa-f]{1,4}:){7}
         [0-9A-Fa-f]{1,4}&#x2f;x</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
         (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?&#x2f;x</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;(?:[0-9A-Fa-f]{1,4}:){6,6}
         <span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
         (?:[0-9A-Fa-f]{1,4}:)*
         <span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\.</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;[Ff][Ee]80
         (?::[0-9A-Fa-f]{1,4}){7}
         %[-0-9A-Za-z._~]+&#x2f;x</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;[Ff][Ee]80:
         (?:
           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)? ::
           (?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?
           |
           :(?:[0-9A-Fa-f]{1,4}(?::[0-9A-Fa-f]{1,4})*)?
         )?
         :[0-9A-Fa-f]{1,4}%[-0-9A-Za-z._~]+&#x2f;x</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>

      <span class="ahl-constant" style="color: #fe640b;">AUTHORITY</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-string ahl-regexp" style="color: #fe640b;">&#x2f;
        <span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\A</span>
        (?&lt;host&gt;
          # Match IPv6 as a string of hex digits and colons in square brackets
          <span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\[</span>(?&lt;address&gt;<span class="ahl-punctuation ahl-special" style="color: #04a5e5;">#{</span><span class="ahl-variable" style="color: #4c4f69;">ipv6</span><span class="ahl-punctuation ahl-special" style="color: #04a5e5;">}</span>)<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\]</span>
          |
          # Match any other printable string (except square brackets) as a hostname
          (?&lt;address&gt;[[[:graph:]&amp;&amp;[^<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\[</span><span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\]</span>]]]*?)
        )
        (:(?&lt;port&gt;<span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\d</span>+))?
        <span class="ahl-constant ahl-character escape" style="color: #ea76cb;">\z</span>
      &#x2f;x</span>

      <span class="ahl-function ahl-method" style="color: #1e66f5;">private_constant</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:AUTHORITY</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">split_authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">nil?</span>
        <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span> <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">unless</span> <span class="ahl-variable" style="color: #4c4f69;">match</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant" style="color: #fe640b;">AUTHORITY</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-variable" style="color: #4c4f69;">match</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">authority</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable" style="color: #4c4f69;">match</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:host</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">match</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:address</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span> <span class="ahl-variable" style="color: #4c4f69;">match</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:port</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">&amp;.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">to_i</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">reject_trusted_ip_addresses</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip_addresses</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip_addresses</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">reject</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">trusted_proxy?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">ip</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-constant" style="color: #fe640b;">FORWARDED_SCHEME_HEADERS</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">{</span>
        <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">proto</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:</span> <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_PROTO</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">,</span>
        <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">scheme</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:</span> <span class="ahl-constant" style="color: #fe640b;">HTTP_X_FORWARDED_SCHEME</span>
      <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">}</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">freeze</span>
      <span class="ahl-function ahl-method" style="color: #1e66f5;">private_constant</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:FORWARDED_SCHEME_HEADERS</span>
      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_scheme</span>
        <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">case</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">type</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:forwarded</span>
            <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_proto</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">get_http_forwarded</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:proto</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span> <span class="ahl-operator" style="color: #04a5e5;">&amp;&amp;</span>
               <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">scheme</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">allowed_scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">forwarded_proto</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">last</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
              <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable" style="color: #4c4f69;">scheme</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">when</span> <span class="ahl-string ahl-special ahl-symbol" style="color: #1e66f5;">:x_forwarded</span>
            <span class="ahl-function ahl-method" style="color: #1e66f5;">x_forwarded_proto_priority</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">x_type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
              <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-variable" style="color: #4c4f69;">header</span> <span class="ahl-operator" style="color: #04a5e5;">=</span> <span class="ahl-constant" style="color: #fe640b;">FORWARDED_SCHEME_HEADERS</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">[</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">x_type</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">]</span>
                <span class="ahl-function ahl-method" style="color: #1e66f5;">split_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-function ahl-method" style="color: #1e66f5;">get_header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable" style="color: #4c4f69;">header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">reverse_each</span> <span class="ahl-keyword" style="color: #8839ef;">do</span> <span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">|</span>
                  <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">allowed_scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
                    <span class="ahl-keyword ahl-control ahl-return" style="color: #8839ef;">return</span> <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">scheme</span>
                  <span class="ahl-keyword" style="color: #8839ef;">end</span>
                <span class="ahl-keyword" style="color: #8839ef;">end</span>
              <span class="ahl-keyword" style="color: #8839ef;">end</span>
            <span class="ahl-keyword" style="color: #8839ef;">end</span>
          <span class="ahl-keyword" style="color: #8839ef;">end</span>
        <span class="ahl-keyword" style="color: #8839ef;">end</span>

        <span class="ahl-constant ahl-builtin" style="color: #fe640b;">nil</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">allowed_scheme</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
        <span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">header</span> <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">if</span> <span class="ahl-constant" style="color: #fe640b;">ALLOWED_SCHEMES</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">include?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-variable ahl-parameter" style="font-style: italic; color: #e64553;">header</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span>
        <span class="ahl-constructor" style="color: #209fb5;">Request</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">forwarded_priority</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>

      <span class="ahl-keyword ahl-function" style="color: #8839ef;">def</span> <span class="ahl-function ahl-method" style="color: #1e66f5;">x_forwarded_proto_priority</span>
        <span class="ahl-constructor" style="color: #209fb5;">Request</span><span class="ahl-punctuation ahl-delimiter" style="color: #7c7f93;">.</span><span class="ahl-function ahl-method" style="color: #1e66f5;">x_forwarded_proto_priority</span>
      <span class="ahl-keyword" style="color: #8839ef;">end</span>
    <span class="ahl-keyword" style="color: #8839ef;">end</span>

    <span class="ahl-function ahl-builtin" style="color: #1e66f5;">include</span> <span class="ahl-constructor" style="color: #209fb5;">Env</span>
    <span class="ahl-function ahl-builtin" style="color: #1e66f5;">include</span> <span class="ahl-constructor" style="color: #209fb5;">Helpers</span>
  <span class="ahl-keyword" style="color: #8839ef;">end</span>
<span class="ahl-keyword" style="color: #8839ef;">end</span>

<span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># :nocov:</span>
<span class="ahl-keyword ahl-control ahl-import" style="color: #8839ef;">require_relative</span> <span class="ahl-string" style="color: #40a02b;">&#x27;multipart&#x27;</span> <span class="ahl-keyword ahl-control ahl-conditional" style="font-style: italic; color: #8839ef;">unless</span> <span class="ahl-function ahl-builtin" style="color: #1e66f5;">defined?</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">(</span><span class="ahl-constructor" style="color: #209fb5;">Rack</span>::<span class="ahl-constructor" style="color: #209fb5;">Multipart</span><span class="ahl-punctuation ahl-bracket" style="color: #7c7f93;">)</span>
<span class="ahl-comment" style="font-style: italic; color: #8c8fa1;"># :nocov:</span>
</code></pre>
</body>
</html>
